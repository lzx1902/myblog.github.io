<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¦é—¨æ—…è¡ŒæŒ‡å— - æ¢ç´¢ã€å‘ç°ã€äº«å—</title>
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <style>
        :root {
            --primary: #FF6B00;
            --secondary: #0084FF;
            --accent: #FFB800;
            --bg-light: #FAFAFA;
            --text-dark: #333333;
            --text-light: #777777;
            --shadow: 0 10px 20px rgba(0,0,0,0.05);
            --radius: 16px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .logo {
            color: var(--primary);
            font-size: 1.8rem;
            margin-right: 10px;
        }
        
        h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-auto-rows: minmax(100px, auto);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .highlight {
            background: linear-gradient(135deg, rgba(255,107,0,0.1) 0%, rgba(255,184,0,0.1) 100%);
            border-left: 4px solid var(--primary);
        }
        
        .hero {
            grid-column: span 8;
            grid-row: span 3;
            background-image: url('image/xiamen/background.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            position: relative;
        }
        
        .hero::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70%;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
            z-index: 1;
        }
        
        .hero-content {
            position: relative;
            z-index: 2;
        }
        
        .hero h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .tag {
            display: inline-block;
            padding: 6px 12px;
            background-color: var(--primary);
            color: white;
            border-radius: 50px;
            font-size: 0.8rem;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .info {
            grid-column: span 4;
            grid-row: span 3;
        }
        
        .map-card {
            grid-column: span 6;
            grid-row: span 3;
            position: relative;
            overflow: hidden;
            padding: 0;
        }
        
        #map-container {
            width: 100%;
            height: 100%;
            min-height: 400px;
        }
        
        /* åœ°å›¾è¦†ç›–ç‰©æ ·å¼ */
        .map-overlay {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: var(--radius);
            padding: 15px;
            margin: 15px;
            width: calc(100% - 30px);
            position: absolute;
            bottom: 10px;
            left: 0;
            z-index: 10;
            box-shadow: var(--shadow);
        }
        
        .map-overlay h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: var(--primary);
        }
        
        .map-overlay p {
            margin: 0;
            line-height: 1.5;
        }
        
        .location-tag {
            display: inline-block;
            cursor: pointer;
            color: var(--primary);
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .location-tag:hover {
            color: var(--accent);
            text-decoration: underline;
        }
        
        /* ç§»é™¤åœ°å›¾åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        
        /* ä¿¡æ¯çª—å£æ ·å¼ */
        .info-window {
            padding: 10px;
            max-width: 250px;
        }
        
        .info-window h4 {
            margin: 0 0 8px 0;
            color: var(--primary);
            font-size: 16px;
        }
        
        .time-display {
            text-align: center;
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(255, 107, 0, 0.05);
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
        }
        
        .current-time {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .search-container {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 10;
            display: flex;
            width: calc(100% - 30px);
            max-width: 400px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: var(--radius) 0 0 var(--radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        .search-button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 0 var(--radius) var(--radius) 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .search-button:hover {
            background-color: #e05d00;
        }
        
        .search-options {
            position: absolute;
            top: 50px;
            left: 0;
            width: 100%;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 10px 0;
            display: none;
            z-index: 20;
        }
        
        .search-options.active {
            display: block;
        }
        
        .search-option {
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .search-option:hover {
            background-color: #f5f5f5;
        }
        
        .search-option i {
            margin-right: 8px;
            color: var(--primary);
        }
        
        .search-filter-btn {
            position: absolute;
            top: 10px;
            right: 60px;
            background-color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10;
            transition: background-color 0.3s;
        }
        
        .search-filter-btn:hover {
            background-color: #f5f5f5;
        }
        
        .search-filter-btn i {
            color: var(--primary);
            font-size: 18px;
        }
        
        .search-reset-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background-color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10;
            transition: all 0.3s;
        }
        
        .search-reset-btn:hover {
            background-color: #f5f5f5;
        }
        
        .search-reset-btn i {
            color: #ff4d4f;
            font-size: 18px;
        }
        
        .search-reset-btn.active {
            transform: rotate(180deg);
        }
        
        .itinerary {
            grid-column: span 6;
            grid-row: span 3;
        }
        
        .day-tab {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .tab-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab-item.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .day-content {
            display: none;
        }
        
        .day-content.active {
            display: block;
        }
        
        .icon-block {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .icon {
            color: var(--primary);
            font-size: 1.5rem;
            margin-right: 10px;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 107, 0, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .hotel-link {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
            transition: opacity 0.3s;
        }
        
        .hotel-link:hover {
            opacity: 0.8;
        }
        
        .tips {
            grid-column: span 4;
            grid-row: span 2;
        }
        
        .image-card {
            grid-column: span 4;
            grid-row: span 2;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .image-container {
            height: 70%;
            overflow: hidden;
        }
        
        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-content {
            padding: 15px;
            background-color: white;
            flex-grow: 1;
        }
        
        .footer-card {
            grid-column: span 12;
            text-align: center;
            padding: 15px;
            background-color: var(--primary);
            color: white;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }
        
        .timeline-item:before {
            content: '';
            position: absolute;
            left: -30px;
            top: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border: 2px solid white;
            box-shadow: 0 0 8px rgba(255, 107, 0, 0.4);
            z-index: 1;
            transform: scale(0.9);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .timeline-item:hover:before {
            transform: scale(1.1);
            box-shadow: 0 0 12px rgba(255, 107, 0, 0.6);
        }
        
        .timeline-item:after {
            content: '';
            position: absolute;
            left: -24px;
            top: 14px;
            width: 2px;
            height: calc(100% - 2px);
            background: linear-gradient(to bottom, var(--primary) 0%, rgba(255, 107, 0, 0.2) 100%);
            opacity: 0.7;
        }
        
        .timeline-item:last-child:after {
            display: none;
        }
        
        .timeline-time {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
            background: -webkit-linear-gradient(var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
            padding: 2px 0;
            position: relative;
        }
        
        h2 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            font-size: 1.4rem;
        }
        
        h2 i {
            margin-right: 10px;
            color: var(--primary);
        }
        
        .checklist {
            list-style: none;
        }
        
        .checklist li {
            padding: 8px 0;
            display: flex;
            align-items: flex-start;
        }
        
        .checklist i {
            color: var(--primary);
            margin-right: 10px;
            flex-shrink: 0;
            margin-top: 3px;
        }
        
        .weather-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .weather-day {
            text-align: center;
            flex: 1;
        }
        
        .weather-icon {
            font-size: 1.8rem;
            margin: 5px 0;
            color: var(--accent);
        }
        
        .temp {
            font-weight: 600;
        }
        
        @media (max-width: 1024px) {
            .bento-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .hero, .info, .map-card, .itinerary, .tips {
                grid-column: span 6;
            }
            
            .image-card {
                grid-column: span 3;
            }
            
            .footer-card {
                grid-column: span 6;
            }
        }
        
        @media (max-width: 768px) {
            .bento-grid {
                grid-template-columns: repeat(1, 1fr);
            }
            
            .hero, .info, .map-card, .itinerary, .tips, .image-card, .footer-card {
                grid-column: span 1;
            }
        }
        
        .api-notice {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #fff;
            border-radius: var(--radius);
            padding: 15px 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 800px;
            z-index: 1000;
            display: none;
        }
        
        .api-notice.active {
            display: block;
        }
        
        .api-notice h3 {
            margin: 0 0 10px 0;
            color: var(--primary);
            display: flex;
            align-items: center;
        }
        
        .api-notice h3 i {
            margin-right: 8px;
        }
        
        .api-notice p {
            margin: 8px 0;
            font-size: 14px;
        }
        
        .api-notice .code {
            background: #f5f5f5;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            margin: 8px 0;
            overflow-x: auto;
        }
        
        .api-notice .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #999;
            transition: color 0.3s;
        }
        
        .api-notice .close-btn:hover {
            color: var(--primary);
        }
        
        /* å¤©æ°”åŠ è½½çŠ¶æ€æ ·å¼ */
        .weather-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px;
        }
        
        .weather-loading i {
            color: var(--primary);
            animation: rotate 1s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* å¤©æ°”é”™è¯¯çŠ¶æ€æ ·å¼ */
        .weather-error {
            color: #ff4d4f;
            font-size: 12px;
            text-align: center;
            padding: 5px;
        }
        
        /* ç™¾åº¦å¤©æ°”iframeå®¹å™¨æ ·å¼ */
        .baidu-weather-wrapper {
            width: 100%;
            height: 160px; 
            overflow: hidden;
            border-radius: 10px;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        /* æœç´¢ç»“æœä¸‹æ‹‰åˆ—è¡¨æ ·å¼ */
        .search-results {
            position: absolute;
            top: 50px;
            left: 0;
            width: 100%;
            max-height: 350px;
            overflow-y: auto;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
            z-index: 30;
        }
        
        .search-results.active {
            display: block;
        }
        
        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .search-result-item:hover {
            background-color: #f9f9f9;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-name {
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 3px;
        }
        
        .search-result-address {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .search-result-distance {
            font-size: 12px;
            color: var(--secondary);
            margin-top: 3px;
        }
        
        /* ä½ç½®æç¤ºæ ·å¼ */
        .location-notice {
            animation: fadeInOut 3s ease-in-out;
            position: relative;
            z-index: 100;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            10% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        @media print {
            /* æ‰“å°æ—¶æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹ */
            .day-content {
                display: block !important;
                opacity: 1 !important;
                height: auto !important;
                overflow: visible !important;
            }
            
            /* æ·»åŠ åˆ†é¡µæ ‡è®° */
            .itinerary, .food-card, .tips, .souvenir-card {
                page-break-inside: avoid;
                margin-bottom: 20px;
            }
            
            /* éšè—ä¸éœ€è¦æ‰“å°çš„å…ƒç´  */
            .search-container, .search-filter-btn, .search-reset-btn, .map-overlay {
                display: none !important;
            }
            
            /* ç¡®ä¿åœ°å›¾åŒºåŸŸæœ‰åˆé€‚çš„é«˜åº¦ */
            .map-card {
                height: 400px;
                overflow: hidden;
            }
            
            /* è°ƒæ•´æ ‡ç­¾é¡µæ ·å¼ */
            .tab-item {
                border-bottom: none !important;
                font-weight: normal !important;
                color: var(--text-dark) !important;
            }
            
            .tab-item.active {
                font-weight: bold !important;
                color: var(--primary) !important;
            }
            
            /* ä¸ºæ¯ä¸ªæ ‡ç­¾é¡µå†…å®¹æ·»åŠ æ ‡é¢˜ */
            #day1::before, #day2::before, #day3::before,
            #food1::before, #food2::before, #food3::before {
                font-weight: bold;
                margin-bottom: 10px;
                display: block;
                border-bottom: 1px solid #eee;
                padding-bottom: 5px;
            }
            
            #day1::before { content: "ç¬¬ä¸€å¤©è¡Œç¨‹"; }
            #day2::before { content: "ç¬¬äºŒå¤©è¡Œç¨‹"; }
            #day3::before { content: "ç¬¬ä¸‰å¤©è¡Œç¨‹"; }
            #food1::before { content: "ç¬¬ä¸€å¤©ç¾é£Ÿ"; }
            #food2::before { content: "ç¬¬äºŒå¤©ç¾é£Ÿ"; }
            #food3::before { content: "ç¬¬ä¸‰å¤©ç¾é£Ÿ"; }
        }
    </style>
</head>
<body>
    <header>
        <i class='bx bxs-plane-take-off logo'></i>
        <h1>å¦é—¨æ—…è¡ŒæŒ‡å—</h1>
    </header>
    
    <div class="bento-grid">
        <!-- è‹±é›„å¡ç‰‡ -->
        <div class="card hero">
            <div class="hero-content">
                <span class="tag">3å¤©è¡Œç¨‹</span>
                <span class="tag">æµ·å²›é£æƒ…</span>
                <h2>å¦é—¨ Â· é¼“æµªå±¿ä¹‹æ—…</h2>
                <p>æ¢ç´¢ç¯å²›è·¯çš„æµ·å²¸é£å…‰ã€å¦é—¨å¤§å­¦çš„äººæ–‡æ™¯è‡´ä¸é¼“æµªå±¿çš„å¼‚å›½é£æƒ…</p>
            </div>
        </div>
        
        <!-- è¡Œç¨‹æ¦‚è§ˆä¿¡æ¯å¡ç‰‡ -->
        <div class="card info">
            <h2><i class='bx bxs-info-circle'></i> è¡Œç¨‹æ¦‚è§ˆ</h2>
            <div class="icon-block">
                <div class="icon"><i class='bx bxs-hotel'></i></div>
                <div>
                    <strong>ä½å®¿</strong>
                    <p class="hotel-link" id="hotel-location">å¦é—¨å›½é™…ä¼šå±•ä¸­å¿ƒç¯å²›è·¯ç¾å±…é…’åº—</p>
                    <small>è¿‘é»„åæ²™æ»©ï¼Œä¾¿äºé¦–æ—¥è¡Œç¨‹</small>
                </div>
            </div>
            <div class="icon-block">
                <div class="icon"><i class='bx bxs-car'></i></div>
                <div>
                    <strong>äº¤é€š</strong>
                    <p>ç½‘çº¦è½¦ + éª‘è¡Œ</p>
                    <small>æ‰“è½¦è´¹ç”¨æ—¥å‡çº¦50å…ƒ</small>
                </div>
            </div>
            <div class="icon-block">
                <div class="icon"><i class='bx bxs-receipt'></i></div>
                <div>
                    <strong>é—¨ç¥¨é¢„çº¦</strong>
                    <p>é¼“æµªå±¿èˆ¹ç¥¨ã€å¦é—¨å¤§å­¦</p>
                    <small class="highlight">éœ€æå‰é¢„çº¦ï¼</small>
                </div>
            </div>
            <div class="icon-block">
                <div class="icon"><i class='bx bxs-sun'></i></div>
                <div>
                    <strong>å¦é—¨å¤©æ°”</strong>
                    <p id="current-weather-text">åŠ è½½ä¸­...</p>
                </div>
            </div>
            <div class="weather-container" id="weather-container" style="margin-bottom: 15px;">
                <div class="weather-loading">
                    <i class='bx bx-loader'></i>
                </div>
            </div>
            <div class="time-display">
                <div class="current-time">å½“å‰æ—¶é—´</div>
            </div>
        </div>
        
        <!-- åœ°å›¾å¡ç‰‡ -->
        <div class="card map-card">
            <div id="map-container">
                <div id="map-loading" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; color: var(--primary); margin-bottom: 10px;">
                            <i class='bx bx-loader-alt bx-spin' style="font-size: 36px;"></i>
                        </div>
                        <div>åœ°å›¾åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...</div>
                    </div>
                </div>
            </div>
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="æœç´¢å¦é—¨çš„åœ°ç‚¹..." />
                <button id="search-button" class="search-button">
                    <i class='bx bx-search'></i>
                </button>
                <div class="search-options" id="search-options">
                    <div class="search-option" data-type="é¤é¥®"><i class='bx bx-restaurant'></i>é¤é¥®ç¾é£Ÿ</div>
                    <div class="search-option" data-type="é…’åº—"><i class='bx bx-hotel'></i>é…’åº—ä½å®¿</div>
                    <div class="search-option" data-type="è´­ç‰©"><i class='bx bx-shopping-bag'></i>è´­ç‰©</div>
                    <div class="search-option" data-type="æ™¯ç‚¹"><i class='bx bx-camera'></i>æ™¯ç‚¹</div>
                    <div class="search-option" data-type="äº¤é€š"><i class='bx bx-bus'></i>äº¤é€šè®¾æ–½</div>
                    <div class="search-option" data-type=""><i class='bx bx-x'></i>æ¸…é™¤ç­›é€‰</div>
                </div>
            </div>
            <button id="search-filter" class="search-filter-btn">
                <i class='bx bx-filter'></i>
            </button>
            <button id="search-reset" class="search-reset-btn">
                <i class='bx bx-x'></i>
            </button>
            <!-- ç§»é™¤åœ°å›¾åˆ‡æ¢æŒ‰é’® -->
            <div class="map-overlay">
                <h3>å¦é—¨çƒ­é—¨æ™¯ç‚¹</h3>
                <p>
                    <span class="location-tag" data-location="ç¯å²›è·¯">ç¯å²›è·¯</span> Â· 
                    <span class="location-tag" data-location="é»„åæµ·æ»©">é»„åæµ·æ»©</span> Â· 
                    <span class="location-tag" data-location="å¦é—¨å¤§å­¦">å¦é—¨å¤§å­¦</span> Â· 
                    <span class="location-tag" data-location="é¼“æµªå±¿">é¼“æµªå±¿</span> Â· 
                    <span class="location-tag" data-location="æ¤ç‰©å›­">æ¤ç‰©å›­</span>
                </p>
            </div>
        </div>
        
        <!-- è¡Œç¨‹å¡ç‰‡ -->
        <div class="card itinerary">
            <div class="day-tab">
                <div class="tab-item active" data-day="day1">ç¬¬ä¸€å¤©</div>
                <div class="tab-item" data-day="day2">ç¬¬äºŒå¤©</div>
                <div class="tab-item" data-day="day3">ç¬¬ä¸‰å¤©</div>
            </div>
            
            <div id="day1" class="day-content active">
                <h3>ç¯å²›è·¯ä¸é»„åæ—¥è½</h3>
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-time">ä¸Šåˆ 9:30-13:00</div>
                        <div class="timeline-content">
                            <strong>SMåŸå¸‚å¹¿åœº</strong>
                            <p>å¯„å­˜è¡Œæ + é¿æš‘é€›åƒ</p>
                            <p>æ¨èï¼š"çº¸çš„æ—¶ä»£"ä¹¦åº—ã€%Arabicaå’–å•¡ã€æŒ‰æ‘©æ”¾æ¾ã€å•†åœºè´­ç‰©</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">ä¸­åˆ 13:30</div>
                        <div class="timeline-content">
                            <strong>ç¾å±…é…’åº—</strong>
                            <p>æ”¾è¡Œæã€ä¼‘æ¯ç‰‡åˆ»ã€åŒ–å¦†ã€æ¶‚é˜²æ™’ã€å–·é©±èšŠæ°´</p>
                            <p>é«˜æ¡£å‹é…’åº—ä¸­æ€§ä»·æ¯”ä¹‹é€‰</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">ä¸‹åˆ 14:30-19:30</div>
                        <div class="timeline-content">
                            <strong>ç¯å²›è·¯æµ·è¾¹è¡Œç¨‹</strong>
                            <p>ä¸€å›½ä¿©åˆ¶æ²™æ»© â†’ æ¤°é£å¯¨ â†’ é»„åæ²™æ»© â†’ ç©æœˆå¡ â†’ æºªå¤´ä¸‹ â†’ éŸ³ä¹å¹¿åœº â†’ æ›¾ååµ</p>
                            <p>å‚æ™šæ¬£èµæ©˜è‰²æ—¥è½ç¾æ™¯</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="day2" class="day-content">
                <h3>æ¤ç‰©å›­æ£®ç³»å’Œå¦å¤§</h3>
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-time">ä¸Šåˆ 9:00-11:00</div>
                        <div class="timeline-content">
                            <strong>å¦é—¨æ¤ç‰©å›­</strong>
                            <p>è¥¿é—¨å…¥ï¼Œé‡ç‚¹é›¨æ—åŒº+å¤šè‚‰æ¤ç‰©åŒº</p>
                            <p>é›¨æ—å–·é›¾æ—¶é—´ï¼ˆ9:30-11:30ï¼‰ï¼Œå…‰å½±å¦‚æ¢¦ä¼¼å¹»</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">ä¸­åˆ 11:30-13:30</div>
                        <div class="timeline-content">
                            <strong>æ¤ç‰©å›­</strong>
                            <p>ç´ æ–‹é¦†æ¨è"æ™®ç…§æ¥¼"</p>
                            <p>æ‹›ç‰Œï¼šå—æµ·é‡‘è²ã€ç´ æ²™èŒ¶é¢ã€é¦…é¥¼</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">ä¸‹åˆ 14:00-17:00</div>
                        <div class="timeline-content">
                            <strong>å¦é—¨å¤§å­¦</strong>
                            <p>è·¯çº¿ï¼šèŠ™è“‰æ¹– â†’ èŠ™è“‰éš§é“ â†’ ä¸Šå¼¦åœº â†’ ç™½åŸæ²™æ»©</p>
                            <p>ä»ç™½åŸæ ¡é—¨ç›´é€šç™½åŸæ²™æ»©ï¼Œçœ‹åŒå­å¡”æ—¥è½</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="day3" class="day-content">
                <h3>é¼“æµªå±¿</h3>
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-time">ä¸Šåˆ 7:30-12:00</div>
                        <div class="timeline-content">
                            <strong>ä¸œæ¸¡å®¢è¿ç å¤´</strong>
                            <p>ä¹˜èˆ¹è‡³ä¸‰ä¸˜ç”°ç å¤´ï¼ˆ9:10ç­æ¬¡ï¼Œ7ç‚¹èµ·åºŠï¼‰</p>
                            <p>æœ€ç¾è½¬è§’ â†’ æ™´å¤©å¢™ â†’ é£ç´åšç‰©é¦† â†’ è½åº„èŠ±å›­</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">ä¸­åˆ 12:30-13:30</div>
                        <div class="timeline-content">
                            <strong>é¾™å¤´è·¯å°åƒ</strong>
                            <p>æ¨èï¼šå¶æ°éº»ç³ã€æ—æ°é±¼ä¸¸ã€æ²ˆå®¶é—½å—è‚ ç²‰</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">ä¸‹åˆ 14:00-15:30</div>
                        <div class="timeline-content">
                            <strong>è½åº„èŠ±å›­ä¸è¿”ç¨‹</strong>
                            <p>æ¼«æ¸¸èŠ±å›­ä¸é’¢ç´åšç‰©é¦†</p>
                            <p>æœ€æ™š16:00ç¦»å²›ï¼Œé¢„ç•™æ—¶é—´å‰å¾€å¦é—¨ç«™</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è´´å£«ã€ç¾é£Ÿå’Œè´­ç‰©å¡ç‰‡åœ¨åŒä¸€è¡Œ -->
        <!-- è´´å£«å¡ç‰‡ -->
        <div class="card tips" style="grid-column: span 4; grid-row: span 2;">
            <h2><i class='bx bxs-bookmark-star'></i> æ—…è¡Œè´´å£«</h2>
            <ul class="checklist">
                <li>
                    <i class='bx bx-check-circle'></i>
                    <div>
                        <strong>éšæ—¶æºå¸¦</strong>ï¼šèº«ä»½è¯ã€å……ç”µå®ã€é˜²æ™’éœœã€é®é˜³å¸½ã€å¢¨é•œã€é©±èšŠæ°´ã€é©±èšŠè¯è†ã€æ²™æ»©æ‹–é‹
                    </div>
                </li>
                <li>
                    <i class='bx bx-check-circle'></i>
                    <div>
                        <strong>é¼“æµªå±¿èˆ¹ç¥¨</strong>ï¼š"å±¿è§å¦é—¨"å°ç¨‹åºæŠ¢ç¥¨ï¼ˆé€‰"ä¸œæ¸¡å®¢è¿ç å¤´â†’ä¸‰ä¸˜ç”°ç å¤´"ï¼‰
                    </div>
                </li>
                <li>
                    <i class='bx bx-check-circle'></i>
                    <div>
                        <strong>å¦é—¨å¤§å­¦/é£ç´åšç‰©é¦†é¢„çº¦</strong>ï¼šæå‰3å¤©08:00é¢„çº¦ï¼ˆé£ç´åšç‰©é¦†å½“å¤©0ç‚¹é¢„çº¦ï¼‰
                    </div>
                </li>
                <li>
                    <i class='bx bx-check-circle'></i>
                    <div>
                        <strong>é˜²æ™’å‡†å¤‡</strong>ï¼šé˜²æ™’éœœSPF50+ã€é®é˜³å¸½ã€å¢¨é•œå¿…ä¸å¯å°‘
                    </div>
                </li>
                <li>
                    <i class='bx bx-check-circle'></i>
                    <div>
                        <strong>é˜²èšŠå‡†å¤‡</strong>ï¼šé©±èšŠæ°´ã€é©±èšŠè¯è†ã€èŠ±éœ²æ°´ã€é¿å…è “è™«å®å’¬
                    </div>
                </li>
                <li>
                    <i class='bx bx-check-circle'></i>
                    <div>
                        <strong>è¿”ç¨‹äº¤é€š</strong>ï¼šç¬¬ä¸‰å¤©ç¦»å²›é€‰ä¸‰ä¸˜ç”°ç å¤´ï¼Œæå‰2å°æ—¶ä»å²›ä¸Šæ’¤ç¦»å‰å¾€å¦é—¨ç«™
                    </div>
                </li>
            </ul>
        </div>
        
        <!-- ç¾é£Ÿå¡ç‰‡ -->
        <div class="card food-card" style="grid-column: span 4; grid-row: span 2;">
            <h2><i class='bx bxs-food-menu'></i> å¦é—¨ç¾é£ŸæŒ‡å—</h2>
            <div class="day-tab">
                <div class="tab-item active" data-food-day="food1">ç¬¬ä¸€å¤©</div>
                <div class="tab-item" data-food-day="food2">ç¬¬äºŒå¤©</div>
                <div class="tab-item" data-food-day="food3">ç¬¬ä¸‰å¤©</div>
            </div>
            
            <div id="food1" class="day-content active">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-time">æ—©é¤</div>
                        <div class="timeline-content">
                            <strong>å®¿èˆ</strong>
                            <p>ç®€é¤ï¼Œç•™è¶³æ—¶é—´èµ¶å¾€ç™½äº‘æœºåœº</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">åˆé¤</div>
                        <div class="timeline-content">
                            <strong>SMåŸå¸‚å¹¿åœº</strong>
                            <p>æ°¸æ°‘æ‰‹ä½œå¥¶èŒ¶ + è£å…ˆæ£®ç¦å»ºèœ</p>
                            <p>å¤‡é€‰ï¼šä¸‰æœŸæ±‰çƒŸç«Â·ç¦å»ºèåˆèœ/äºŒæœŸå®´é‡Â·ç¦å»ºèœ</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">æ™šé¤</div>
                        <div class="timeline-content">
                            <strong>æ›¾ååµ</strong>
                            <p>æµ·è›ç… + çƒ§çƒ¤ + ç‰¹è‰²å°åƒ</p>
                            <p>æ¨èï¼šå¤œå¸‚å°åƒä¸€æ¡è¡—ï¼ˆå“ç‰Œåº—ï¼‰</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="food2" class="day-content">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-time">æ—©é¤</div>
                        <div class="timeline-content">
                            <strong>é…’åº—</strong>
                            <p>è‡ªåŠ©æ—©é¤</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">åˆé¤</div>
                        <div class="timeline-content">
                            <strong>æ¤ç‰©å›­æ™®ç…§æ¥¼</strong>
                            <p>å—æ™®é™€å¯ºï¼šç´ é£Ÿå—æµ·é‡‘è² + ç´ æ²™èŒ¶é¢</p>
                            <p>å¤‡é€‰ï¼šæ¤ç‰©å›­æ—çš„å°å¨å¨˜é—½å—èœ</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">æ™šé¤</div>
                        <div class="timeline-content">
                            <strong>å¦å¤§ç™½åŸ/æ²™å¡å°¾</strong>
                            <p>è€å››æ²™èŒ¶é¢ + æ¾œé‡‘çƒ˜ç„™ç”œç‚¹ + æ²™èŒ¶è‚‰ä¸²</p>
                            <p>å¤‡é€‰ï¼šé¦™å®¢æ¥ç‰¹è‰²ç ‚é”…èœ</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="food3" class="day-content">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-time">æ—©é¤</div>
                        <div class="timeline-content">
                            <strong>é…’åº—</strong>
                            <p>ç®€é¤ï¼Œç•™è¶³æ—¶é—´èµ¶å¾€ç å¤´</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">åˆé¤</div>
                        <div class="timeline-content">
                            <strong>é¼“æµªå±¿é¾™å¤´è·¯</strong>
                            <p>å¶æ°éº»ç³ + æ—æ°é±¼ä¸¸ + é»„èƒœè®°è‚‰ç²½</p>
                            <p>å¤‡é€‰ï¼šé¾™å¤´è·¯å°åƒè¡—ï¼ˆå“ç‰Œåº—ï¼‰</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">æ™šé¤</div>
                        <div class="timeline-content">
                            <strong>è¿”ç¨‹å‰</strong>
                            <p>ä¸­å±±è·¯é™„è¿‘ç°‹è¡—æµ·é²œå¤§æ’æ¡£</p>
                            <p>å¤‡é€‰ï¼šå¦é—¨ç«™é™„è¿‘è¿é”å¿«é¤</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä¼´æ‰‹ç¤¼è´­ç‰©å¡ç‰‡ -->
        <div class="card souvenir-card" style="grid-column: span 4; grid-row: span 2;">
            <h2><i class='bx bxs-shopping-bag'></i> ä¼´æ‰‹ç¤¼è´­ç‰©æ¸…å•</h2>
            <ul class="checklist">
                <li>
                    <i class='bx bx-gift'></i>
                    <div>
                        <strong>ç‰¹è‰²é£Ÿå“</strong>
                        <p>ç´ é¦…é¥¼ï¼ˆå—æ™®é™€å¯ºï¼‰ã€é˜¿å‘†å§œæ¯é¸­ï¼ˆå…«å¸‚åº—ï¼‰ã€å‡¤æ¢¨é…¥ã€æ¤°å­é¥¼ã€ç‰›è½§ç³–ã€é»„èƒœè®°è‚‰ç²½ã€ç‰›è½§ç³–ï¼ˆé¼“æµªå±¿åº—ï¼‰ã€é“è§‚éŸ³èŒ¶å¶ï¼ˆå¦é—¨ç«™ï¼‰ã€ç»¿çš®ç«è½¦èŒ¶ç¤¼ï¼ˆæ²™å¡å°¾åº—ï¼‰</p>
                    </div>
                </li>
                <li>
                    <i class='bx bx-gift'></i>
                    <div>
                        <strong>çºªå¿µå“</strong>
                        <p>é¼“æµªå±¿é’¢ç´éŸ³ä¹ç›’ã€å¦é—¨å¤§å­¦æ–‡åˆ›ã€æµ·è¾¹è´å£³æ‰‹å·¥è‰ºå“ã€å†°ç®±è´´ã€æ‰‹ç»˜æ˜ä¿¡ç‰‡ç­‰</p>
                    </div>
                </li>
                <li>
                    <i class='bx bx-gift'></i>
                    <div>
                        <strong>è´­ç‰©åœ°ç‚¹</strong>
                        <p>é¼“æµªå±¿ï¼šé¾™å¤´è·¯ã€ä¸‰ä¸˜ç”°</p>
                        <p>å¸‚åŒºï¼šä¸­å±±è·¯å•†ä¸šè¡—ã€SMåŸå¸‚å¹¿åœºã€å—æ™®é™€å¯º</p>
                        <p>æµ·è¾¹ï¼šæ›¾ååµæ–‡åˆ›è¡—åŒºã€æ²™å¡å°¾è‰ºæœ¯è¥¿åŒº</p>
                    </div>
                </li>
            </ul>
        </div>
        
        <!-- ç¬¬ä¸€è¡Œå›¾ç‰‡å¡ç‰‡ - 3å¼  -->
        <div class="card image-card">
            <div class="image-container">
                <img src="image/xiamen/é¼“æµªå±¿.jpg" alt="é¼“æµªå±¿">
            </div>
            <div class="image-content">
                <h3>é¼“æµªå±¿</h3>
                <p>æ–‡è‰ºèŒƒçš„å°å²›ï¼Œæœ‰å„ç§ç‰¹è‰²å»ºç­‘å’Œç¾é£Ÿ</p>
                <p>æ¨èè·¯çº¿ï¼šä¸‰ä¸˜ç”°ç å¤´ç™»å²›â¡ï¸ç®¡é£ç´è‰ºæœ¯ä¸­å¿ƒâ¡ï¸æœ€ç¾è½¬è§’â¡ï¸æ™´å¤©å¢™â¡ï¸å…«å¦æ¥¼â¡ï¸é¾™å¤´è·¯å°åƒè¡—â¡ï¸è½åº„èŠ±å›­â¡ï¸æ¸¯ä»”åæ²™æ»©â¡ï¸é’¢ç´ç å¤´â¡ï¸ä¸‰ä¸˜ç”°ç å¤´ç¦»å²›</p>
            </div>
        </div>
        
        <div class="card image-card">
            <div class="image-container">
                <img src="image/xiamen/å¦é—¨å¤§å­¦.jpg" alt="å¦é—¨å¤§å­¦">
            </div>
            <div class="image-content">
                <h3>å¦é—¨å¤§å­¦</h3>
                <p>ä¸­å›½æœ€ç¾å¤§å­¦æ ¡å›­ä¹‹ä¸€ï¼Œä¾å±±å‚æµ·ï¼Œç¯å¢ƒä¼˜ç¾</p>
                <p>æ¨èè·¯çº¿ï¼šå¦å¤§è®¿å®¢ä¸­å¿ƒâ¡ï¸æ¼”æ­¦åœºâ¡ï¸é™ˆå˜‰åºšçºªå¿µåƒâ¡ï¸æ ¡å²é¦†â¡ï¸é¢‚æ©æ¥¼â¡ï¸èŠ™è“‰æ¹–â¡ï¸ä¸Šå¼¦åœºâ¡ï¸èŠ™è“‰éš§é“â¡ï¸èŠ™è“‰é¤å…</p>
            </div>
        </div>
        
        <div class="card image-card">
            <div class="image-container">
                <img src="image/xiamen/ç¯å²›è·¯.jpg" alt="ç¯å²›è·¯">
            </div>
            <div class="image-content">
                <h3>ç¯å²›è·¯</h3>
                <p>æ²¿ç€æµ·å²¸çº¿çš„ç»ç¾éª‘è¡Œé“ï¼Œé£æ™¯å¦‚ç”»ï¼Œé€‚åˆéª‘è¡Œã€æ•£æ­¥ã€æ‹ç…§</p>
                <p>æ¨èè·¯çº¿ï¼šä¸€å›½ä¿©åˆ¶æ²™æ»©â¡ï¸æ¤°é£å¯¨â¡ï¸é»„åæ²™æ»©â¡ï¸ç©æœˆå¡â¡ï¸æºªå¤´ä¸‹â¡ï¸éŸ³ä¹å¹¿åœºâ¡ï¸æ›¾ååµâ¡ï¸ç™½åŸæ²™æ»©â¡ï¸æ¼”æ­¦å¤§æ¡¥</p>
            </div>
        </div>
        
        <!-- ç¬¬äºŒè¡Œå›¾ç‰‡å¡ç‰‡ - 3å¼  -->
        <div class="card image-card">
            <div class="image-container">
                <img src="image/xiamen/æ²™å¡å°¾.jpg" alt="æ²™å¡å°¾">
            </div>
            <div class="image-content">
                <h3>æ²™å¡å°¾</h3>
                <p>æ²™å¡å°¾è‰ºæœ¯è¥¿åŒºï¼Œæœ‰ç‰¹è‰²å°åº—å’Œç¾é£Ÿè¡—ï¼Œé€‚åˆæ‹ç…§ã€è´­ç‰©ã€å“å°ç¾é£Ÿ</p>
                <p>æ¨èè·¯çº¿ï¼šå’–é£›ç‹®ï¼ˆç½‘çº¢å½©è™¹å¢™ï¼‰â¡ï¸æ²™å¡å°¾è‰ºæœ¯è¥¿åŒºé™¢å†…â¡ï¸å¦é—¨çš„æŸ¥æŸ¥æ–¯â¡ï¸TUUOâ¡ï¸LHTå¤ç€å±‹â¡ï¸æ·±å¤œé£Ÿå ‚â¡ï¸è¿”å›è‰ºæœ¯åŒºæ–¹å‘â¡ï¸èˆ’èŠ™è•¾çº¢è±†çƒ§â¡ï¸èŒ‰è‰å¥¶ç™½â¡ï¸è½¬è§’åˆä½œç¤¾â¡ï¸æ²™å¡å°¾çš„æŸ¥æŸ¥æ–¯â¡ï¸å¦é—¨æœå®—å®«ï¼ˆåŒå­å¡”æœ€ä½³æœºä½ï¼‰</p>
            </div>
        </div>
        
        <div class="card image-card">
            <div class="image-container">
                <img src="image/xiamen/å—æ™®é™€å¯º.jpg" alt="å—æ™®é™€å¯º">
            </div>
            <div class="image-content">
                <h3>å—æ™®é™€å¯º</h3>
                <p>å¦é—¨è‘—åä½›æ•™å¯ºåº™ï¼Œä¸å¦å¤§ç›¸é‚»ï¼Œå†å²æ‚ ä¹…ï¼Œåè½äºæµ·æ»¨å±±éº“ï¼Œä¾å±±é¢æµ·</p>
                <p>æ¨èè·¯çº¿ï¼šå—æ™®é™€å¯ºâ¡ï¸ç´ èœé¦†â¡ï¸ç¤¼å“åŒº</p>
            </div>
        </div>
        
        <!-- æ–°å¢ç¬¬6å¼ å›¾ç‰‡å¡ç‰‡ -->
        <div class="card image-card">
            <div class="image-container">
                <img src="image/xiamen/é»„åæ²™æ»©.jpg" alt="é»„åæ²™æ»©">
            </div>
            <div class="image-content">
                <h3>é»„åæ²™æ»©</h3>
                <p>å¦é—¨æœ€ç¾æ²™æ»©ï¼Œé€‚åˆçœ‹æ—¥å‡ºï¼Œé‡‘è‰²æ²™æ»©æ²»æ„ˆæ»¡åˆ†</p>
                <p>æ¨èè·¯çº¿ï¼šæ¤°é£å¯¨â¡ï¸é»„åæ²™æ»©â¡ï¸ç©æœˆå¡â¡ï¸æºªå¤´ä¸‹</p>
            </div>
        </div>
        
        <!-- é¡µè„šå¡ç‰‡ -->
        <div class="card footer-card">
            <p>å¼€å§‹ä½ çš„å¦é—¨ä¹‹æ—… ğŸ æ¢ç´¢ã€å‘ç°ã€äº«å—</p>
        </div>
    </div>
    
    <!-- APIå¯†é’¥æç¤ºæ¡† -->
    <div id="api-notice" class="api-notice">
        <button class="close-btn" onclick="document.getElementById('api-notice').classList.remove('active')">Ã—</button>
        <h3><i class='bx bx-info-circle'></i> APIå¯†é’¥é…ç½®é—®é¢˜</h3>
        <p>å½“å‰ä½¿ç”¨çš„é«˜å¾·åœ°å›¾APIå¯†é’¥é‡åˆ°äº†<strong>USERKEY_PLAT_NOMATCH</strong>é”™è¯¯ï¼Œè¿™è¡¨ç¤ºAPIå¯†é’¥ä¸å½“å‰å¹³å°ä¸åŒ¹é…ã€‚</p>
        <p>è¦è§£å†³æ­¤é—®é¢˜ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œ:</p>
        <ol>
            <li>ç™»å½•<a href="https://lbs.amap.com/dev/key/app" target="_blank">é«˜å¾·å¼€æ”¾å¹³å°æ§åˆ¶å°</a></li>
            <li>æ‰¾åˆ°æ‚¨çš„åº”ç”¨å’Œå¯¹åº”çš„å¯†é’¥</li>
            <li>ç¡®ä¿å¯†é’¥å·²å¯ç”¨<strong>JavaScript API</strong>æƒé™</li>
            <li>æ£€æŸ¥<strong>åŸŸåç™½åå•</strong>æ˜¯å¦åŒ…å«å½“å‰ç½‘ç«™åŸŸå</li>
            <li>å¦‚æœæ˜¯æœ¬åœ°å¼€å‘ï¼Œæ·»åŠ ä»¥ä¸‹åŸŸååˆ°ç™½åå•: <span class="code">localhost</span>, <span class="code">127.0.0.1</span>, <span class="code">file://</span></li>
        </ol>
        <p>ä¿®æ”¹å®Œæˆåï¼Œå¯èƒ½éœ€è¦ç­‰å¾…å‡ åˆ†é’Ÿæ‰èƒ½ç”Ÿæ•ˆã€‚</p>
    </div>
    
    <!-- å¤©æ°”APIæç¤ºæ¡† -->
    <div id="weather-api-notice" class="api-notice">
        <button class="close-btn" onclick="document.getElementById('weather-api-notice').classList.remove('active')">Ã—</button>
        <h3><i class='bx bx-info-circle'></i> é«˜å¾·å¤©æ°”APIè¯·æ±‚é—®é¢˜</h3>
        <p>é«˜å¾·å¤©æ°”APIè¯·æ±‚å¤±è´¥ï¼Œå¯èƒ½æœ‰ä»¥ä¸‹åŸå› ï¼š</p>
        <ol>
            <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
            <li>APIå¯†é’¥æƒé™ä¸è¶³æˆ–é…ç½®é—®é¢˜</li>
            <li>APIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨æˆ–è¯·æ±‚è¶…æ—¶</li>
        </ol>
        <p>è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°(F12)æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚</p>
        <p>å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯æœ¬åœ°æ–‡ä»¶(file://åè®®)æ‰“å¼€é¡µé¢ï¼Œè¯·ç¡®ä¿åœ¨é«˜å¾·å¼€æ”¾å¹³å°æ§åˆ¶å°ä¸­çš„åº”ç”¨æ·»åŠ äº†ä»¥ä¸‹åŸŸåç™½åå•ï¼š</p>
        <div class="code">file://</div>
        <p>è§£å†³æ–¹æ¡ˆï¼š</p>
        <ol>
            <li>ç™»å½•<a href="https://lbs.amap.com/dev/key/app" target="_blank">é«˜å¾·å¼€æ”¾å¹³å°æ§åˆ¶å°</a></li>
            <li>æ‰¾åˆ°æ‚¨çš„åº”ç”¨ï¼Œç‚¹å‡»"ç¼–è¾‘"</li>
            <li>åœ¨"åŸŸåç™½åå•"ä¸­æ·»åŠ "file://"</li>
            <li>ä¿å­˜æ›´æ”¹å¹¶ç­‰å¾…ç”Ÿæ•ˆ(é€šå¸¸éœ€è¦å‡ åˆ†é’Ÿ)</li>
        </ol>
        <p>å½“å‰ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°ç¦»çº¿æ¨¡å¼ï¼Œæ˜¾ç¤ºé¢„è®¾çš„å¤©æ°”æ•°æ®ã€‚</p>
    </div>
    
    <script>
        const keyManager = (function() {
            const keyParts = [
                '8163', 'ea46', 'aa68', 'a8fb', 'bdde', '9d92', '4236', '290b'
            ];
            
            function checkSecurity() {
                const allowedDomains = ['localhost', '127.0.0.1', 'lzx1902.github.io', window.location.hostname];
                let isAllowed = false;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å…è®¸çš„åŸŸå
                for (let domain of allowedDomains) {
                    if (window.location.hostname === domain || window.location.hostname.includes(domain)) {
                        console.log('åŸŸåéªŒè¯é€šè¿‡:', window.location.hostname);
                        isAllowed = true;
                        break;
                    }
                }
                
                // å¦‚æœæ˜¯GitHub Pagesç¯å¢ƒï¼Œç‰¹åˆ«å…è®¸
                const isGitHubPages = window.location.hostname.includes('github.io');
                return isAllowed || window.location.protocol === 'file:' || isGitHubPages;
            }
            
            return {
                getMapKey: function() {
                    if (checkSecurity()) {
                        return keyParts.join('');
                    }
                    return 'invalid_key_for_security_reasons';
                }
            };
        })();
        
        // è¡Œç¨‹æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
        document.querySelectorAll('.tab-item[data-day]').forEach(function(tab) {
            tab.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
                document.querySelectorAll('.tab-item[data-day]').forEach(function(t) {
                    t.classList.remove('active');
                });
                // æ·»åŠ å½“å‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
                this.classList.add('active');
                
                // è·å–å½“å‰é€‰ä¸­çš„æ—¥æœŸID
                const dayId = this.getAttribute('data-day');
                
                // éšè—æ‰€æœ‰æ—¥æœŸå†…å®¹
                document.querySelectorAll('.itinerary .day-content').forEach(function(content) {
                    content.classList.remove('active');
                });
                
                // æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„æ—¥æœŸå†…å®¹
                document.getElementById(dayId).classList.add('active');
            });
        });
        
        // ç¾é£Ÿæ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
        document.querySelectorAll('.tab-item[data-food-day]').forEach(function(tab) {
            tab.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
                document.querySelectorAll('.tab-item[data-food-day]').forEach(function(t) {
                    t.classList.remove('active');
                });
                // æ·»åŠ å½“å‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
                this.classList.add('active');
                
                // è·å–å½“å‰é€‰ä¸­çš„æ—¥æœŸID
                const foodDayId = this.getAttribute('data-food-day');
                
                // éšè—æ‰€æœ‰æ—¥æœŸå†…å®¹
                document.querySelectorAll('.food-card .day-content').forEach(function(content) {
                    content.classList.remove('active');
                });
                
                // æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„æ—¥æœŸå†…å®¹
                document.getElementById(foodDayId).classList.add('active');
            });
        });
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            // åŠ è½½é«˜å¾·åœ°å›¾API
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://webapi.amap.com/maps?v=2.0&key=' + keyManager.getMapKey() + '&plugin=AMap.ToolBar,AMap.Scale,AMap.HawkEye,AMap.MapType,AMap.Geolocation';
            script.onload = function() {
                // ç¡®ä¿AMapå¯¹è±¡å¯ç”¨
                window.AMap = AMap;
                
                // åˆ›å»ºåœ°å›¾å®ä¾‹
                window.map = new AMap.Map('map-container', {
                    resizeEnable: true,
                    zoom: 12,
                    center: [118.1022, 24.4452] // å¦é—¨å¸‚ä¸­å¿ƒ
                });
                
                // ç¡®ä¿åœ°å›¾å®Œå…¨åŠ è½½åå†åˆå§‹åŒ–æ ‡è®°å’Œäº‹ä»¶
                window.map.on('complete', function() {
                    console.log('åœ°å›¾åŠ è½½å®Œæˆ');
                    window.mapReady = true;
                    
                    // éšè—åŠ è½½æç¤º
                    document.getElementById('map-loading').style.display = 'none';
                    
                    // æ‰“å°æ‰€æœ‰æ ‡è®°ï¼Œç¡®è®¤å®ƒä»¬å·²è¢«æ­£ç¡®åˆ›å»º
                    console.log('åœ°å›¾åŠ è½½å®Œæˆåçš„æ ‡è®°:', Object.keys(window.markers));
                    
                    // ä¸ºç¯å²›è·¯æ ‡è®°æ·»åŠ é¢å¤–çš„æ ‡è¯†ï¼Œä¾¿äºè°ƒè¯•
                    if (window.markers['ç¯å²›è·¯']) {
                        console.log('ç¯å²›è·¯æ ‡è®°å·²åˆ›å»º:', window.markers['ç¯å²›è·¯']);
                        
                        // ç¡®ä¿ç¯å²›è·¯æ ‡è®°å¯è§
                        window.markers['ç¯å²›è·¯'].marker.setMap(window.map);
                        
                        // ä½¿ç¯å²›è·¯æ ‡è®°æ›´å¤§æ›´æ˜¾çœ¼ï¼Œä¾¿äºè°ƒè¯•
                        var markerHeight = 80;
                        var markerWidth = 36; // æ›´çª„çš„æ ‡è®°
                        var fontSize = 16;
                        
                        // åˆ›å»ºå‚ç›´æ–‡æœ¬
                        var verticalText = '';
                        for (var i = 0; i < 'ç¯å²›è·¯'.length; i++) {
                            verticalText += 'ç¯å²›è·¯'[i] + (i < 'ç¯å²›è·¯'.length - 1 ? '<br>' : '');
                        }
                        
                        // æ›´æ–°ç¯å²›è·¯æ ‡è®°çš„å†…å®¹
                        window.markers['ç¯å²›è·¯'].marker.setContent(`<div style="background-color:#FFB800; color:white; width:${markerWidth}px; height:${markerHeight}px; 
                            border-radius:18px; text-align:center; display:flex; align-items:center; justify-content:center; 
                            font-weight:bold; font-size:${fontSize}px; box-shadow:0 2px 6px rgba(0,0,0,0.3); padding:5px 0;">
                            ${verticalText}
                        </div>`);
                        
                        // æ›´æ–°åç§»
                        window.markers['ç¯å²›è·¯'].marker.setOffset(new AMap.Pixel(-markerWidth/2, -markerHeight/2));
                    } else {
                        console.warn('ç¯å²›è·¯æ ‡è®°æœªåˆ›å»º!');
                        
                        // å¦‚æœç¯å²›è·¯æ ‡è®°æœªåˆ›å»ºï¼Œæ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª
                        console.log('å°è¯•æ‰‹åŠ¨åˆ›å»ºç¯å²›è·¯æ ‡è®°');
                        // ä½¿ç”¨å»¶è¿Ÿåˆ›å»ºï¼Œç¡®ä¿åœ°å›¾å·²å®Œå…¨åŠ è½½
                        setTimeout(function() {
                            addMarker('ç¯å²›è·¯', 118.1257, 24.4348, 'ç¯æµ·é£æ™¯é“ï¼Œå…¨é•¿çº¦43å…¬é‡Œ');
                        }, 500);
                    }
                });
                
                // æ·»åŠ åœ°å›¾æ§ä»¶
                map.addControl(new AMap.ToolBar({
                    position: 'LB'
                }));
                map.addControl(new AMap.Scale({
                    position: 'LB',
                    offset: new AMap.Pixel(10, 50)
                }));
                
                // æ·»åŠ åœ°å›¾ç±»å‹åˆ‡æ¢æ§ä»¶
                map.addControl(new AMap.MapType({
                    defaultType: 0,
                    position: 'RB'
                }));
                
                // æ·»åŠ å®šä½æ§ä»¶
                map.addControl(new AMap.Geolocation({
                    buttonPosition: 'RB',
                    buttonOffset: new AMap.Pixel(10, 20),
                    showMarker: true,
                    showCircle: true
                }));
                
                // é¢„è®¾æ™¯ç‚¹æ ‡è®°
                window.markers = {};
                // æœç´¢ç»“æœæ ‡è®°
                window.searchMarkers = [];
                
                // æ·»åŠ æ™¯ç‚¹æ ‡è®°
                addMarker('é¼“æµªå±¿', 118.063467,24.444968, 'å¦é—¨è‘—åæ™¯ç‚¹ï¼Œæœ‰"é’¢ç´ä¹‹å²›"ã€"ä¸‡å›½å»ºç­‘åšè§ˆ"ä¹‹ç§°');
                addMarker('å¦é—¨å¤§å­¦', 118.102483,24.438133, 'ä¸­å›½æœ€ç¾å¤§å­¦ä¹‹ä¸€ï¼Œä¾å±±å‚æµ·ï¼Œé£æ™¯å¦‚ç”»');
                addMarker('å—æ™®é™€å¯º', 118.100007,24.439637, 'é—½å—ä½›æ•™èƒœåœ°ï¼Œå§‹å»ºäºå”ä»£');
                addMarker('ç¯å²›è·¯', 118.10086,24.430721, 'ç¯æµ·é£æ™¯é“ï¼Œå…¨é•¿çº¦43å…¬é‡Œ');
                addMarker('é»„åæµ·æ»©', 118.165343,24.446982, 'å¦é—¨æœ€ç¾æ²™æ»©ï¼Œé€‚åˆçœ‹æ—¥å‡ºï¼Œé‡‘è‰²æ²™æ»©æ²»æ„ˆæ»¡åˆ†');
                addMarker('æ›¾ååµ', 118.128615,24.422618, 'æ–‡è‰ºå°æ‘ï¼Œæœ‰ç‰¹è‰²å°åº—å’Œç¾é£Ÿè¡—');
                addMarker('æ²™å¡å°¾', 118.090006,24.442901, 'æ–‡è‰ºè‰ºæœ¯åŒºï¼ŒåŸæ¸”æ¸¯æ”¹å»º');
                addMarker('æ¤ç‰©å›­', 118.111746,24.446333, 'å¦é—¨æ¤ç‰©å›­ï¼Œæ‹¥æœ‰ä¸°å¯Œçš„æ¤ç‰©èµ„æºå’Œä¼˜ç¾çš„è‡ªç„¶æ™¯è§‚');
                
                // æ·»åŠ é…’åº—ä½ç½®æ ‡è®°
                addMarker('ç¾å±…é…’åº—', 118.181045,24.486699, 'å¦é—¨å›½é™…ä¼šå±•ä¸­å¿ƒç¯å²›è·¯ç¾å±…é…’åº—', 'hotel');
                
                // æ·»åŠ æ ‡è®°å‡½æ•°
                function addMarker(name, lng, lat, info, type = 'attraction') {
                    // å®šä¹‰è‡ªå®šä¹‰å›¾æ ‡é¢œè‰²ï¼Œä¸ç½‘ç«™ä¸»é¢˜è‰²åŒ¹é…
                    var iconColor;
                    var iconScale = 1.0;
                    
                    if (type === 'hotel') {
                        // é…’åº—ä½¿ç”¨è“è‰²
                        iconColor = '#0084FF'; // --secondary
                        iconScale = 1.1;
                    } else if (name.includes('é¼“æµªå±¿') || name.includes('å¦é—¨å¤§å­¦') || name.includes('å—æ™®é™€')) {
                        // ä¸»è¦æ™¯ç‚¹ä½¿ç”¨ä¸»é¢˜æ©™è‰²
                        iconColor = '#FF6B00'; // --primary
                        iconScale = 1.1;
                    } else if (name.includes('æ²™å¡å°¾') || name.includes('æ›¾ååµ')) {
                        // æ–‡è‰ºåŒºåŸŸä½¿ç”¨ç´«è‰²
                        iconColor = '#9C27B0';
                    } else if (name.includes('ç¯å²›è·¯') || name.includes('é»„å')) {
                        // æµ·æ»©åŒºåŸŸä½¿ç”¨é»„è‰²
                        iconColor = '#FFB800'; // --accent
                    } else {
                        // å…¶ä»–æ™¯ç‚¹ä½¿ç”¨æ©™çº¢è‰²
                        iconColor = '#FF4500';
                    }
                    
                    // åˆ›å»ºè‡ªå®šä¹‰SVGå›¾æ ‡
                    var svgMarker = {
                        path: 'M20,0C8.96,0,0,8.96,0,20c0,17.73,20,44,20,44s20-26.27,20-44C40,8.96,31.04,0,20,0z M20,27c-3.87,0-7-3.13-7-7s3.13-7,7-7,7,3.13,7,7S23.87,27,20,27z',
                        fillColor: iconColor,
                        fillOpacity: 1,
                        scale: iconScale,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 2,
                        anchor: new AMap.Pixel(20, 40)
                    };
                    
                    // åˆ›å»ºæ ‡è®° - ä½¿ç”¨å›¾ç‰‡ä¸­æ ·å¼çš„å‚ç›´åœ†è§’çŸ©å½¢æ ‡è®°
                    var markerHeight = type === 'hotel' ? 100 : 70; // é…’åº—æ ‡è®°æ›´é«˜ä¸€äº›
                    var markerWidth = 36; // æ›´çª„çš„æ ‡è®°
                    var fontSize = type === 'hotel' ? 18 : 14;
                    
                    // åˆ›å»ºå‚ç›´æ–‡æœ¬æ ‡è®°
                    var verticalText = '';
                    for (var i = 0; i < name.length; i++) {
                        verticalText += name[i] + (i < name.length - 1 ? '<br>' : '');
                    }
                    
                    // åˆ›å»ºæ ‡è®°
                    var marker = new AMap.Marker({
                        position: new AMap.LngLat(lng, lat),
                        title: name,
                        map: map,
                        content: `<div style="background-color:${iconColor}; color:white; width:${markerWidth}px; height:${markerHeight}px; 
                            border-radius:18px; text-align:center; display:flex; align-items:center; justify-content:center; 
                            font-weight:bold; font-size:${fontSize}px; box-shadow:0 2px 6px rgba(0,0,0,0.3); padding:5px 0;">
                            ${verticalText}
                        </div>`,
                        offset: new AMap.Pixel(-markerWidth/2, -markerHeight/2) // è°ƒæ•´åç§»ä»¥ä¿æŒæ ‡è®°ä½ç½®å‡†ç¡®
                    });
                    
                    // ä¸å†éœ€è¦é¢å¤–çš„æ–‡æœ¬æ ‡ç­¾ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»å°†æ–‡æœ¬é›†æˆåˆ°æ ‡è®°ä¸­äº†
                    var text = null;
                    
                    // åˆ›å»ºä¿¡æ¯çª—ä½“
                    var infoWindow = new AMap.InfoWindow({
                        content: `<div style="padding:12px; border-radius:8px;">
                            <h4 style="margin:0 0 8px 0; color:#FF6B00; font-size:16px;">${name}</h4>
                            <p style="margin:0; line-height:1.5; color:#333;">${info}</p>
                        </div>`,
                        offset: new AMap.Pixel(0, -30),
                        isCustom: true,
                        autoMove: true
                    });
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    marker.on('click', function() {
                        // å…³é—­ä¹‹å‰çš„ä¿¡æ¯çª—ä½“
                        if (window.currentInfoWindow) {
                            window.currentInfoWindow.close();
                        }
                        
                        infoWindow.open(map, marker.getPosition());
                        window.currentInfoWindow = infoWindow;
                        
                        // å¦‚æœæ˜¯é…’åº—ï¼Œè®¾ç½®ç¼©æ”¾çº§åˆ«æ›´é«˜
                        if (type === 'hotel') {
                            map.setZoomAndCenter(15, marker.getPosition());
                        } else {
                            map.setZoomAndCenter(14, marker.getPosition());
                        }
                    });
                    
                    // ä¿å­˜æ ‡è®°å¼•ç”¨
                    window.markers[name] = {
                        marker: marker,
                        infoWindow: infoWindow,
                        type: type
                    };
                    
                    // å¦‚æœæœ‰æ–‡æœ¬æ ‡ç­¾ï¼Œä¿å­˜å¼•ç”¨
                    if (text) {
                        window.markers[name].text = text;
                    }
                }
                
                // æ·»åŠ çƒ­é—¨æ™¯ç‚¹æ ‡ç­¾ç‚¹å‡»äº‹ä»¶
                document.querySelectorAll('.location-tag').forEach(function(tag) {
                    tag.addEventListener('click', function() {
                        // æ£€æŸ¥åœ°å›¾å’ŒAMapå¯¹è±¡æ˜¯å¦å·²åŠ è½½
                        if (!window.map || !window.AMap || !window.mapReady) {
                            console.warn('åœ°å›¾å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•');
                            return;
                        }
                        
                        // å¦‚æœå½“å‰æ˜¯è·¯çº¿å›¾æ¨¡å¼ï¼Œå…ˆåˆ‡æ¢åˆ°æ™®é€šåœ°å›¾æ¨¡å¼
                        if (window.currentMapMode === 'route') {
                            switchMapMode('normal');
                        }
                        
                        var location = this.getAttribute('data-location');
                        var found = false;
                        
                        // æ‰“å°æ‰€æœ‰å¯ç”¨çš„æ ‡è®°ï¼Œç”¨äºè°ƒè¯•
                        console.log('å¯ç”¨çš„æ ‡è®°:', Object.keys(window.markers));
                        console.log('æ­£åœ¨æŸ¥æ‰¾æ ‡è®°:', location);
                        
                        // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿åœ°å›¾æ ‡è®°å·²ç»åŠ è½½
                        setTimeout(function() {
                            // å†æ¬¡æ£€æŸ¥åœ°å›¾å’Œæ ‡è®°æ˜¯å¦å·²åŠ è½½
                            if (!window.map || !window.markers || !window.AMap || !window.mapReady) {
                                console.warn('åœ°å›¾æˆ–æ ‡è®°å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•');
                                return;
                            }
                            
                            for (var name in window.markers) {
                                // ä½¿ç”¨æ›´å®½æ¾çš„åŒ¹é…æ–¹å¼ï¼Œè½¬æ¢ä¸ºå°å†™å¹¶å»é™¤ç©ºæ ¼è¿›è¡Œæ¯”è¾ƒ
                                const normalizedName = name.toLowerCase().replace(/\s+/g, '');
                                const normalizedLocation = location.toLowerCase().replace(/\s+/g, '');
                                
                                // æ‰“å°æ¯æ¬¡æ¯”è¾ƒçš„ç»“æœï¼Œç”¨äºè°ƒè¯•
                                console.log(`æ¯”è¾ƒ: "${normalizedName}" vs "${normalizedLocation}"`);
                                
                                // ç‰¹æ®Šæƒ…å†µå¤„ç†
                                if (location === 'ç¯å²›è·¯' && name === 'ç¯å²›è·¯') {
                                    console.log('æ‰¾åˆ°ç¯å²›è·¯ç²¾ç¡®åŒ¹é…!');
                                    try {
                                        // ä½¿ç”¨é€šç”¨çš„å®šä½å‡½æ•°
                                        if (focusOnMarker('ç¯å²›è·¯')) {
                                        } else {
                                            // å¦‚æœæ ‡è®°ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç¡¬ç¼–ç åæ ‡
                                            console.log('ç¯å²›è·¯æ ‡è®°ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç¡¬ç¼–ç åæ ‡');
                                            const pos = new AMap.LngLat(118.1257, 24.4348);
                                            
                                            // å…ˆè®¾ç½®ä¸­å¿ƒç‚¹
                                            window.map.setCenter(pos);
                                            
                                            // ä½¿ç”¨åŠ¨ç”»æ•ˆæœå¹³æ»‘ç¼©æ”¾ï¼Œå¹¶è€ƒè™‘åœ°å›¾å®¹å™¨é«˜åº¦çš„ä¸€åŠä½œä¸ºå‚ç›´åç§»
                                            const mapContainer = document.getElementById('map-container');
                                            const verticalOffset = mapContainer.clientHeight / 4;
                                            
                                            // è®¾ç½®ç¼©æ”¾çº§åˆ«å’Œåç§»
                                            window.map.setZoomAndCenter(14, pos, false);
                                            window.map.panBy(0, -verticalOffset);
                                        }
                                        
                                        found = true;
                                        break;
                                    } catch (e) {
                                        console.error('ç¯å²›è·¯å®šä½å¤±è´¥:', e);
                                    }
                                }
                                
                                if (normalizedName.includes(normalizedLocation) || normalizedLocation.includes(normalizedName)) {
                                    console.log('æ‰¾åˆ°åŒ¹é…æ™¯ç‚¹:', name, 'å¯¹åº”æŸ¥è¯¢:', location);
                                    try {
                                        // ä½¿ç”¨é€šç”¨çš„å®šä½å‡½æ•°
                                        if (focusOnMarker(name)) {
                                            found = true;
                                        }
                                        break;
                                    } catch (e) {
                                        console.error('è§¦å‘æ ‡è®°ç‚¹å‡»äº‹ä»¶å¤±è´¥:', e);
                                    }
                                }
                            }
                            
                            if (!found) {
                                console.log('æœªæ‰¾åˆ°åŒ¹é…çš„æ™¯ç‚¹:', location);
                                
                                // ç‰¹æ®Šæƒ…å†µå¤„ç† - å¦‚æœæ˜¯ç¯å²›è·¯ï¼Œç›´æ¥ä½¿ç”¨åæ ‡
                                // æ³¨ï¼šç¯å²›è·¯å·²ç»åœ¨ä¸Šé¢å¤„ç†è¿‡ï¼Œè¿™é‡Œä½œä¸ºå¤‡ä»½é€»è¾‘
                                if (location === 'ç¯å²›è·¯' && !found) {
                                    console.log('ä½¿ç”¨ç¯å²›è·¯çš„å¤‡ç”¨ç¡¬ç¼–ç åæ ‡');
                                    try {
                                        // ä½¿ç”¨é€šç”¨çš„å®šä½å‡½æ•°
                                        if (focusOnMarker('ç¯å²›è·¯')) {
                                        } else {
                                            // å¦‚æœæ ‡è®°ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç¡¬ç¼–ç åæ ‡
                                            const pos = new AMap.LngLat(118.1257, 24.4348);
                                            
                                            // å…ˆè®¾ç½®ä¸­å¿ƒç‚¹
                                            window.map.setCenter(pos);
                                            
                                            // ä½¿ç”¨åŠ¨ç”»æ•ˆæœå¹³æ»‘ç¼©æ”¾ï¼Œå¹¶è€ƒè™‘åœ°å›¾å®¹å™¨é«˜åº¦çš„ä¸€åŠä½œä¸ºå‚ç›´åç§»
                                            const mapContainer = document.getElementById('map-container');
                                            const verticalOffset = mapContainer.clientHeight / 4;
                                            
                                            // è®¾ç½®ç¼©æ”¾çº§åˆ«å’Œåç§»
                                            window.map.setZoomAndCenter(14, pos, false);
                                            window.map.panBy(0, -verticalOffset);
                                        }
                                        
                                        found = true;
                                    } catch (e) {
                                        console.error('ç¯å²›è·¯å¤‡ç”¨å®šä½å¤±è´¥:', e);
                                    }
                                }
                                
                                if (!found) {
                                    // æ˜¾ç¤ºå‹å¥½æç¤ºï¼Œè€Œä¸æ˜¯è‡ªåŠ¨æœç´¢
                                    const mapOverlay = document.querySelector('.map-overlay');
                                    
                                    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶æç¤ºå…ƒç´ 
                                    const noticeElement = document.createElement('div');
                                    noticeElement.className = 'location-notice';
                                    noticeElement.innerHTML = `
                                        <div style="background-color: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); margin-top: 10px; text-align: center; color: #ff6b00;">
                                            <i class='bx bx-info-circle'></i> æœªæ‰¾åˆ°"${location}"æ™¯ç‚¹ï¼Œæ‚¨å¯ä»¥å°è¯•åœ¨æœç´¢æ¡†ä¸­æœç´¢
                                        </div>
                                    `;
                                    
                                    // æ·»åŠ åˆ°åœ°å›¾è¦†ç›–å±‚
                                    mapOverlay.appendChild(noticeElement);
                                    
                                    // å°†æ™¯ç‚¹åç§°å¡«å…¥æœç´¢æ¡†ï¼Œä½†ä¸è‡ªåŠ¨æœç´¢
                                    document.getElementById('search-input').value = location;
                                    document.getElementById('search-input').focus();
                                    
                                    // 3ç§’åç§»é™¤æç¤º
                                    setTimeout(function() {
                                        if (noticeElement.parentNode) {
                                            noticeElement.parentNode.removeChild(noticeElement);
                                        }
                                    }, 3000);
                                }
                            }
                        }, 100);
                    });
                });
                
                // æ·»åŠ é…’åº—ä½ç½®ç‚¹å‡»äº‹ä»¶
                document.getElementById('hotel-location').addEventListener('click', function() {
                    // æ£€æŸ¥åœ°å›¾å’ŒAMapå¯¹è±¡æ˜¯å¦å·²åŠ è½½
                    if (!window.map || !window.AMap || !window.mapReady) {
                        console.warn('åœ°å›¾å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•');
                        return;
                    }
                    
                    // å¦‚æœå½“å‰æ˜¯è·¯çº¿å›¾æ¨¡å¼ï¼Œå…ˆåˆ‡æ¢åˆ°æ™®é€šåœ°å›¾æ¨¡å¼
                    if (window.currentMapMode === 'route') {
                        switchMapMode('normal');
                    }
                    
                    // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿åœ°å›¾æ ‡è®°å·²ç»åŠ è½½
                    setTimeout(function() {
                        // å†æ¬¡æ£€æŸ¥åœ°å›¾å’Œæ ‡è®°æ˜¯å¦å·²åŠ è½½
                        if (!window.map || !window.markers || !window.AMap || !window.mapReady) {
                            console.warn('åœ°å›¾æˆ–æ ‡è®°å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•');
                            return;
                        }
                        
                        // è§¦å‘é…’åº—æ ‡è®°ç‚¹å‡»
                        if (window.markers['ç¾å±…é…’åº—']) {
                            try {
                                // ä½¿ç”¨é€šç”¨çš„å®šä½å‡½æ•°
                                focusOnMarker('ç¾å±…é…’åº—');
                                
                                // æ»šåŠ¨åˆ°åœ°å›¾å¡ç‰‡
                                document.querySelector('.map-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
                            } catch (e) {
                                console.error('è§¦å‘é…’åº—æ ‡è®°ç‚¹å‡»äº‹ä»¶å¤±è´¥:', e);
                            }
                        } else {
                            console.log('æœªæ‰¾åˆ°é…’åº—æ ‡è®°');
                            // æ˜¾ç¤ºå‹å¥½æç¤ºï¼Œè€Œä¸æ˜¯è‡ªåŠ¨æœç´¢
                            const mapOverlay = document.querySelector('.map-overlay');
                            
                            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶æç¤ºå…ƒç´ 
                            const noticeElement = document.createElement('div');
                            noticeElement.className = 'location-notice';
                            noticeElement.innerHTML = `
                                <div style="background-color: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); margin-top: 10px; text-align: center; color: #ff6b00;">
                                    <i class='bx bx-info-circle'></i> æœªæ‰¾åˆ°"ç¾å±…é…’åº—"ï¼Œæ‚¨å¯ä»¥å°è¯•åœ¨æœç´¢æ¡†ä¸­æœç´¢
                                </div>
                            `;
                            
                            // æ·»åŠ åˆ°åœ°å›¾è¦†ç›–å±‚
                            mapOverlay.appendChild(noticeElement);
                            
                            // å°†é…’åº—åç§°å¡«å…¥æœç´¢æ¡†ï¼Œä½†ä¸è‡ªåŠ¨æœç´¢
                            document.getElementById('search-input').value = 'ç¾å±…é…’åº—';
                            document.getElementById('search-input').focus();
                            
                            // 3ç§’åç§»é™¤æç¤º
                            setTimeout(function() {
                                if (noticeElement.parentNode) {
                                    noticeElement.parentNode.removeChild(noticeElement);
                                }
                            }, 3000);
                        }
                    }, 100);
                });
                
                // æ·»åŠ æœç´¢é‡ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                document.getElementById('search-reset').addEventListener('click', function() {
                    // æ¸…é™¤æœç´¢ç»“æœ
                    if (window.searchMarkers && window.searchMarkers.length > 0) {
                        window.searchMarkers.forEach(function(marker) {
                            marker.setMap(null);
                        });
                    }
                    
                    // å…³é—­ä¿¡æ¯çª—ä½“
                    if (window.currentInfoWindow) {
                        window.currentInfoWindow.close();
                    }
                    
                    // é‡ç½®æœç´¢æ¡†
                    document.getElementById('search-input').value = '';
                    document.getElementById('search-input').placeholder = 'æœç´¢å¦é—¨çš„åœ°ç‚¹...';
                    window.searchType = null;
                    
                    // è°ƒæ•´åœ°å›¾è§†å›¾
                    var allMarkers = [];
                    for (var name in window.markers) {
                        allMarkers.push(window.markers[name].marker);
                    }
                    map.setFitView(allMarkers);
                });
                
                // åˆå§‹åŒ–åœ°å›¾åˆ‡æ¢åŠŸèƒ½
                initMapToggle();
                
                // æ·»åŠ æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                document.getElementById('search-button').addEventListener('click', function() {
                    searchPlaces();
                });
                
                // æ·»åŠ ç­›é€‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                document.getElementById('search-filter').addEventListener('click', function() {
                    document.getElementById('search-options').classList.toggle('active');
                });
                
                // æ·»åŠ æœç´¢é€‰é¡¹ç‚¹å‡»äº‹ä»¶
                document.querySelectorAll('.search-option').forEach(function(option) {
                    option.addEventListener('click', function() {
                        var type = this.getAttribute('data-type');
                        var searchInput = document.getElementById('search-input');
                        
                        // æ›´æ–°æœç´¢ç±»å‹
                        window.searchType = type;
                        
                        // æ›´æ–°æç¤ºæ–‡å­—
                        if (type) {
                            searchInput.placeholder = `æœç´¢å¦é—¨çš„${type}...`;
                        } else {
                            searchInput.placeholder = "æœç´¢å¦é—¨çš„åœ°ç‚¹...";
                        }
                        
                        // å…³é—­é€‰é¡¹èœå•
                        document.getElementById('search-options').classList.remove('active');
                        
                        // å¦‚æœæœç´¢æ¡†å·²æœ‰å†…å®¹ï¼Œè‡ªåŠ¨æ‰§è¡Œæœç´¢
                        if (searchInput.value.trim() !== '') {
                            searchPlaces();
                        }
                    });
                });
            };
            document.head.appendChild(script);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åœ°å›¾
        window.onload = function() {
            initMap();
            initWeather();
            initTimeDisplay();
        };
        
        // æ·»åŠ è¾“å…¥æ¡†å›è½¦äº‹ä»¶
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('search-button').click();
            }
        });
        
        // åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤ºåŠŸèƒ½
        function initTimeDisplay() {
            // æ›´æ–°å½“å‰æ—¶é—´
            updateTime();
            // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´
            setInterval(updateTime, 1000);
        }
        
        // æ›´æ–°å½“å‰æ—¶é—´
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const dateString = now.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                weekday: 'short'
            });
            
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            const timeDisplay = document.querySelector('.current-time');
            timeDisplay.innerHTML = `${dateString}<br>${timeString}`;
        }
        
        // åˆå§‹åŒ–å¤©æ°”åŠŸèƒ½
        function initWeather() {
            // ä½¿ç”¨é«˜å¾·åœ°å›¾å¤©æ°”APIè·å–å¦é—¨å®æ—¶å¤©æ°”
            fetchAmapWeather();
        }
        
        // ä½¿ç”¨é«˜å¾·åœ°å›¾å¤©æ°”APIè·å–å¦é—¨å¤©æ°”
        function fetchAmapWeather() {
            document.getElementById('current-weather-text').innerHTML = "æ­£åœ¨è·å–å¤©æ°”æ•°æ®...";
            
            // åˆ›å»ºå¤©æ°”å±•ç¤ºåŒºåŸŸ
            const weatherContainer = document.getElementById('weather-container');
            weatherContainer.innerHTML = `
                <div class="baidu-weather-wrapper" style="padding: 15px; height: auto;">
                    <div id="amap-weather-content">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 28px; font-weight: bold;"><span id="current-temp">26</span>Â°C</div>
                                <div style="color: #666; margin-top: 5px;"><span id="current-weather">æ™´</span> | <span id="current-humidity">æ¹¿åº¦ 75%</span></div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 14px; color: #666;">å¦é—¨å¸‚</div>
                                <div style="margin-top: 5px; font-size: 12px; color: #999;">
                                    <span id="current-wind">ä¸œå—é£ 2çº§</span>
                                </div>
                            </div>
                        </div>
                        <div id="forecast-container" style="display: flex; justify-content: space-between; text-align: center; border-top: 1px solid #eee; padding-top: 15px;">
                            <!-- å¤©æ°”é¢„æŠ¥å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                        </div>
                        <div style="text-align: right; margin-top: 10px; font-size: 12px; color: #999;">
                            æ•°æ®æ¥æº: é«˜å¾·åœ°å›¾å¤©æ°”API
                        </div>
                    </div>
                </div>
            `;
            
            // ä½¿ç”¨å¯†é’¥ç®¡ç†å™¨è·å–å®‰å…¨çš„APIå¯†é’¥
            const apiKey = keyManager.getMapKey();            
            // å¦é—¨çš„åŸå¸‚ç¼–ç ï¼ˆå¦é—¨: 350200ï¼‰
            const cityCode = '350200';
            
            // å¤„ç†APIè¯·æ±‚å¼‚å¸¸æƒ…å†µçš„å‡½æ•°
            function handleApiError(error) {
                console.error("è·å–å¤©æ°”æ•°æ®å¤±è´¥:", error);
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæœ¬åœ°æ–‡ä»¶è®¿é—®
                if (window.location.protocol === 'file:') {
                    console.warn("æ‚¨æ­£åœ¨ä½¿ç”¨æœ¬åœ°æ–‡ä»¶(file://)è®¿é—®é¡µé¢ï¼Œè¯·ç¡®ä¿åœ¨é«˜å¾·å¼€æ”¾å¹³å°å·²æ·»åŠ file://åˆ°åŸŸåç™½åå•");
                    // æ˜¾ç¤ºå¤©æ°”APIæç¤ºæ¡†
                    document.getElementById('weather-api-notice').classList.add('active');
                }
                
                // æ›´æ–°å¤©æ°”æ–‡æœ¬ä¸ºé™æ€æ•°æ®
                document.getElementById('current-weather-text').innerHTML = "å¦é—¨å®æ—¶å¤©æ°” <span style='color:#ff6b00;font-size:12px;'>(é™æ€æ•°æ®)</span>";
                
                // ä½¿ç”¨é™æ€æ•°æ®æ˜¾ç¤º
                return Promise.reject(error);
            }
            
            // æ„å»ºå®æ—¶å¤©æ°”APIè¯·æ±‚URL
            const liveWeatherUrl = `https://restapi.amap.com/v3/weather/weatherInfo?key=${apiKey}&city=${cityCode}&extensions=base`;
            
            // æ„å»ºå¤©æ°”é¢„æŠ¥APIè¯·æ±‚URL
            const forecastWeatherUrl = `https://restapi.amap.com/v3/weather/weatherInfo?key=${apiKey}&city=${cityCode}&extensions=all`;
            
            // è·å–å®æ—¶å¤©æ°”æ•°æ®
            fetch(liveWeatherUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`ç½‘ç»œå“åº”é”™è¯¯ (${response.status}): ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("é«˜å¾·å®æ—¶å¤©æ°”æ•°æ®:", data);
                    
                    if (data.status === '1' && data.lives && data.lives.length > 0) {
                        const liveWeather = data.lives[0];
                        
                        // æ›´æ–°å®æ—¶å¤©æ°”ä¿¡æ¯
                        document.getElementById('current-temp').textContent = liveWeather.temperature;
                        document.getElementById('current-weather').textContent = liveWeather.weather;
                        document.getElementById('current-humidity').textContent = `æ¹¿åº¦ ${liveWeather.humidity}%`;
                        document.getElementById('current-wind').textContent = `${liveWeather.winddirection}é£ ${liveWeather.windpower}`;
                        
                        // æ›´æ–°å¤©æ°”æ–‡æœ¬
                        document.getElementById('current-weather-text').innerHTML = `${liveWeather.temperature}Â°Cï¼Œ${liveWeather.weather}`;
                    } else {
                        // æ£€æŸ¥å¸¸è§APIé”™è¯¯
                        if (data.status === '0') {
                            if (data.info === 'INVALID_USER_KEY') {
                                throw new Error("æ— æ•ˆçš„APIå¯†é’¥");
                            } else if (data.info === 'USER_KEY_PLAT_NOMATCH') {
                                throw new Error("APIå¯†é’¥ä¸å¹³å°ä¸åŒ¹é…ï¼Œè¯·æ£€æŸ¥åŸŸåç™½åå•");
                                // æ˜¾ç¤ºAPIå¯†é’¥æç¤ºæ¡†
                                document.getElementById('api-notice').classList.add('active');
                            } else if (data.info === 'DAILY_QUERY_OVER_LIMIT') {
                                throw new Error("APIæŸ¥è¯¢è¶…è¿‡æ—¥é™é¢");
                            } else {
                                throw new Error(`é«˜å¾·APIé”™è¯¯: ${data.info}`);
                            }
                        } else {
                            throw new Error("é«˜å¾·å¤©æ°”APIè¿”å›æ•°æ®æ— æ•ˆ");
                        }
                    }
                })
                .catch(handleApiError);
            
            // è·å–å¤©æ°”é¢„æŠ¥æ•°æ®
            fetch(forecastWeatherUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`ç½‘ç»œå“åº”é”™è¯¯ (${response.status}): ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("é«˜å¾·å¤©æ°”é¢„æŠ¥æ•°æ®:", data);
                    
                    if (data.status === '1' && data.forecasts && data.forecasts.length > 0 && data.forecasts[0].casts) {
                        const forecasts = data.forecasts[0].casts;
                        const forecastContainer = document.getElementById('forecast-container');
                        
                        // æ¸…é™¤ç°æœ‰å†…å®¹
                        forecastContainer.innerHTML = '';
                        
                        // æœ€å¤šæ˜¾ç¤º3å¤©é¢„æŠ¥
                        const maxDays = Math.min(forecasts.length, 3);
                        
                        // å®šä¹‰å¤©æ°”å›¾æ ‡æ˜ å°„
                        const weatherIcons = {
                            'æ™´': 'bxs-sun',
                            'å¤šäº‘': 'bxs-cloud',
                            'é˜´': 'bxs-cloud',
                            'å°é›¨': 'bxs-cloud-rain',
                            'ä¸­é›¨': 'bxs-cloud-rain',
                            'å¤§é›¨': 'bxs-cloud-rain',
                            'æš´é›¨': 'bxs-cloud-rain',
                            'é›·é˜µé›¨': 'bxs-bolt',
                            'å°é›ª': 'bxs-cloud-snow',
                            'ä¸­é›ª': 'bxs-cloud-snow',
                            'å¤§é›ª': 'bxs-cloud-snow',
                            'æš´é›ª': 'bxs-cloud-snow',
                            'é›¾': 'bxs-fog',
                            'éœ¾': 'bxs-fog'
                        };
                        
                        // å®šä¹‰æ—¥æœŸæ˜ å°„
                        const dayNames = ['ä»Šå¤©', 'æ˜å¤©', 'åå¤©', 'ç¬¬4å¤©'];
                        
                        // æ·»åŠ é¢„æŠ¥ä¿¡æ¯
                        for (let i = 0; i < maxDays; i++) {
                            const forecast = forecasts[i];
                            
                            // ç¡®å®šå¤©æ°”å›¾æ ‡
                            const weatherIcon = weatherIcons[forecast.dayweather] || 'bxs-cloud';
                            
                            // åˆ›å»ºé¢„æŠ¥å…ƒç´ 
                            const dayElement = document.createElement('div');
                            dayElement.className = 'weather-day';
                            dayElement.style.flex = '1';
                            dayElement.innerHTML = `
                                <div>${dayNames[i]}</div>
                                <i class='bx ${weatherIcon} weather-icon'></i>
                                <div class="temp">${forecast.daytemp}Â°C / ${forecast.nighttemp}Â°C</div>
                                <div style="font-size: 12px;">${forecast.dayweather}</div>
                            `;
                            
                            forecastContainer.appendChild(dayElement);
                        }
                    } else {
                        // æ£€æŸ¥å¸¸è§APIé”™è¯¯
                        if (data.status === '0') {
                            if (data.info === 'INVALID_USER_KEY') {
                                throw new Error("æ— æ•ˆçš„APIå¯†é’¥");
                            } else if (data.info === 'USER_KEY_PLAT_NOMATCH') {
                                throw new Error("APIå¯†é’¥ä¸å¹³å°ä¸åŒ¹é…ï¼Œè¯·æ£€æŸ¥åŸŸåç™½åå•");
                                // æ˜¾ç¤ºAPIå¯†é’¥æç¤ºæ¡†
                                document.getElementById('api-notice').classList.add('active');
                            } else if (data.info === 'DAILY_QUERY_OVER_LIMIT') {
                                throw new Error("APIæŸ¥è¯¢è¶…è¿‡æ—¥é™é¢");
                            } else {
                                throw new Error(`é«˜å¾·APIé”™è¯¯: ${data.info}`);
                            }
                        } else {
                            throw new Error("é«˜å¾·å¤©æ°”é¢„æŠ¥APIè¿”å›æ•°æ®æ— æ•ˆ");
                        }
                    }
                })
                .catch(error => {
                    console.error("è·å–å¤©æ°”é¢„æŠ¥æ•°æ®å¤±è´¥:", error);
                    
                    // ä½¿ç”¨é™æ€é¢„æŠ¥æ•°æ®
                    const forecastContainer = document.getElementById('forecast-container');
                    forecastContainer.innerHTML = `
                        <div class="weather-day" style="flex: 1;">
                            <div>ä»Šå¤©</div>
                            <i class='bx bxs-sun weather-icon'></i>
                            <div class="temp">29Â°C / 24Â°C</div>
                            <div style="font-size: 12px;">æ™´</div>
                        </div>
                        <div class="weather-day" style="flex: 1;">
                            <div>æ˜å¤©</div>
                            <i class='bx bxs-cloud weather-icon'></i>
                            <div class="temp">28Â°C / 23Â°C</div>
                            <div style="font-size: 12px;">å¤šäº‘</div>
                        </div>
                        <div class="weather-day" style="flex: 1;">
                            <div>åå¤©</div>
                            <i class='bx bxs-cloud weather-icon'></i>
                            <div class="temp">27Â°C / 22Â°C</div>
                            <div style="font-size: 12px;">å¤šäº‘</div>
                        </div>
                    `;
                    
                    // å¦‚æœå®æ—¶å¤©æ°”ä¹Ÿå¤±è´¥ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                    // è¿™é‡Œä¸ç›´æ¥è°ƒç”¨handleApiErroræ˜¯ä¸ºäº†é¿å…é‡å¤æ˜¾ç¤ºæç¤ºæ¡†
                    if (window.location.protocol === 'file:' && document.getElementById('weather-api-notice').classList.contains('active') === false) {
                        console.warn("æ‚¨æ­£åœ¨ä½¿ç”¨æœ¬åœ°æ–‡ä»¶(file://)è®¿é—®é¡µé¢ï¼Œè¯·ç¡®ä¿åœ¨é«˜å¾·å¼€æ”¾å¹³å°å·²æ·»åŠ file://åˆ°åŸŸåç™½åå•");
                        document.getElementById('weather-api-notice').classList.add('active');
                    }
                });
        }
        
        // åˆ é™¤è¡Œç¨‹è·¯çº¿æ•°æ®
        
        // åˆå§‹åŒ–åœ°å›¾äº¤äº’åŠŸèƒ½
        function initMapToggle() {
            // ç§»é™¤ä¸éœ€è¦çš„æŒ‰é’®äº‹ä»¶ç›‘å¬
            if (document.getElementById('map-normal')) {
                document.getElementById('map-normal').style.display = 'none';
            }
            if (document.getElementById('map-route')) {
                document.getElementById('map-route').style.display = 'none';
            }
            
            // ç¡®ä¿åœ°å›¾è¦†ç›–ç‰©å’Œæœç´¢æ§ä»¶å¯è§
            document.querySelector('.map-overlay').style.display = 'block';
            document.querySelector('.search-container').style.display = 'flex';
            document.getElementById('search-filter').style.display = 'block';
            document.getElementById('search-reset').style.display = 'block';
        }
        
        // æœç´¢åœ°ç‚¹å‡½æ•°
        function searchPlaces(directKeyword) {
            var keyword = directKeyword || document.getElementById('search-input').value;
            if (keyword.trim() === '') {
                return;
            }
            
            // å¦‚æœæ˜¯ç›´æ¥ä¼ å…¥çš„å…³é”®è¯ï¼Œæ›´æ–°æœç´¢æ¡†
            if (directKeyword) {
                document.getElementById('search-input').value = directKeyword;
            }
            
            // ç¡®ä¿åœ°å›¾å·²åŠ è½½
            if (!window.map || !window.AMap || !window.mapReady) {
                console.error('åœ°å›¾å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•');
                alert('åœ°å›¾æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•');
                return;
            }
            
            // æ¸…é™¤ä¹‹å‰çš„æœç´¢ç»“æœ
            if (window.searchMarkers && window.searchMarkers.length > 0) {
                window.searchMarkers.forEach(function(marker) {
                    marker.setMap(null);
                });
            }
            window.searchMarkers = [];
            
            // æ¸…é™¤ä¹‹å‰çš„ä¿¡æ¯çª—ä½“
            if (window.currentInfoWindow) {
                window.currentInfoWindow.close();
            }
            
            // ä½¿ç”¨å¯†é’¥ç®¡ç†å™¨è·å–å®‰å…¨çš„APIå¯†é’¥
            const apiKey = keyManager.getMapKey();
            
            // æ„å»ºè¯·æ±‚å‚æ•°
            const params = {
                keywords: keyword,                           // æœç´¢å…³é”®è¯
                city: "å¦é—¨",                                // åŸå¸‚
                offset: 20,                                  // æ¯é¡µè®°å½•æ•°
                page: 1,                                     // å½“å‰é¡µæ•°
                key: apiKey,                                 // APIå¯†é’¥
                extensions: "all"                            // è¿”å›æ‰©å±•ä¿¡æ¯
            };
            
            // å¦‚æœè®¾ç½®äº†ç±»å‹ï¼Œæ·»åŠ typeså‚æ•°
            if (window.searchType) {
                params.types = window.searchType;
            }
            
            // æ„å»ºæŸ¥è¯¢å­—ç¬¦ä¸²
            const queryString = Object.keys(params)
                .map(key => `${key}=${encodeURIComponent(params[key])}`)
                .join('&');
            
            // æ„å»ºæœ€ç»ˆURL
            const apiUrl = `https://restapi.amap.com/v3/place/text?${queryString}`;
            
            // å‘èµ·JSONPè¯·æ±‚ï¼Œå› ä¸ºè·¨åŸŸé™åˆ¶æ— æ³•ç›´æ¥ä½¿ç”¨fetch
            searchWithJSONP(apiUrl);
        }
        
        // ä½¿ç”¨JSONPå‘èµ·è¯·æ±‚
        function searchWithJSONP(url) {
            // åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„å›è°ƒå‡½æ•°å
            const callbackName = 'amapJsonpCallback_' + Math.random().toString(36).substring(2, 10);
            
            // åœ¨windowå¯¹è±¡ä¸Šå®šä¹‰å›è°ƒå‡½æ•°
            window[callbackName] = function(result) {
                console.log("APIå“åº”:", result);
                try {
                    handleSearchResult(result);
                } finally {
                    // æ¸…ç†å…¨å±€å›è°ƒ
                    delete window[callbackName];
                    document.head.removeChild(script);
                }
            };
            
            // æ·»åŠ å›è°ƒå‚æ•°åˆ°URL
            url = url + '&callback=' + callbackName;
            
            // åˆ›å»ºscriptæ ‡ç­¾
            const script = document.createElement('script');
            script.src = url;
            
            // é”™è¯¯å¤„ç†
            script.onerror = function() {
                console.error("APIè¯·æ±‚å¤±è´¥");
                alert("æœç´¢æœåŠ¡è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥");
                delete window[callbackName];
                document.head.removeChild(script);
            };
            
            // å°†scriptæ ‡ç­¾æ·»åŠ åˆ°æ–‡æ¡£
            document.head.appendChild(script);
        }
        
        // å¤„ç†æœç´¢ç»“æœ
        function handleSearchResult(result) {
            if (result.status === '1' && result.pois && result.pois.length > 0) {
                console.log("æœç´¢åˆ°", result.pois.length, "ä¸ªç»“æœ");
                // æ¸…é™¤ä¹‹å‰çš„æœç´¢ç»“æœæ ‡è®°
                if (window.searchMarkers && window.searchMarkers.length > 0) {
                    window.searchMarkers.forEach(function(item) {
                        if (item && item.marker) {
                            item.marker.setMap(null);
                        }
                        if (item && item.text) {
                            item.text.setMap(null);
                        }
                    });
                }
                window.searchMarkers = [];
                
                // è·å–æœç´¢ç»“æœå®¹å™¨
                const searchResultsContainer = document.getElementById('search-results');
                searchResultsContainer.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                
                // åˆ›å»ºæœç´¢ç»“æœåˆ—è¡¨
                result.pois.forEach(function(poi, index) {
                    console.log("POIä¿¡æ¯:", index, poi.name, poi.type);
                    
                    // åˆ›å»ºç»“æœé¡¹
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    
                    // è®¡ç®—è·ç¦»æ–‡æœ¬
                    let distanceText = '';
                    if (poi.distance) {
                        const distance = parseInt(poi.distance);
                        distanceText = distance < 1000 ? 
                            `è·ç¦» ${distance} ç±³` : 
                            `è·ç¦» ${(distance/1000).toFixed(1)} å…¬é‡Œ`;
                    }
                    
                    // è®¾ç½®ç»“æœé¡¹å†…å®¹
                    resultItem.innerHTML = `
                        <div class="search-result-name">${poi.name}</div>
                        ${poi.address ? `<div class="search-result-address">${poi.address}</div>` : ''}
                        ${distanceText ? `<div class="search-result-distance"><i class='bx bx-walk'></i> ${distanceText}</div>` : ''}
                    `;
                    
                    // ä¸ºç»“æœé¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    resultItem.addEventListener('click', function() {
                        try {
                            // è§£æåæ ‡
                            const location = poi.location.split(',');
                            const lng = parseFloat(location[0]);
                            const lat = parseFloat(location[1]);
                            
                            // åˆ›å»ºæ ‡è®°(å¦‚æœä¸å­˜åœ¨)
                            if (!window.searchMarkers[index]) {
                                // åˆ›å»ºæ ‡è®°å›¾æ ‡
                                var markerIcon = new AMap.Icon({
                                    size: new AMap.Size(36, 48),  
                                    image: "https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png", // ä½¿ç”¨çº¢è‰²æ ‡è®°
                                    imageSize: new AMap.Size(36, 48)
                                });
                                
                                // å®šä¹‰è‡ªå®šä¹‰å›¾æ ‡é¢œè‰²ï¼Œä¸ç½‘ç«™ä¸»é¢˜è‰²åŒ¹é…
                                var iconColor;
                                
                                // å¦‚æœæ˜¯ä¸åŒç±»å‹çš„åœ°ç‚¹ï¼Œä½¿ç”¨ä¸åŒçš„å›¾æ ‡é¢œè‰²
                                if (poi.type && poi.type.includes("é¤é¥®")) {
                                    iconColor = '#FF6B00'; // ä¸»é¢˜æ©™è‰² - é¤é¥®
                                } else if (poi.type && poi.type.includes("é…’åº—")) {
                                    iconColor = '#0084FF'; // è“è‰² - é…’åº—
                                } else if (poi.type && poi.type.includes("æ™¯ç‚¹")) {
                                    iconColor = '#FFB800'; // é»„è‰² - æ™¯ç‚¹
                                } else if (poi.type && poi.type.includes("è´­ç‰©")) {
                                    iconColor = '#9C27B0'; // ç´«è‰² - è´­ç‰©
                                } else if (poi.type && poi.type.includes("äº¤é€š")) {
                                    iconColor = '#4CAF50'; // ç»¿è‰² - äº¤é€š
                                } else {
                                    iconColor = '#FF4500'; // æ©™çº¢è‰² - å…¶ä»–
                                }
                                
                                // åˆ›å»ºè‡ªå®šä¹‰SVGå›¾æ ‡
                                markerIcon = new AMap.Icon({
                                    size: new AMap.Size(40, 40),
                                    imageSize: new AMap.Size(40, 40),
                                    image: 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
                                        <path d="M20 0C8.96 0 0 8.96 0 20c0 17.73 20 44 20 44s20-26.27,20-44C40,8.96,31.04,0,20,0z M20,27c-3.87,0-7-3.13-7-7s3.13-7,7-7,7,3.13,7,7S23.87,27,20,27z" 
                                        fill="${iconColor}" stroke="#FFFFFF" stroke-width="2"/>
                                    </svg>`)
                                });
                                
                                // åˆ›å»ºå‚ç›´æ–‡æœ¬æ ‡è®° - ä¸ä¸»æ ‡è®°é£æ ¼ä¸€è‡´
                                var markerHeight = 70;
                                var markerWidth = 36; // æ›´çª„çš„æ ‡è®°
                                var fontSize = 14;
                                
                                // åˆ›å»ºå‚ç›´æ–‡æœ¬
                                var verticalText = '';
                                // é™åˆ¶åç§°é•¿åº¦ï¼Œé¿å…æ ‡è®°è¿‡é«˜
                                var displayName = poi.name.length > 8 ? poi.name.substring(0, 8) : poi.name;
                                for (var i = 0; i < displayName.length; i++) {
                                    verticalText += displayName[i] + (i < displayName.length - 1 ? '<br>' : '');
                                }
                                
                                // åˆ›å»ºæ ‡è®°
                                var marker = new AMap.Marker({
                                    position: new AMap.LngLat(lng, lat),
                                    title: poi.name,
                                    map: window.map,
                                    content: `<div style="background-color:${iconColor}; color:white; width:${markerWidth}px; height:${markerHeight}px; 
                                        border-radius:18px; text-align:center; display:flex; align-items:center; justify-content:center; 
                                        font-weight:bold; font-size:${fontSize}px; box-shadow:0 2px 6px rgba(0,0,0,0.3); padding:5px 0;">
                                        ${verticalText}
                                    </div>`,
                                    offset: new AMap.Pixel(-markerWidth/2, -markerHeight/2),
                                    animation: 'AMAP_ANIMATION_DROP',
                                    zIndex: 110
                                });
                                
                                // ä¸å†éœ€è¦é¢å¤–çš„æ–‡æœ¬æ ‡ç­¾
                                var text = null;
                                
                                // åˆ›å»ºä¿¡æ¯çª—ä½“
                                var infoWindow = new AMap.InfoWindow({
                                    content: `
                                        <div style="padding: 12px; max-width: 300px; border-radius: 8px;">
                                            <h4 style="margin:0 0 8px 0; color: ${iconColor}; font-size:16px;">${poi.name}</h4>
                                            ${poi.address ? `<p style="margin:0; font-size:12px; color:#666;"><i class='bx bx-map'></i> ${poi.address}</p>` : ''}
                                            ${poi.tel ? `<p style="margin:5px 0 0 0; font-size:12px;"><i class='bx bx-phone'></i> ${poi.tel}</p>` : ''}
                                            ${poi.distance ? `<p style="margin:5px 0 0 0; font-size:12px; color:${iconColor};"><i class='bx bx-walk'></i> è·ç¦»çº¦ ${(parseInt(poi.distance)/1000).toFixed(1)} å…¬é‡Œ</p>` : ''}
                                            ${poi.type ? `<p style="margin:5px 0 0 0; font-size:12px; color:#666;"><i class='bx bx-category'></i> ${poi.type}</p>` : ''}
                                        </div>
                                    `,
                                    offset: new AMap.Pixel(0, -30),
                                    closeWhenClickMap: true,
                                    isCustom: true,
                                    autoMove: true
                                });
                                
                                // ä¸ºæ ‡è®°æ·»åŠ ç‚¹å‡»äº‹ä»¶
                                marker.on('click', function() {
                                    // å…³é—­ä¹‹å‰çš„ä¿¡æ¯çª—ä½“
                                    if (window.currentInfoWindow) {
                                        window.currentInfoWindow.close();
                                    }
                                    
                                    infoWindow.open(window.map, marker.getPosition());
                                    window.currentInfoWindow = infoWindow;
                                });
                                
                                // ä¿å­˜æ ‡è®°å’Œæ–‡æœ¬æ ‡ç­¾çš„å¼•ç”¨
                                var markerObj = {
                                    marker: marker
                                };
                                
                                // å¦‚æœæœ‰æ–‡æœ¬æ ‡ç­¾ï¼Œä¿å­˜å¼•ç”¨
                                if (text) {
                                    markerObj.text = text;
                                }
                                
                                window.searchMarkers[index] = markerObj;
                            }
                            
                            // å…³é—­ä¹‹å‰çš„ä¿¡æ¯çª—ä½“
                            if (window.currentInfoWindow) {
                                window.currentInfoWindow.close();
                            }
                            
                            // æ‰“å¼€å½“å‰æ ‡è®°çš„ä¿¡æ¯çª—ä½“
                            const currentMarkerObj = window.searchMarkers[index];
                            const currentMarker = currentMarkerObj ? currentMarkerObj.marker : null;
                            const currentInfoWindow = new AMap.InfoWindow({
                                content: `
                                    <div style="padding: 12px; max-width: 300px; border-radius: 8px;">
                                        <h4 style="margin:0 0 8px 0; color: ${iconColor}; font-size:16px;">${poi.name}</h4>
                                        ${poi.address ? `<p style="margin:0; font-size:12px; color:#666;"><i class='bx bx-map'></i> ${poi.address}</p>` : ''}
                                        ${poi.tel ? `<p style="margin:5px 0 0 0; font-size:12px;"><i class='bx bx-phone'></i> ${poi.tel}</p>` : ''}
                                        ${poi.distance ? `<p style="margin:5px 0 0 0; font-size:12px; color:${iconColor};"><i class='bx bx-walk'></i> è·ç¦»çº¦ ${(parseInt(poi.distance)/1000).toFixed(1)} å…¬é‡Œ</p>` : ''}
                                        ${poi.type ? `<p style="margin:5px 0 0 0; font-size:12px; color:#666;"><i class='bx bx-category'></i> ${poi.type}</p>` : ''}
                                    </div>
                                `,
                                offset: new AMap.Pixel(0, -30),
                                closeWhenClickMap: true,
                                isCustom: true,
                                autoMove: true
                            });
                            
                            currentInfoWindow.open(window.map, new AMap.LngLat(lng, lat));
                            
                            // èšç„¦åˆ°å½“å‰ä½ç½® - ä½¿ç”¨æ›´å¥½çš„å®šä½æ–¹å¼
                            // è®¾ç½®ä¸­å¿ƒç‚¹å’Œç¼©æ”¾çº§åˆ«ï¼Œæ ¹æ®ç”¨æˆ·éœ€æ±‚ä¿æŒåœ¨åœ°å›¾ä¸­é—´
                            window.map.setCenter(new AMap.LngLat(lng, lat));
                            window.map.setZoomAndCenter(15, new AMap.LngLat(lng, lat), false); // å‘ä¸Šåç§»
                            
                            // éšè—æœç´¢ç»“æœåˆ—è¡¨
                            document.getElementById('search-results').classList.remove('active');
                            
                        } catch (e) {
                            console.error("ç‚¹å‡»æœç´¢ç»“æœå¤„ç†å¤±è´¥:", e, poi);
                        }
                    });
                    
                    // å°†ç»“æœé¡¹æ·»åŠ åˆ°å®¹å™¨
                    searchResultsContainer.appendChild(resultItem);
                });
                
                // æ˜¾ç¤ºæœç´¢ç»“æœåˆ—è¡¨
                searchResultsContainer.classList.add('active');
                
            } else {
                var errorMsg = "æœç´¢å¤±è´¥æˆ–æœªæ‰¾åˆ°ç»“æœ";
                
                if (result.status === '0') {
                    if (result.info === 'INVALID_USER_KEY') {
                        errorMsg = "æ— æ•ˆçš„APIå¯†é’¥ã€‚è¯·æ£€æŸ¥æ‚¨çš„å¯†é’¥æ˜¯å¦æ­£ç¡®ã€‚";
                    } else if (result.info === 'DAILY_QUERY_OVER_LIMIT') {
                        errorMsg = "APIå¯†é’¥è¶…è¿‡æ—¥é…é¢é™åˆ¶ï¼Œè¯·æ˜å¤©å†è¯•æˆ–å‡çº§æ‚¨çš„APIä½¿ç”¨é‡ã€‚";
                    } else {
                        errorMsg = "æœç´¢å¤±è´¥: " + result.info;
                    }
                    
                    if (result.info === 'USER_KEY_PLAT_NOMATCH') {
                        // æ˜¾ç¤ºAPIå¯†é’¥æç¤ºæ¡†
                        document.getElementById('api-notice').classList.add('active');
                    }
                } else if (result.pois && result.pois.length === 0) {
                    errorMsg = "æœªæ‰¾åˆ°ç›¸å…³åœ°ç‚¹ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯";
                }
                
                alert(errorMsg);
                console.error("æœç´¢ç»“æœ:", result);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åœ°å›¾
        window.onload = function() {
            initMap();
            initWeather();
            initTimeDisplay();
        };
        
        // æ·»åŠ å®šä½åˆ°æ ‡è®°çš„é€šç”¨å‡½æ•°
        function focusOnMarker(markerName) {
            if (window.markers && window.markers[markerName] && window.markers[markerName].marker) {
                // è·å–æ ‡è®°ä½ç½®
                const pos = window.markers[markerName].marker.getPosition();
                
                // è®¾ç½®ä¸­å¿ƒç‚¹
                window.map.setCenter(pos);
                
                // è®¾ç½®ç¼©æ”¾çº§åˆ«
                const zoom = window.markers[markerName].type === 'hotel' ? 15 : 14;
                window.map.setZoomAndCenter(zoom, pos, false);
                
                // è§¦å‘æ ‡è®°ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºä¿¡æ¯çª—ä½“
                if (window.AMap && window.AMap.event && typeof window.AMap.event.trigger === 'function') {
                    window.AMap.event.trigger(window.markers[markerName].marker, 'click');
                }
                
                return true;
            }
            return false;
        }
        
        // åŠ è½½html2canvasåº“
        function loadHtml2Canvas() {
            return new Promise((resolve, reject) => {
                if (window.html2canvas) {
                    resolve(window.html2canvas);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
                script.onload = () => resolve(window.html2canvas);
                script.onerror = () => reject(new Error('Failed to load html2canvas'));
                document.head.appendChild(script);
            });
        }
        
        // æ˜¾ç¤ºå¤‡ç”¨æ–¹æ¡ˆå‡½æ•°
        function showPrintAlternative() {
            const alternativeSolution = document.createElement('div');
            alternativeSolution.style.position = 'fixed';
            alternativeSolution.style.top = '50%';
            alternativeSolution.style.left = '50%';
            alternativeSolution.style.transform = 'translate(-50%, -50%)';
            alternativeSolution.style.backgroundColor = 'white';
            alternativeSolution.style.padding = '20px';
            alternativeSolution.style.borderRadius = '10px';
            alternativeSolution.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
            alternativeSolution.style.zIndex = '10000';
            alternativeSolution.style.maxWidth = '600px';
            alternativeSolution.style.width = '90%';
            alternativeSolution.innerHTML = `
                <h3 style="color: #FF6B00; margin-top: 0;">æˆªå›¾åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨</h3>
                <p>ç”±äºæµè§ˆå™¨é™åˆ¶æˆ–è€…é¡µé¢å¤æ‚åº¦è¾ƒé«˜ï¼Œæˆªå›¾åŠŸèƒ½æš‚æ—¶æ— æ³•ä½¿ç”¨ã€‚æˆ‘ä»¬å»ºè®®æ‚¨å°è¯•ä»¥ä¸‹å¤‡ç”¨æ–¹æ¡ˆï¼š</p>
                <ol>
                    <li>ä½¿ç”¨æ‰“å°åŠŸèƒ½å°†ç½‘é¡µä¿å­˜ä¸ºPDF</li>
                    <li>ä½¿ç”¨æµè§ˆå™¨è‡ªå¸¦çš„æˆªå›¾å·¥å…·</li>
                    <li>ä½¿ç”¨FireShotç­‰ä¸“ä¸šæˆªå›¾æ’ä»¶</li>
                </ol>
                <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä½¿ç”¨æ‰“å°åŠŸèƒ½ï¼š</p>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button id="proceed-to-print-alt" style="background-color: #FF6B00; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1; margin-right: 10px;">æ‰“å°ä¸ºPDF</button>
                    <button id="cancel-print-alt" style="background-color: #999; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1; margin-left: 10px;">å–æ¶ˆ</button>
                </div>
            `;
            document.body.appendChild(alternativeSolution);
            
            document.getElementById('proceed-to-print-alt').addEventListener('click', function() {
                document.body.removeChild(alternativeSolution);
                window.print();
            });
            
            document.getElementById('cancel-print-alt').addEventListener('click', function() {
                document.body.removeChild(alternativeSolution);
            });
        }
        
        // é€ä¸ªå¤„ç†æ ‡ç­¾é¡µ
        
        // é€ä¸ªå¤„ç†æ ‡ç­¾é¡µ
        async function processNextTab(tabs, index, originalActiveItems, originalActiveContents, html2canvas) {
            if (index >= tabs.length) {
                // æ¢å¤åŸå§‹æ´»åŠ¨æ ‡ç­¾
                originalActiveItems.forEach(item => item.classList.add('active'));
                originalActiveContents.forEach(content => content.classList.add('active'));
                
                showExportLoading(false);
                showExportStatus('æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹å¯¼å‡ºå®Œæˆï¼', 'success');
                return;
            }
            
            const currentTab = tabs[index];
            const tabName = currentTab.textContent.trim();
            
            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.day-content').forEach(content => content.classList.remove('active'));
            
            // æ¿€æ´»å½“å‰æ ‡ç­¾
            currentTab.classList.add('active');
            
            // è·å–å…³è”çš„å†…å®¹ID
            const dayId = currentTab.getAttribute('data-day');
            const foodDayId = currentTab.getAttribute('data-food-day');
            const contentId = dayId || foodDayId;
            
            if (contentId) {
                const content = document.getElementById(contentId);
                if (content) {
                    content.classList.add('active');
                }
            }
            
            // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿DOMæ›´æ–°
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // ç¡®å®šè¦æˆªå›¾çš„å…ƒç´ 
            let targetElement;
            if (dayId) {
                targetElement = document.querySelector('.itinerary');
            } else if (foodDayId) {
                targetElement = document.querySelector('.food-card');
            } else {
                // å¦‚æœæ— æ³•ç¡®å®šå…ƒç´ ï¼Œè·³åˆ°ä¸‹ä¸€ä¸ª
                await processNextTab(tabs, index + 1, originalActiveItems, originalActiveContents, html2canvas);
                return;
            }
            
            try {
                // å¤„ç†æœ¬åœ°å›¾ç‰‡è·¨åŸŸé—®é¢˜
                const images = targetElement.querySelectorAll('img');
                const originalSrcs = [];
                
                // å¤‡ä»½åŸå§‹å›¾ç‰‡è·¯å¾„å¹¶æ›¿æ¢ä¸ºå ä½ç¬¦
                for (let i = 0; i < images.length; i++) {
                    originalSrcs.push(images[i].src);
                    if (images[i].src.startsWith('file://') || images[i].src.includes('image/')) {
                        // æ›¿æ¢ä¸ºå ä½å›¾ç‰‡
                        images[i].setAttribute('data-original-src', images[i].src);
                        images[i].src = 'data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22' + 
                                      (images[i].width || 300) + '%22%20height%3D%22' + (images[i].height || 200) + 
                                      '%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23f5f5f5%22%2F%3E%3Ctext%20x%3D%2250%25%22%20' + 
                                      'y%3D%2250%25%22%20dominant-baseline%3D%22middle%22%20text-anchor%3D%22middle%22%20font-family%3D%22Arial%22%20font-size%3D%2214%22%20fill%3D%22%23999%22%3E' + 
                                      images[i].alt + '%3C%2Ftext%3E%3C%2Fsvg%3E';
                    }
                }
                
                // æ•è·å½“å‰æ ‡ç­¾é¡µå†…å®¹
                const canvas = await html2canvas(targetElement, {
                    allowTaint: false,
                    useCORS: true,
                    scale: 1,
                    logging: true,
                    backgroundColor: '#ffffff',
                    foreignObjectRendering: false,
                    removeContainer: true
                });
                
                // æ¢å¤åŸå§‹å›¾ç‰‡è·¯å¾„
                for (let i = 0; i < images.length; i++) {
                    if (images[i].hasAttribute('data-original-src')) {
                        images[i].src = images[i].getAttribute('data-original-src');
                        images[i].removeAttribute('data-original-src');
                    }
                }
                
                try {
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const downloadLink = document.createElement('a');
                    downloadLink.href = canvas.toDataURL('image/png');
                    downloadLink.download = `å¦é—¨æ—…æ¸¸æŒ‡å—_${tabName}.png`;
                    downloadLink.textContent = `ä¸‹è½½${tabName}å†…å®¹æˆªå›¾`;
                    downloadLink.style.display = 'block';
                    downloadLink.style.margin = '10px 0';
                    downloadLink.style.padding = '8px';
                    downloadLink.style.backgroundColor = '#0084FF';
                    downloadLink.style.color = 'white';
                    downloadLink.style.textDecoration = 'none';
                    downloadLink.style.borderRadius = '5px';
                    downloadLink.style.textAlign = 'center';
                    
                    // æ·»åŠ åˆ°ä¸‹è½½åŒºåŸŸ
                    const downloadLinks = document.getElementById('export-download-links');
                    if (downloadLinks) {
                        downloadLinks.appendChild(downloadLink);
                    }
                } catch (err) {
                    console.error(`${tabName}æˆªå›¾ç”ŸæˆæˆåŠŸï¼Œä½†æ— æ³•åˆ›å»ºä¸‹è½½é“¾æ¥:`, err);
                    
                    // æ˜¾ç¤ºæˆªå›¾ç»“æœ
                    const imgContainer = document.createElement('div');
                    imgContainer.style.maxWidth = '100%';
                    imgContainer.style.overflow = 'auto';
                    imgContainer.style.border = '1px solid #ddd';
                    imgContainer.style.padding = '10px';
                    imgContainer.style.marginTop = '10px';
                    imgContainer.appendChild(canvas);
                    
                    const downloadLinks = document.getElementById('export-download-links');
                    if (downloadLinks) {
                        downloadLinks.appendChild(document.createTextNode(`${tabName}å†…å®¹æˆªå›¾ï¼ˆå³é”®ç‚¹å‡»å¹¶é€‰æ‹©"å›¾ç‰‡å¦å­˜ä¸º"ä¿å­˜ï¼‰ï¼š`));
                        downloadLinks.appendChild(imgContainer);
                    }
                }
            } catch (err) {
                console.error(`${tabName}æˆªå›¾å¤±è´¥:`, err);
                
                // æ¢å¤åŸå§‹å›¾ç‰‡è·¯å¾„
                const images = targetElement.querySelectorAll('img');
                for (let i = 0; i < images.length; i++) {
                    if (images[i].hasAttribute('data-original-src')) {
                        images[i].src = images[i].getAttribute('data-original-src');
                        images[i].removeAttribute('data-original-src');
                    }
                }
            }
            
            // å¤„ç†ä¸‹ä¸€ä¸ªæ ‡ç­¾é¡µ
            await processNextTab(tabs, index + 1, originalActiveItems, originalActiveContents, html2canvas);
        }
        
        // ç­‰å¾…DOMå®Œå…¨åŠ è½½åå†åˆå§‹åŒ–å¯¼å‡ºå·¥å…·
        document.addEventListener('DOMContentLoaded', function() {
            // é˜²æ­¢é‡å¤åˆå§‹åŒ–
            if (!window.exportToolInitialized) {
                window.exportToolInitialized = true;
                initExportTool();
                
                // åˆå§‹åŒ–å¯¼å‡ºæŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
                initExportButtonListeners();
            }
        });
        
        // åˆå§‹åŒ–å¯¼å‡ºæŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
        function initExportButtonListeners() {
            // ä¸éœ€è¦åˆå§‹åŒ–ä»»ä½•å¯¼å‡ºæŒ‰é’®ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»ç§»é™¤äº†è¿™äº›æŒ‰é’®
            console.log('å¯¼å‡ºæŒ‰é’®åˆå§‹åŒ– - å·²ç»ç§»é™¤ï¼Œåªä¿ç•™æ˜¾ç¤ºå…¨æ–‡å†…å®¹æŒ‰é’®');
        }
        
        // å®šä¹‰å…¨å±€å˜é‡ç”¨äºå­˜å‚¨å…ƒç´ åŸå§‹çŠ¶æ€
        let originalStates;
        
        // æˆªå›¾å¯¼å‡ºå¤„ç†å‡½æ•°
        async function handleCaptureClick() {
            showExportLoading(true);
            showExportStatus('æ­£åœ¨å‡†å¤‡é¡µé¢æˆªå›¾ï¼Œè¯·ç¨å€™...', 'info');
            
            try {
                // åˆå§‹åŒ–originalStates
                originalStates = {
                    images: new Map(),
                    backgroundElements: new Map(),
                    iframes: new Map(),
                    canvases: new Map()
                };
                // æš‚æ—¶éšè—å¯¼å‡ºå·¥å…·
                const exportTool = document.getElementById('export-tool');
                const exportToolButton = document.getElementById('show-export-tool');
                exportTool.style.display = 'none';
                exportToolButton.style.display = 'none';
                
                // è·å–æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹å…ƒç´ 
                const dayContents = document.querySelectorAll('.day-content');
                
                // å¤‡ä»½å½“å‰æ¿€æ´»çŠ¶æ€
                const activeContents = Array.from(document.querySelectorAll('.day-content.active')).map(el => el.id);
                const activeTabs = Array.from(document.querySelectorAll('.tab-item.active')).map(el => {
                    return el.getAttribute('data-day') || el.getAttribute('data-food-day');
                });
                
                // ä½¿æ‰€æœ‰å†…å®¹å¯è§ä»¥ä¾¿æˆªå›¾
                dayContents.forEach(function(content) {
                    content.classList.add('active');
                });
                
                // åŠ è½½html2canvasåº“
                const html2canvas = await loadHtml2Canvas();
                
                // æ£€æŸ¥é¡µé¢é«˜åº¦ï¼Œæ˜¯å¦éœ€è¦ä½¿ç”¨åˆ†æ®µæŠ€æœ¯
                const bodyHeight = document.body.scrollHeight;
                const isLargePage = bodyHeight > 15000; // åˆ¤æ–­æ˜¯å¦ä¸ºç‰¹å¤§é¡µé¢
                
                // å‡†å¤‡é¡µé¢ï¼Œéšè—å¹²æ‰°å…ƒç´ 
                const elementsToHide = document.querySelectorAll('.search-container, #map-loading, .api-notice');
                elementsToHide.forEach(el => {
                    if (el) el.style.display = 'none';
                });
                
                // å¦‚æœæ˜¯ç‰¹å¤§é¡µé¢ï¼Œä¸´æ—¶éšè—ä¸éœ€è¦çš„å†…å®¹ä»¥å‡å°é¡µé¢å¤§å°
                if (isLargePage) {
                    // åˆ›å»ºä¸€ä¸ªæç¤ºï¼Œå‘ŠçŸ¥ç”¨æˆ·æ­£åœ¨å¤„ç†å¤§é¡µé¢
                    progressText.insertAdjacentHTML('afterend', 
                        '<p style="font-size: 12px; color: #777;">æ£€æµ‹åˆ°é¡µé¢å†…å®¹è¾ƒå¤šï¼Œä¼˜åŒ–å¤„ç†ä¸­...</p>');
                    
                    // åˆ›å»ºä¸´æ—¶æ ·å¼ï¼Œæé«˜é¡µé¢æ¸²æŸ“æ€§èƒ½
                    const tempStyle = document.createElement('style');
                    tempStyle.id = 'temp-screenshot-style';
                    tempStyle.textContent = `
                        .map-container { height: 300px !important; overflow: hidden; }
                        iframe { max-height: 200px !important; }
                        img { max-height: 600px !important; }
                    `;
                    document.head.appendChild(tempStyle);
                    
                    // å¾…æˆªå›¾å®Œæˆåç§»é™¤ä¸´æ—¶æ ·å¼
                    setTimeout(() => {
                        const styleToRemove = document.getElementById('temp-screenshot-style');
                        if (styleToRemove) document.head.removeChild(styleToRemove);
                    }, 10000);
                }
                
                // ç§»é™¤æ‰€æœ‰å¯èƒ½å¯¼è‡´è·¨åŸŸé—®é¢˜çš„å…ƒç´ 
                // åˆ›å»ºä¸€ä¸ªç®€å•çš„çº¯è‰²å ä½ç¬¦
                const placeholderSVG = `data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 100"><rect width="100%" height="100%" fill="%23f0f0f0"/><text x="50%" y="50%" font-family="Arial" font-size="14" text-anchor="middle" fill="%23999">å›¾ç‰‡</text></svg>`;
                const placeholderCSS = "background-color: #f0f0f0 !important; background-image: none !important;";
                
                // å¤‡ä»½æ‰€æœ‰éœ€è¦æ¢å¤çš„å…ƒç´ ä¿¡æ¯ - å·²åœ¨å‡½æ•°å¼€å§‹æ—¶åˆå§‹åŒ–
                
                // æå‰ç¦ç”¨æ‰€æœ‰å›¾åƒåŠ è½½ï¼Œé˜²æ­¢è·¨åŸŸé”™è¯¯
                document.querySelectorAll('img').forEach(img => {
                    // ä¿å­˜é¢å¤–çš„å±æ€§å’Œæ ·å¼ä¿¡æ¯
                    if (img.style.cssText) {
                        img.setAttribute('data-original-style', img.style.cssText);
                    }
                    // é˜»æ­¢å›¾åƒé‡æ–°åŠ è½½
                    img.setAttribute('loading', 'lazy');
                });
                
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ ·å¼ï¼Œé˜»æ­¢æ‰€æœ‰èƒŒæ™¯å›¾ç‰‡å’Œå›¾ç‰‡åŠ è½½
                const tempStyle = document.createElement('style');
                tempStyle.id = 'temp-screenshot-style';
                tempStyle.textContent = `
                    img {
                        background-color: #f0f0f0 !important;
                        min-width: 50px !important;
                        min-height: 50px !important;
                    }
                    [style*="background-image"] {
                        background-image: none !important;
                        background-color: #f0f0f0 !important;
                    }
                `;
                document.head.appendChild(tempStyle);
                
                // å¤„ç†æ‰€æœ‰å›¾ç‰‡å…ƒç´ 
                const images = document.querySelectorAll('img');
                images.forEach(img => {
                    try {
                        if (!img.src.startsWith('data:')) {
                            // ä¿å­˜åŸå§‹å›¾ç‰‡ä¿¡æ¯
                            originalStates.images.set(img, {
                                src: img.src,
                                width: img.width || 100,
                                height: img.height || 100,
                                styleDisplay: img.style.display
                            });
                            
                            // æ›¿æ¢ä¸ºæœ¬åœ°å®‰å…¨çš„SVGå ä½ç¬¦
                            img.src = placeholderSVG;
                            
                            // ä¿æŒåŸå§‹å°ºå¯¸å¹¶å¼ºåˆ¶æ˜¾ç¤º
                            const width = originalStates.images.get(img).width;
                            const height = originalStates.images.get(img).height;
                            img.style.width = (width > 10 ? width : 100) + 'px';
                            img.style.height = (height > 10 ? height : 100) + 'px';
                            img.style.display = 'inline-block';
                            img.style.backgroundColor = '#f0f0f0';
                            img.style.border = '1px dashed #ccc';
                            
                            // æ·»åŠ å†…å®¹æ ‡è¯†
                            if (img.alt) {
                                // åˆ›å»ºä¸€ä¸ªæ ‡ç­¾æ˜¾ç¤ºå›¾ç‰‡åŸæ¥çš„altæ–‡æœ¬
                                const label = document.createElement('span');
                                label.textContent = img.alt;
                                label.style.position = 'absolute';
                                label.style.top = '50%';
                                label.style.left = '50%';
                                label.style.transform = 'translate(-50%, -50%)';
                                label.style.color = '#999';
                                label.style.fontSize = '12px';
                                label.style.textAlign = 'center';
                                label.style.pointerEvents = 'none';
                                
                                // ç¡®ä¿å›¾ç‰‡å®¹å™¨æ˜¯ç›¸å¯¹å®šä½çš„
                                img.style.position = 'relative';
                                img.parentNode.insertBefore(label, img.nextSibling);
                                
                                // ä¿å­˜æ ‡ç­¾ä»¥ä¾¿åç»­æ¢å¤
                                originalStates.images.get(img).label = label;
                            }
                        }
                    } catch (err) {
                        console.warn("æ›¿æ¢å›¾ç‰‡å¤±è´¥:", err);
                    }
                });
                
                // å¤„ç†èƒŒæ™¯å›¾ç‰‡
                const elementsWithBackgroundImage = Array.from(document.querySelectorAll('*')).filter(el => {
                    const style = window.getComputedStyle(el);
                    return style.backgroundImage && style.backgroundImage !== 'none' && !style.backgroundImage.startsWith('url("data:');
                });
                
                elementsWithBackgroundImage.forEach(el => {
                    try {
                        // ä¿å­˜åŸå§‹èƒŒæ™¯ä¿¡æ¯
                        originalStates.backgroundElements.set(el, {
                            backgroundImage: el.style.backgroundImage,
                            cssText: el.style.cssText
                        });
                        
                        // ç§»é™¤èƒŒæ™¯å›¾ç‰‡
                        el.style.cssText += placeholderCSS;
                    } catch (err) {
                        console.warn("å¤„ç†èƒŒæ™¯å›¾ç‰‡å¤±è´¥:", err);
                    }
                });
                
                // å¤„ç†iframeå…ƒç´ 
                const iframes = document.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    try {
                        // ä¿å­˜åŸå§‹iframeä¿¡æ¯
                        originalStates.iframes.set(iframe, {
                            src: iframe.src,
                            srcdoc: iframe.srcdoc
                        });
                        
                        // æ›¿æ¢ä¸ºç©ºç™½å†…å®¹
                        iframe.src = "about:blank";
                        iframe.srcdoc = "<html><body style='background:#f0f0f0'><p style='text-align:center;color:#999'>iframe å†…å®¹</p></body></html>";
                    } catch (err) {
                        console.warn("å¤„ç†iframeå¤±è´¥:", err);
                    }
                });
                
                // å¤„ç†canvaså…ƒç´ 
                const canvases = document.querySelectorAll('canvas');
                canvases.forEach(canvas => {
                    try {
                        const ctx = canvas.getContext('2d');
                        if (ctx) {
                            // ä¿å­˜canvasæ•°æ®
                            try {
                                originalStates.canvases.set(canvas, {
                                    dataUrl: canvas.toDataURL()
                                });
                            } catch (e) {
                                // å·²ç»è¢«æ±¡æŸ“çš„canvasæ— æ³•è·å–æ•°æ®ï¼Œå¿½ç•¥é”™è¯¯
                            }
                            
                            // æ¸…ç©ºå¹¶ç»˜åˆ¶å ä½ç¬¦
                            ctx.fillStyle = "#f0f0f0";
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.fillStyle = "#999";
                            ctx.font = "14px Arial";
                            ctx.textAlign = "center";
                            ctx.fillText("ç”»å¸ƒå†…å®¹", canvas.width/2, canvas.height/2);
                        }
                    } catch (err) {
                        console.warn("å¤„ç†canvaså¤±è´¥:", err);
                    }
                });
                
                // åˆ›å»ºä¸€ä¸ªçŠ¶æ€æç¤ºå¯¹è¯æ¡†
                const statusDialog = document.createElement('div');
                statusDialog.style.position = 'fixed';
                statusDialog.style.top = '50%';
                statusDialog.style.left = '50%';
                statusDialog.style.transform = 'translate(-50%, -50%)';
                statusDialog.style.backgroundColor = 'white';
                statusDialog.style.padding = '20px';
                statusDialog.style.borderRadius = '10px';
                statusDialog.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
                statusDialog.style.zIndex = '10000';
                statusDialog.style.maxWidth = '400px';
                statusDialog.style.width = '90%';
                statusDialog.style.textAlign = 'center';
                statusDialog.innerHTML = `
                    <h3 style="color: #FF6B00; margin-top: 0;">æ­£åœ¨ç”Ÿæˆå®Œæ•´é¡µé¢æˆªå›¾</h3>
                    <div style="margin: 20px 0;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(255, 107, 0, 0.3); border-radius: 50%; border-top-color: #FF6B00; animation: spin 1s ease-in-out infinite;"></div>
                        <p style="margin-top: 15px;">é¡µé¢æˆªå›¾å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
                        <p style="font-size: 12px; color: #777;">æˆªå›¾è¾ƒå¤§æ—¶å¯èƒ½éœ€è¦30ç§’å·¦å³</p>
                    </div>
                    <div id="screenshot-progress" style="width: 100%; height: 10px; background-color: #f0f0f0; border-radius: 5px; overflow: hidden; margin-top: 15px;">
                        <div id="screenshot-progress-bar" style="width: 0%; height: 100%; background-color: #FF6B00; transition: width 0.5s;"></div>
                    </div>
                    <p id="screenshot-progress-text" style="font-size: 12px; color: #777; margin-top: 5px;">0%</p>
                `;
                document.body.appendChild(statusDialog);
                
                // è·å–è¿›åº¦æ¡å…ƒç´ 
                const progressBar = document.getElementById('screenshot-progress-bar');
                const progressText = document.getElementById('screenshot-progress-text');
                
                // çœŸæ­£çš„FireShoté£æ ¼çš„å®Œæ•´é¡µé¢æˆªå›¾æ–¹æ³• - å€Ÿé‰´FireShotçš„æ¸è¿›æ¸²æŸ“æœºåˆ¶
                async function captureFullPage() {
                    // åŠ å…¥å»¶è¿Ÿå‡½æ•°ï¼Œä½¿ç”¨Promiseç¡®ä¿æ¯ä¸€æ­¥éƒ½èƒ½ç­‰å¾…è¶³å¤Ÿæ—¶é—´
                    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
                    
                    // æ˜¾ç¤ºçŠ¶æ€æ›´æ–°
                    progressText.innerText = "å‡†å¤‡ä¸­...";
                    progressBar.style.width = '5%';
                    
                    // å¼ºåˆ¶ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
                    await delay(500);
                    
                    // è®¡ç®—å®é™…é¡µé¢å°ºå¯¸ - å¤šæ¬¡æµ‹é‡å–æœ€å¤§å€¼ä»¥ç¡®ä¿å‡†ç¡®æ€§
                    let pageHeight = 0;
                    let pageWidth = 0;
                    
                    // å¤šæ¬¡æµ‹é‡é¡µé¢å°ºå¯¸ï¼Œå–æœ€å¤§å€¼ï¼Œç¡®ä¿è·å–æ­£ç¡®å°ºå¯¸
                    for (let i = 0; i < 3; i++) {
                        const body = document.body;
                        const html = document.documentElement;
                        
                        // æµ‹é‡å½“å‰å°ºå¯¸
                        const currentHeight = Math.max(
                            body.scrollHeight, body.offsetHeight,
                            html.clientHeight, html.scrollHeight, html.offsetHeight
                        );
                        const currentWidth = Math.max(
                            body.scrollWidth, body.offsetWidth,
                            html.clientWidth, html.scrollWidth, html.offsetWidth
                        );
                        
                        // å–æœ€å¤§å€¼
                        pageHeight = Math.max(pageHeight, currentHeight);
                        pageWidth = Math.max(pageWidth, currentWidth);
                        
                        // åœ¨æµ‹é‡ä¹‹é—´ç­‰å¾…ï¼Œå…è®¸ä»»ä½•å¼‚æ­¥åŠ è½½å†…å®¹å®Œæˆ
                        await delay(100);
                    }
                    
                    progressText.innerText = "æµ‹é‡é¡µé¢å°ºå¯¸å®Œæˆ: " + pageWidth + "x" + pageHeight + "px";
                    progressBar.style.width = '10%';
                    
                    // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
                    const originalScrollPos = window.pageYOffset;
                    
                    // æ·»åŠ ä¸€ä¸ªå¯è§†æŒ‡ç¤ºå™¨ï¼Œå±•ç¤ºå½“å‰æ•è·åŒºåŸŸï¼ˆå¼€å‘æ¨¡å¼ï¼‰
                    let captureIndicator = null;
                    const enableCaptureIndicator = false; // è®¾ä¸ºtrueå¯ç”¨äºè°ƒè¯•
                    if (enableCaptureIndicator) {
                        captureIndicator = document.createElement('div');
                        captureIndicator.style.cssText = `
                            position: absolute;
                            border: 2px solid red;
                            background-color: rgba(255,0,0,0.1);
                            pointer-events: none;
                            z-index: 9999;
                            transition: all 0.3s ease;
                        `;
                        document.body.appendChild(captureIndicator);
                    }
                    
                    // åˆ›å»ºä¸€ä¸ªç”»å¸ƒä»¥å®¹çº³æ•´ä¸ªé¡µé¢
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = window.devicePixelRatio || 1;
                    
                    // åˆ›å»ºç¨å¤§ä¸€ç‚¹çš„ç”»å¸ƒä»¥é¿å…ä»»ä½•å†…å®¹è¢«è£å‰ª
                    const safetyMargin = 100 * scale;
                    canvas.width = (pageWidth + 50) * scale;  // æ·»åŠ 50pxè¾¹è·
                    canvas.height = (pageHeight + 50) * scale; // æ·»åŠ 50pxè¾¹è·
                    ctx.scale(scale, scale);
                    
                    // å¡«å……ç™½è‰²èƒŒæ™¯
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // FireShotä½¿ç”¨çš„æ˜¯è§†å£é«˜åº¦çš„åŠ¨æ€è®¡ç®—ï¼Œæˆ‘ä»¬è¿™é‡Œä¹Ÿé‡‡ç”¨ç±»ä¼¼æ–¹æ³•
                    // è¿™ä¸ªå˜é‡éå¸¸é‡è¦ï¼Œå®ƒè¢«å¤šä¸ªåœ°æ–¹å¼•ç”¨ï¼Œä¸è¦é‡å‘½åæˆ–åˆ é™¤
                    const viewportHeight = window.innerHeight; // å½“å‰æµè§ˆå™¨è§†å£é«˜åº¦
                    // æ·»åŠ é‡å åŒºåŸŸä»¥ç¡®ä¿æ— ç¼æ‹¼æ¥ (FireShotä½¿ç”¨çš„æ˜¯100-200pxçš„é‡å )
                    const overlap = Math.round(viewportHeight * 0.2); // è§†å£é«˜åº¦çš„20%ä½œä¸ºé‡å 
                    // è®¡ç®—æ»šåŠ¨æ­¥é•¿ï¼Œè€ƒè™‘é‡å 
                    const scrollStep = viewportHeight - overlap;
                    // è®¡ç®—æ€»æ»šåŠ¨æ¬¡æ•°
                    const totalScrolls = Math.ceil(pageHeight / scrollStep);
                    
                    // æ›´æ–°è¿›åº¦
                    progressText.innerText = `å‡†å¤‡åˆ†æ®µæ•è·: æ€»å…±${totalScrolls}ä¸ªç‰‡æ®µ`;
                    progressBar.style.width = '15%';
                    
                    // é…ç½®html2canvasé€‰é¡¹
                    const options = {
                        scale: scale,
                        allowTaint: true,
                        useCORS: true,
                        logging: false,
                        scrollY: 0,
                        width: pageWidth,
                        height: pageHeight,
                        windowWidth: document.documentElement.offsetWidth,
                        windowHeight: viewportHeight,
                        // æé«˜æ¸²æŸ“è´¨é‡
                        backgroundColor: '#ffffff', // ä½¿ç”¨ç™½è‰²èƒŒæ™¯
                        // å›¾åƒå¤„ç†
                        imageTimeout: 0,
                        foreignObjectRendering: false, // ç¦ç”¨foreignObjectï¼Œé¿å…è·¨åŸŸé—®é¢˜
                        removeContainer: true, // æ•è·å®Œæˆåè‡ªåŠ¨ç§»é™¤ä¸´æ—¶å®¹å™¨
                        ignoreElements: (element) => {
                            // å¿½ç•¥å¯¼å‡ºå·¥å…·å’ŒåŠ¨æ€æ·»åŠ çš„å…ƒç´ 
                            return element.id === 'export-tool' || 
                                   element.id === 'show-export-tool' || 
                                   element.id === 'export-loading' || 
                                   element.id === 'export-status' ||
                                   element.id === 'statusDialog' ||
                                   element.classList.contains('loading-indicator');
                        },
                        // å…³é—­è¾…åŠ©å·¥å…·ä»¥é¿å…å¹²æ‰°
                        onclone: (clonedDoc) => {
                            // éšè—ä¸éœ€è¦çš„å…ƒç´ 
                            const elementsToHide = clonedDoc.querySelectorAll('#export-tool, #show-export-tool, #export-loading, #export-status');
                            elementsToHide.forEach(el => {
                                if (el) el.style.display = 'none';
                            });
                            
                            // ä¸ºæ¯ä¸ªå›¾ç‰‡å…ƒç´ æ·»åŠ å ä½ç¬¦
                            clonedDoc.querySelectorAll('img').forEach(img => {
                                if (!img.complete || img.naturalHeight === 0) {
                                    img.style.backgroundColor = '#f0f0f0';
                                    img.style.border = '1px dashed #ccc';
                                }
                            });
                        }
                    };
                    
                    try {
                        // FireShotçš„æ ¸å¿ƒæ˜¯åˆ†æ®µæ¸²æŸ“ä¸ç­‰å¾…ç­–ç•¥
                        
                        // 1. é¢„å…ˆæ·»åŠ é¡µé¢æ¸²æŸ“é˜²æ­¢æ ·å¼å¹²æ‰°
                        document.documentElement.style.scrollBehavior = 'auto'; // ç¦ç”¨å¹³æ»‘æ»šåŠ¨
                        
                        // 2. ä¿ç•™åŸå§‹æ ·å¼å€¼ä»¥ä¾¿åç»­æ¢å¤
                        const originalScrollBehavior = document.documentElement.style.scrollBehavior;
                        const originalBodyHeight = document.body.style.height;
                        
                        // 3. ç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½å¯è§
                        document.body.style.height = `${pageHeight + 200}px`;
                        
                        // 4. FireShotçš„åˆ†æ®µç­–ç•¥ - ä½¿ç”¨è§†å£é«˜åº¦è€Œéå›ºå®šå€¼
                        // æ·»åŠ æ¸²æŸ“å»¶è¿Ÿå‡½æ•° - FireShotä¼šæ ¹æ®é¡µé¢å¤æ‚åº¦åŠ¨æ€è°ƒæ•´å»¶è¿Ÿ
                        const getScrollDelay = () => {
                            // åˆ¤æ–­é¡µé¢å¤æ‚åº¦çš„ç®€å•æ–¹æ³•
                            const imageCount = document.querySelectorAll('img').length;
                            const elementCount = document.querySelectorAll('*').length;
                            
                            // æ ¹æ®é¡µé¢å…ƒç´ æ•°é‡å’Œå›¾ç‰‡æ•°é‡åŠ¨æ€è°ƒæ•´å»¶è¿Ÿ
                            if (imageCount > 50 || elementCount > 3000) {
                                return 1000; // å¤æ‚é¡µé¢
                            } else if (imageCount > 20 || elementCount > 1000) {
                                return 800;  // ä¸­ç­‰å¤æ‚åº¦
                            }
                            return 600;      // ç®€å•é¡µé¢
                        };
                        
                        const scrollDelay = getScrollDelay();
                        progressText.innerText = `é¡µé¢å¤æ‚åº¦è¯„ä¼°å®Œæˆï¼Œæ»šåŠ¨å»¶è¿Ÿè®¾ä¸º: ${scrollDelay}ms`;
                        
                        // 5. é€æ®µæ•è·é¡µé¢
                        let capturedHeight = 0;
                        
                        // å…ˆæ»šåŠ¨åˆ°é¡¶éƒ¨
                        window.scrollTo(0, 0);
                        await delay(600); // ç»™è¶³å¤Ÿæ—¶é—´è®©é¡µé¢é¡¶éƒ¨å®Œå…¨åŠ è½½
                        
                        // é€æ®µæ»šåŠ¨æ•è·
                        for (let i = 0; i < totalScrolls; i++) {
                            // è®¡ç®—å½“å‰æ»šåŠ¨ä½ç½®
                            const scrollPosition = i * scrollStep;
                            
                            // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
                            const progress = Math.round(15 + ((i + 0.2) / totalScrolls) * 70);  // 15%-85%ä¹‹é—´
                            progressBar.style.width = `${progress}%`;
                            progressText.innerText = `æ­£åœ¨æ•è· (${i+1}/${totalScrolls}) - ${progress}%`;
                            
                            // FireShoté£æ ¼çš„æŒ‡ç¤ºå™¨æ˜¾ç¤ºå½“å‰æ•è·åŒºåŸŸ
                            if (enableCaptureIndicator) {
                                captureIndicator.style.top = scrollPosition + 'px';
                                captureIndicator.style.left = '0px';
                                captureIndicator.style.width = pageWidth + 'px';
                                captureIndicator.style.height = (viewportHeight) + 'px';
                            }
                            
                            // æ»šåŠ¨åˆ°æŒ‡å®šä½ç½®
                            window.scrollTo(0, scrollPosition);
                            
                            // ç»™é¡µé¢è¶³å¤Ÿçš„æ—¶é—´æ¥åŠ è½½å’Œæ¸²æŸ“
                            // FireShotæœ‰ç‰¹æ®Šçš„ç­‰å¾…ç­–ç•¥ï¼Œç­‰åˆ°é¡µé¢å®Œå…¨ç¨³å®š
                            await delay(scrollDelay);
                            
                            // åˆ›å»ºæ®µè½çš„æ•è·é€‰é¡¹ - ç±»ä¼¼FireShotçš„è®¾ç½®
                            const segmentOptions = {
                                ...options,
                                scrollY: -scrollPosition,
                                windowWidth: pageWidth,
                                windowHeight: viewportHeight + overlap, // åŒ…æ‹¬é‡å åŒºåŸŸ
                                height: viewportHeight + overlap,
                                x: 0,
                                y: 0
                            };
                            
                            try {
                                // FireShoté£æ ¼çš„æ¸è¿›å¼æ•è·å’Œæ‹¼æ¥
                                // æ¯æ¬¡æ•è·å½“å‰å¯è§éƒ¨åˆ†ï¼Œç²¾ç¡®å®šä½æ‹¼æ¥ä½ç½®
                                
                                // 1. æ•è·å½“å‰è§†å£å†…å®¹
                                const segmentCanvas = await html2canvas(document.documentElement, segmentOptions);
                                
                                // 2. è®¡ç®—æ‹¼æ¥ä½ç½® (FireShotä½¿ç”¨ç²¾ç¡®å®šä½)
                                // å¦‚æœæ˜¯é¦–ä¸ªç‰‡æ®µï¼Œç›´æ¥ä»é¡¶éƒ¨å¼€å§‹
                                // å¦åˆ™ä»å‡†ç¡®çš„æ»šåŠ¨ä½ç½®å¼€å§‹ç²¾ç¡®æ‹¼æ¥
                                const destY = Math.max(0, scrollPosition);
                                
                                // 3. è®¡ç®—éœ€è¦çš„æºåŒºåŸŸ - é¿å…é‡å¤å†…å®¹
                                // é¦–ä¸ªç‰‡æ®µå®Œæ•´ä½¿ç”¨ï¼Œåç»­ç‰‡æ®µè·³è¿‡é¡¶éƒ¨çš„é‡å åŒºåŸŸ
                                const sourceY = (i === 0) ? 0 : 0;
                                const drawHeight = (i === 0) ? viewportHeight : viewportHeight;
                                
                                // 4. FireShoté£æ ¼çš„ç²¾ç¡®æ‹¼æ¥
                                // æ›´æ–°è¿›åº¦æŒ‡ç¤º
                                const mergeProgress = Math.round(15 + ((i + 0.8) / totalScrolls) * 70);
                                progressBar.style.width = `${mergeProgress}%`;
                                progressText.innerText = `æ‹¼æ¥ç‰‡æ®µ (${i+1}/${totalScrolls}) - ${mergeProgress}%`;
                                
                                // ç»˜åˆ¶åˆ°ä¸»ç”»å¸ƒ
                                ctx.drawImage(
                                    segmentCanvas,
                                    0, sourceY,       // æºä½ç½® 
                                    pageWidth, drawHeight,  // æºå°ºå¯¸
                                    0, destY,         // ç›®æ ‡ä½ç½®
                                    pageWidth, drawHeight   // ç›®æ ‡å°ºå¯¸
                                );
                                
                                // 5. FireShotçš„å†…å­˜ä¼˜åŒ– - æ¸…ç†ä¸å†éœ€è¦çš„èµ„æº
                                // é˜²æ­¢å†…å­˜æ³„æ¼
                                segmentCanvas.width = 1;
                                segmentCanvas.height = 1;
                                
                                // è®°å½•å·²æˆåŠŸæ•è·çš„é«˜åº¦
                                capturedHeight = Math.max(capturedHeight, scrollPosition + viewportHeight);
                                
                                // çŸ­æš‚å»¶è¿Ÿï¼Œå…è®¸æµè§ˆå™¨å¤„ç†å…¶ä»–ä»»åŠ¡
                                await delay(50);
                                
                            } catch (segError) {
                                console.warn(`æ®µè½ ${i + 1} æ•è·å¤±è´¥:`, segError);
                                
                                // FireShoté£æ ¼çš„é”™è¯¯æ¢å¤å¤„ç†
                                try {
                                    // åˆ†å‰²å½“å‰è§†å£é«˜åº¦ä¸ºæ›´å°çš„ç‰‡æ®µ
                                    progressText.innerText = `ç‰‡æ®µ${i+1}æ•è·å¤±è´¥ï¼Œå°è¯•åˆ†æ®µæ¢å¤...`;
                                    
                                    // 1. åˆ†å‰²å½“å‰è§†å£é«˜åº¦
                                    const subHeight = Math.floor(viewportHeight / 2);
                                    
                                    // 2. æ•è·ä¸ŠåŠéƒ¨åˆ†
                                    window.scrollTo(0, scrollPosition);
                                    await delay(400);
                                    
                                    const upperOptions = {
                                        ...segmentOptions,
                                        height: subHeight,
                                        windowHeight: subHeight
                                    };
                                    
                                    const upperCanvas = await html2canvas(document.documentElement, upperOptions);
                                    
                                    // 3. ç»˜åˆ¶ä¸ŠåŠéƒ¨åˆ†
                                    ctx.drawImage(
                                        upperCanvas,
                                        0, 0,                 // æºä½ç½®
                                        pageWidth, subHeight, // æºå°ºå¯¸
                                        0, scrollPosition,    // ç›®æ ‡ä½ç½®
                                        pageWidth, subHeight  // ç›®æ ‡å°ºå¯¸
                                    );
                                    
                                    // æ¸…ç†èµ„æº
                                    upperCanvas.width = 1;
                                    upperCanvas.height = 1;
                                    
                                    // 4. æ•è·ä¸‹åŠéƒ¨åˆ†
                                    window.scrollTo(0, scrollPosition + subHeight - 50); // 50pxçš„é¢å¤–é‡å 
                                    await delay(400);
                                    
                                    const lowerOptions = {
                                        ...segmentOptions,
                                        scrollY: -(scrollPosition + subHeight - 50),
                                        height: subHeight + 50,
                                        windowHeight: subHeight + 50
                                    };
                                    
                                    const lowerCanvas = await html2canvas(document.documentElement, lowerOptions);
                                    
                                    // 5. ç»˜åˆ¶ä¸‹åŠéƒ¨åˆ†
                                    ctx.drawImage(
                                        lowerCanvas,
                                        0, 50,                    // æºä½ç½® (è·³è¿‡50pxé‡å )
                                        pageWidth, subHeight,     // æºå°ºå¯¸
                                        0, scrollPosition + subHeight, // ç›®æ ‡ä½ç½®
                                        pageWidth, subHeight      // ç›®æ ‡å°ºå¯¸
                                    );
                                    
                                    // æ¸…ç†èµ„æº
                                    lowerCanvas.width = 1;
                                    lowerCanvas.height = 1;
                                    
                                    // æ›´æ–°æ•è·é«˜åº¦
                                    capturedHeight = Math.max(capturedHeight, scrollPosition + viewportHeight);
                                } catch (fallbackError) {
                                    console.error(`æ®µè½ ${i+1} æ¢å¤æ•è·ä¹Ÿå¤±è´¥:`, fallbackError);
                                    // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªæ®µè½
                                }
                                
                                // é˜²æ­¢æµè§ˆå™¨å´©æºƒï¼Œç»™äºˆå–˜æ¯æ—¶é—´
                                await delay(100);
                            }
                        }
                        
                        // FireShoté£æ ¼çš„æ”¶å°¾å·¥ä½œ
                        progressBar.style.width = '85%';
                        progressText.innerText = `æ‹¼æ¥å®Œæˆï¼Œè¿›è¡ŒåæœŸå¤„ç†...`;
                        
                        // æ¢å¤åŸå§‹æ ·å¼
                        document.documentElement.style.scrollBehavior = originalScrollBehavior;
                        document.body.style.height = originalBodyHeight;
                        
                        // ç§»é™¤è°ƒè¯•æŒ‡ç¤ºå™¨
                        if (enableCaptureIndicator && captureIndicator && captureIndicator.parentNode) {
                            captureIndicator.parentNode.removeChild(captureIndicator);
                        }
                    } catch (error) {
                        console.error('æ•è·é¡µé¢è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                        
                        // å°è¯•ä½¿ç”¨å•æ¬¡æ•è·æ–¹æ³• - æ›´ç¨³å®šçš„æ–¹å¼
                        progressBar.style.width = '50%';
                        progressText.innerText = '50%';
                        progressText.insertAdjacentHTML('afterend', '<p style="font-size: 12px; color: #777;">åˆ†æ®µæ•è·å¤±è´¥ï¼Œå°è¯•ä¼˜åŒ–æ•è·...</p>');
                        
                        // å…ˆå¤‡ä»½åŸå§‹æ–‡æ¡£æ»šåŠ¨
                        const originalOverflow = document.documentElement.style.overflow;
                        const originalPosition = document.documentElement.style.position;
                        
                        // ä¿®æ”¹æ–‡æ¡£æ ·å¼ä»¥æ›´å¥½åœ°æ•è·
                        document.documentElement.style.overflow = 'visible';
                        document.documentElement.style.position = 'static';
                        
                        // æ»šå›é¡¶éƒ¨ä»¥æ•è·å®Œæ•´é¡µé¢
                        window.scrollTo(0, 0);
                        await new Promise(resolve => setTimeout(resolve, 800)); // ç»™è¶³å¤Ÿæ—¶é—´è®©é¡µé¢ç¨³å®š
                        
                        // ä½¿ç”¨ä¼˜åŒ–é…ç½®é‡æ–°å°è¯•æ•è·
                        const fallbackOptions = {
                            scale: scale,
                            allowTaint: true,
                            useCORS: true,
                            width: pageWidth,
                            height: pageHeight,
                            windowWidth: pageWidth,
                            windowHeight: pageHeight,  // ä½¿ç”¨å…¨é¡µé¢é«˜åº¦
                            scrollX: 0,
                            scrollY: 0,
                            x: 0,
                            y: 0,
                            backgroundColor: '#ffffff',
                            removeContainer: true,
                            imageTimeout: 0,
                            ignoreElements: (element) => {
                                return element.id === 'export-tool' || 
                                       element.id === 'show-export-tool' || 
                                       element.id === 'export-loading' || 
                                       element.id === 'export-status' ||
                                       element.id === 'statusDialog';
                            },
                            foreignObjectRendering: false,
                            onclone: (clonedDoc) => {
                                // éšè—ä¸éœ€è¦çš„å…ƒç´ 
                                clonedDoc.querySelectorAll('#export-tool, #show-export-tool, #export-loading, #export-status, #statusDialog').forEach(el => {
                                    if (el) el.style.display = 'none';
                                });
                                
                                // ç¡®ä¿æ‰€æœ‰å†…å®¹å¯è§
                                clonedDoc.querySelectorAll('.day-content').forEach(content => {
                                    content.style.display = 'block';
                                    content.style.height = 'auto';
                                    content.style.overflow = 'visible';
                                    content.style.opacity = '1';
                                });
                            }
                        };
                        
                        const fallbackCanvas = await html2canvas(document.body, fallbackOptions);
                        
                        // æ¢å¤åŸå§‹æ–‡æ¡£æ ·å¼
                        document.documentElement.style.overflow = originalOverflow;
                        document.documentElement.style.position = originalPosition;
                        
                        // ç»˜åˆ¶åˆ°ä¸»ç”»å¸ƒ
                        ctx.drawImage(fallbackCanvas, 0, 0);
                        
                        // æ˜¾ç¤ºæ•è·å®Œæˆ
                        progressBar.style.width = '90%';
                        progressText.innerText = '90%';
                    }
                    
                    // æ¢å¤åŸå§‹æ»šåŠ¨ä½ç½®
                    window.scrollTo(0, originalScrollPos);
                    
                    // æ¢å¤æ‰€æœ‰åŸå§‹å…ƒç´ çŠ¶æ€
                    // é¦–å…ˆç§»é™¤ä¸´æ—¶æ ·å¼
                    const tempStyleToRemove = document.getElementById('temp-screenshot-style');
                    if (tempStyleToRemove) {
                        document.head.removeChild(tempStyleToRemove);
                    }
                    
                    // æ¢å¤å›¾ç‰‡
                    originalStates.images.forEach((state, img) => {
                        if (img && state.src) {
                            // æ¢å¤åŸå§‹src
                            img.src = state.src;
                            
                            // æ¢å¤åŸå§‹å°ºå¯¸
                            if (state.width) img.width = state.width;
                            if (state.height) img.height = state.height;
                            
                            // æ¸…é™¤æ·»åŠ çš„æ ·å¼
                            img.style.width = '';
                            img.style.height = '';
                            img.style.display = state.styleDisplay || '';
                            img.style.backgroundColor = '';
                            img.style.border = '';
                            img.style.position = '';
                            
                            // æ¢å¤åŸå§‹æ ·å¼
                            if (img.hasAttribute('data-original-style')) {
                                img.style.cssText = img.getAttribute('data-original-style');
                                img.removeAttribute('data-original-style');
                            }
                            
                            // ç§»é™¤loadingå±æ€§
                            img.removeAttribute('loading');
                            
                            // åˆ é™¤æ·»åŠ çš„æ ‡ç­¾
                            if (state.label && state.label.parentNode) {
                                state.label.parentNode.removeChild(state.label);
                            }
                        }
                    });
                    
                    // æ¢å¤èƒŒæ™¯å›¾ç‰‡
                    originalStates.backgroundElements.forEach((state, el) => {
                        if (el && state.cssText) {
                            el.style.cssText = state.cssText;
                        }
                    });
                    
                    // æ¢å¤iframe
                    originalStates.iframes.forEach((state, iframe) => {
                        if (iframe && state.src) {
                            iframe.src = state.src;
                            if (state.srcdoc) iframe.srcdoc = state.srcdoc;
                        }
                    });
                    
                    // æ¢å¤canvas
                    originalStates.canvases.forEach((state, canvas) => {
                        if (canvas && state.dataUrl) {
                            try {
                                const img = new Image();
                                img.onload = () => {
                                    const ctx = canvas.getContext('2d');
                                    if (ctx) {
                                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                                        ctx.drawImage(img, 0, 0);
                                    }
                                };
                                img.src = state.dataUrl;
                            } catch (e) {
                                console.warn('æ¢å¤canvaså¤±è´¥:', e);
                            }
                        }
                    });
                    
                    // å®Œæˆè¿›åº¦æ˜¾ç¤º
                    progressBar.style.width = '100%';
                    progressText.innerText = '100%';
                    
                    // å¢åŠ é¢å¤–çš„åå¤„ç†ï¼šå¢å¼ºå¯¹æ¯”åº¦å’Œæ¸…æ™°åº¦
                    try {
                        // åˆ›å»ºä¸€ä¸ªæ–°ç”»å¸ƒä»¥åº”ç”¨åå¤„ç†æ•ˆæœ
                        const enhancedCanvas = document.createElement('canvas');
                        enhancedCanvas.width = canvas.width;
                        enhancedCanvas.height = canvas.height;
                        const enhancedCtx = enhancedCanvas.getContext('2d');
                        
                        // ç»˜åˆ¶åŸå§‹å›¾åƒ
                        enhancedCtx.drawImage(canvas, 0, 0);
                        
                        // åº”ç”¨ä¼˜åŒ–æ•ˆæœ
                        try {
                            // å°è¯•åº”ç”¨è½»å¾®é”åŒ–
                            const imageData = enhancedCtx.getImageData(0, 0, enhancedCanvas.width, enhancedCanvas.height);
                            const data = imageData.data;
                            
                            // è½»å¾®è°ƒæ•´å¯¹æ¯”åº¦
                            const contrast = 1.1; // è½»å¾®å¢å¼ºå¯¹æ¯”åº¦å€¼
                            const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
                            
                            for (let i = 0; i < data.length; i += 4) {
                                // å¯¹æ¯”åº¦è°ƒæ•´
                                data[i] = factor * (data[i] - 128) + 128;     // çº¢è‰²
                                data[i+1] = factor * (data[i+1] - 128) + 128; // ç»¿è‰²
                                data[i+2] = factor * (data[i+2] - 128) + 128; // è“è‰²
                            }
                            
                            enhancedCtx.putImageData(imageData, 0, 0);
                            return enhancedCanvas;
                        } catch (enhanceError) {
                            console.warn('å›¾åƒå¢å¼ºå¤„ç†å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æˆªå›¾:', enhanceError);
                            return canvas;
                        }
                    } catch (error) {
                        console.warn('åå¤„ç†å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æˆªå›¾:', error);
                        return canvas;
                    }
                }
                
                try {
                    // æ•è·å®Œæ•´é¡µé¢
                    const canvas = await captureFullPage();
                    
                    // ç§»é™¤çŠ¶æ€å¯¹è¯æ¡†
                    document.body.removeChild(statusDialog);
                    
                    // æ˜¾ç¤ºç»“æœå¯¹è¯æ¡†
                    const resultDialog = document.createElement('div');
                    resultDialog.style.position = 'fixed';
                    resultDialog.style.top = '50%';
                    resultDialog.style.left = '50%';
                    resultDialog.style.transform = 'translate(-50%, -50%)';
                    resultDialog.style.backgroundColor = 'white';
                    resultDialog.style.padding = '20px';
                    resultDialog.style.borderRadius = '10px';
                    resultDialog.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
                    resultDialog.style.zIndex = '10000';
                    resultDialog.style.maxWidth = '600px';
                    resultDialog.style.width = '90%';
                    
                    // åˆ›å»ºç¼©ç•¥å›¾é¢„è§ˆï¼ˆç¼©å°å°ºå¯¸ä»¥é€‚åº”å¯¹è¯æ¡†ï¼‰
                    const scaleFactor = 0.2; // ç¼©å°æ¯”ä¾‹
                    const thumbnail = document.createElement('canvas');
                    const thumbCtx = thumbnail.getContext('2d');
                    thumbnail.width = canvas.width * scaleFactor;
                    thumbnail.height = canvas.height * scaleFactor;
                    thumbCtx.drawImage(canvas, 0, 0, thumbnail.width, thumbnail.height);
                    
                    // è®¡ç®—æ–‡ä»¶å¤§å°ï¼ˆä¼°è®¡å€¼ï¼‰
                    const imgData = canvas.toDataURL('image/png');
                    const imgSize = Math.round((imgData.length * 3/4) / 1024); // ä¼°è®¡KBå¤§å°
                    
                    // è·å–è®¾å¤‡åƒç´ æ¯”
                    const devicePixelRatio = window.devicePixelRatio || 1;
                    
                    resultDialog.innerHTML = `
                        <h3 style="color: #FF6B00; margin-top: 0; display: flex; justify-content: space-between; align-items: center;">
                            <span>æˆªå›¾å·²å®Œæˆ</span>
                            <button id="close-screenshot-dialog" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #777;">&times;</button>
                        </h3>
                        <div style="display: flex; margin: 20px 0;">
                            <div style="flex: 1; max-height: 300px; overflow-y: auto; border: 1px solid #eee; position: relative;">
                                <div style="width: ${thumbnail.width}px; margin: 0 auto;">
                                    <img src="${thumbnail.toDataURL('image/png')}" alt="æˆªå›¾é¢„è§ˆ" style="width: 100%; height: auto; display: block;">
                                </div>
                            </div>
                            <div style="flex: 1; padding-left: 20px;">
                                <p><strong>å°ºå¯¸:</strong> ${Math.round(canvas.width/devicePixelRatio)}Ã—${Math.round(canvas.height/devicePixelRatio)}px</p>
                                <p><strong>å¤§å°:</strong> çº¦ ${imgSize} KB</p>
                                <p><strong>æ ¼å¼:</strong> PNG</p>
                                <p style="margin-top: 20px; color: #777; font-size: 13px;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¿å­˜æˆªå›¾</p>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                            <button id="save-screenshot-png" style="background-color: #FF6B00; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1; margin-right: 10px;">
                                <i class='bx bx-download' style="margin-right: 5px;"></i> ä¿å­˜ä¸ºPNG
                            </button>
                            <button id="save-screenshot-pdf" style="background-color: #0084FF; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1; margin-left: 10px;">
                                <i class='bx bxs-file-pdf' style="margin-right: 5px;"></i> ä¿å­˜ä¸ºPDF
                            </button>
                        </div>
                    `;
                    
                    document.body.appendChild(resultDialog);
                    
                    // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶
                    document.getElementById('close-screenshot-dialog').addEventListener('click', function() {
                        document.body.removeChild(resultDialog);
                        
                        // é‡ç½®ä¸ºåŸå§‹æ˜¾ç¤ºçŠ¶æ€
                        dayContents.forEach(function(content) {
                            content.classList.remove('active');
                        });
                        
                        // æ¢å¤ä¹‹å‰æ´»è·ƒçš„æ ‡ç­¾é¡µ
                        activeContents.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.classList.add('active');
                        });
                        
                        activeTabs.forEach(id => {
                            if (!id) return;
                            const selector = `[data-day="${id}"], [data-food-day="${id}"]`;
                            const el = document.querySelector(selector);
                            if (el) el.classList.add('active');
                        });
                        
                        // æ¢å¤æ˜¾ç¤ºå¯¼å‡ºå·¥å…·
                        exportTool.style.display = 'block';
                        exportToolButton.style.display = 'block';
                        
                        showExportLoading(false);
                    });
                    
                    // æ·»åŠ ä¿å­˜PNGæŒ‰é’®äº‹ä»¶
                    document.getElementById('save-screenshot-png').addEventListener('click', function() {
                        try {
                            // åˆ›å»ºä¸‹è½½é“¾æ¥
                            const downloadLink = document.createElement('a');
                            downloadLink.href = canvas.toDataURL('image/png');
                            downloadLink.download = 'å¦é—¨æ—…æ¸¸æŒ‡å—_' + new Date().toISOString().replace(/[:.]/g, '-') + '.png';
                            downloadLink.click();
                            
                            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                            const successMsg = document.createElement('div');
                            successMsg.style.position = 'absolute';
                            successMsg.style.bottom = '10px';
                            successMsg.style.left = '50%';
                            successMsg.style.transform = 'translateX(-50%)';
                            successMsg.style.backgroundColor = '#4CAF50';
                            successMsg.style.color = 'white';
                            successMsg.style.padding = '10px 20px';
                            successMsg.style.borderRadius = '5px';
                            successMsg.style.zIndex = '10001';
                            successMsg.textContent = 'æˆªå›¾å·²ä¿å­˜ä¸ºPNGæ ¼å¼';
                            resultDialog.appendChild(successMsg);
                            
                            setTimeout(() => {
                                if (successMsg.parentNode) {
                                    successMsg.parentNode.removeChild(successMsg);
                                }
                            }, 3000);
                        } catch (err) {
                            console.error('ä¿å­˜PNGå¤±è´¥:', err);
                            alert('ä¿å­˜PNGå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚');
                        }
                    });
                    
                    // æ·»åŠ ä¿å­˜PDFæŒ‰é’®äº‹ä»¶ - ä½¿ç”¨jsPDF
                    document.getElementById('save-screenshot-pdf').addEventListener('click', async function() {
                        try {
                            // åŠ¨æ€åŠ è½½jsPDFåº“
                            if (!window.jspdf) {
                                const jsPdfScript = document.createElement('script');
                                jsPdfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                                document.head.appendChild(jsPdfScript);
                                
                                await new Promise((resolve, reject) => {
                                    jsPdfScript.onload = resolve;
                                    jsPdfScript.onerror = reject;
                                });
                            }
                            
                            // åˆ›å»ºPDF
                            const { jsPDF } = window.jspdf;
                            const imgData = canvas.toDataURL('image/png');
                            
                            // ç¡®å®šPDFå¤§å° (A4: 210x297mm)
                            const pdf = new jsPDF({
                                orientation: canvas.height > canvas.width ? 'portrait' : 'landscape',
                                unit: 'mm',
                                format: 'a4'
                            });
                            
                            // é¡µé¢å°ºå¯¸ (mm)
                            const pageWidth = pdf.internal.pageSize.getWidth();
                            const pageHeight = pdf.internal.pageSize.getHeight();
                            
                            // å›¾åƒæ¯”ä¾‹ - ä½¿ç”¨devicePixelRatio
                            const devicePixelRatio = window.devicePixelRatio || 1;
                            const imgWidth = canvas.width / devicePixelRatio;
                            const imgHeight = canvas.height / devicePixelRatio;
                            const ratio = Math.min(pageWidth / imgWidth, pageHeight / imgHeight);
                            
                            // å¦‚æœå›¾åƒå¤ªå¤§ï¼Œéœ€è¦åˆ†é¡µ
                            if (imgHeight * ratio > pageHeight) {
                                // è®¡ç®—éœ€è¦çš„é¡µæ•°
                                const pagesCount = Math.ceil(imgHeight * ratio / pageHeight);
                                
                                // åœ¨æ¯é¡µä¸­æ·»åŠ å›¾åƒçš„ä¸€éƒ¨åˆ†
                                for (let i = 0; i < pagesCount; i++) {
                                    if (i > 0) {
                                        pdf.addPage();
                                    }
                                    
                                    const sourceY = i * pageHeight / ratio;
                                    const sourceHeight = Math.min(pageHeight / ratio, imgHeight - sourceY);
                                    
                                    pdf.addImage(
                                        imgData, 
                                        'PNG', 
                                        0, 0, // ç›®æ ‡ä½ç½®
                                        imgWidth * ratio, sourceHeight * ratio, // ç›®æ ‡å°ºå¯¸
                                        0, sourceY, // æºä½ç½®
                                        imgWidth, sourceHeight // æºå°ºå¯¸
                                    );
                                    
                                    // æ·»åŠ é¡µè„š
                                    pdf.setFontSize(8);
                                    pdf.setTextColor(150);
                                    pdf.text(`å¦é—¨æ—…æ¸¸æŒ‡å— - ç¬¬ ${i + 1} é¡µï¼Œå…± ${pagesCount} é¡µ`, pageWidth / 2, pageHeight - 5, { align: 'center' });
                                }
                            } else {
                                // å•é¡µæ·»åŠ å›¾åƒ
                                const yPos = (pageHeight - imgHeight * ratio) / 2;
                                pdf.addImage(imgData, 'PNG', 0, yPos, imgWidth * ratio, imgHeight * ratio);
                            }
                            
                            // ä¿å­˜PDF
                            pdf.save('å¦é—¨æ—…æ¸¸æŒ‡å—_' + new Date().toISOString().replace(/[:.]/g, '-') + '.pdf');
                            
                            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                            const successMsg = document.createElement('div');
                            successMsg.style.position = 'absolute';
                            successMsg.style.bottom = '10px';
                            successMsg.style.left = '50%';
                            successMsg.style.transform = 'translateX(-50%)';
                            successMsg.style.backgroundColor = '#4CAF50';
                            successMsg.style.color = 'white';
                            successMsg.style.padding = '10px 20px';
                            successMsg.style.borderRadius = '5px';
                            successMsg.style.zIndex = '10001';
                            successMsg.textContent = 'æˆªå›¾å·²ä¿å­˜ä¸ºPDFæ ¼å¼';
                            resultDialog.appendChild(successMsg);
                            
                            setTimeout(() => {
                                if (successMsg.parentNode) {
                                    successMsg.parentNode.removeChild(successMsg);
                                }
                            }, 3000);
                        } catch (err) {
                            console.error('ä¿å­˜PDFå¤±è´¥:', err);
                            alert('ä¿å­˜PDFå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚');
                        }
                    });
                    
                    showExportLoading(false);
                    showExportStatus('æˆªå›¾ç”Ÿæˆå®Œæˆï¼', 'success');
                } catch (err) {
                    console.error('æˆªå›¾å¤±è´¥:', err);
                    
                    // ç§»é™¤çŠ¶æ€å¯¹è¯æ¡†
                    if (document.contains(statusDialog)) {
                        document.body.removeChild(statusDialog);
                    }
                    
                    // æ¢å¤æ‰€æœ‰åŸå§‹å…ƒç´ çŠ¶æ€
                    // æ¢å¤å›¾ç‰‡
                    originalStates.images.forEach((state, img) => {
                        if (img && state.src) {
                            img.src = state.src;
                            if (state.width) img.width = state.width;
                            if (state.height) img.height = state.height;
                        }
                    });
                    
                    // æ¢å¤èƒŒæ™¯å›¾ç‰‡
                    originalStates.backgroundElements.forEach((state, el) => {
                        if (el && state.cssText) {
                            el.style.cssText = state.cssText;
                        }
                    });
                    
                    // æ¢å¤iframe
                    originalStates.iframes.forEach((state, iframe) => {
                        if (iframe && state.src) {
                            iframe.src = state.src;
                            if (state.srcdoc) iframe.srcdoc = state.srcdoc;
                        }
                    });
                    
                    // æ¢å¤canvas
                    originalStates.canvases.forEach((state, canvas) => {
                        if (canvas && state.dataUrl) {
                            try {
                                const img = new Image();
                                img.onload = () => {
                                    const ctx = canvas.getContext('2d');
                                    if (ctx) {
                                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                                        ctx.drawImage(img, 0, 0);
                                    }
                                };
                                img.src = state.dataUrl;
                            } catch (e) {
                                console.warn('æ¢å¤canvaså¤±è´¥:', e);
                            }
                        }
                    });
                    
                    // é‡ç½®ä¸ºåŸå§‹æ˜¾ç¤ºçŠ¶æ€
                    dayContents.forEach(function(content) {
                        content.classList.remove('active');
                    });
                    
                    // æ¢å¤ä¹‹å‰æ´»è·ƒçš„æ ‡ç­¾é¡µ
                    activeContents.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.classList.add('active');
                    });
                    
                    activeTabs.forEach(id => {
                        if (!id) return;
                        const selector = `[data-day="${id}"], [data-food-day="${id}"]`;
                        const el = document.querySelector(selector);
                        if (el) el.classList.add('active');
                    });
                    
                    // æ¢å¤æ˜¾ç¤ºå¯¼å‡ºå·¥å…·
                    exportTool.style.display = 'block';
                    exportToolButton.style.display = 'block';
                    
                    showExportLoading(false);
                    showExportStatus('æˆªå›¾å¤±è´¥ï¼Œè¯·å°è¯•ä½¿ç”¨æ‰“å°åŠŸèƒ½å¯¼å‡ºä¸ºPDFã€‚', 'error');
                    
                    // æ˜¾ç¤ºå¤‡ç”¨æ–¹æ¡ˆ
                    showPrintAlternative();
                }
                            } catch (err) {
                    console.error('å‡†å¤‡æˆªå›¾å¤±è´¥:', err);
                    showExportLoading(false);
                    showExportStatus('å‡†å¤‡æˆªå›¾å¤±è´¥ï¼Œè¯·å°è¯•ä½¿ç”¨æ‰“å°åŠŸèƒ½ã€‚', 'error');
                    
                    // æ¢å¤æ‰€æœ‰åŸå§‹å…ƒç´ çŠ¶æ€
                    if (originalStates) {
                        // æ¢å¤å›¾ç‰‡
                        if (originalStates.images) {
                            originalStates.images.forEach((state, img) => {
                                if (img && state.src) {
                                    img.src = state.src;
                                    if (state.width) img.width = state.width;
                                    if (state.height) img.height = state.height;
                                }
                            });
                        }
                        
                        // æ¢å¤èƒŒæ™¯å›¾ç‰‡
                        if (originalStates.backgroundElements) {
                            originalStates.backgroundElements.forEach((state, el) => {
                                if (el && state.cssText) {
                                    el.style.cssText = state.cssText;
                                }
                            });
                        }
                        
                        // æ¢å¤iframe
                        if (originalStates.iframes) {
                            originalStates.iframes.forEach((state, iframe) => {
                                if (iframe && state.src) {
                                    iframe.src = state.src;
                                    if (state.srcdoc) iframe.srcdoc = state.srcdoc;
                                }
                            });
                        }
                        
                        // æ¢å¤canvas
                        if (originalStates.canvases) {
                            originalStates.canvases.forEach((state, canvas) => {
                                if (canvas && state.dataUrl) {
                                    try {
                                        const img = new Image();
                                        img.onload = () => {
                                            const ctx = canvas.getContext('2d');
                                            if (ctx) {
                                                ctx.clearRect(0, 0, canvas.width, canvas.height);
                                                ctx.drawImage(img, 0, 0);
                                            }
                                        };
                                        img.src = state.dataUrl;
                                    } catch (e) {
                                        console.warn('æ¢å¤canvaså¤±è´¥:', e);
                                    }
                                }
                            });
                        }
                    }
                    
                    // æ¢å¤æ˜¾ç¤ºå¯¼å‡ºå·¥å…·
                const exportTool = document.getElementById('export-tool');
                const exportToolButton = document.getElementById('show-export-tool');
                if (exportTool) exportTool.style.display = 'block';
                if (exportToolButton) exportToolButton.style.display = 'block';
                
                // æ˜¾ç¤ºå¤‡ç”¨æ–¹æ¡ˆ
                showPrintAlternative();
            }
        }
        
        // å¯¼å‡ºæ‰€æœ‰æ ‡ç­¾é¡µå¤„ç†å‡½æ•°
        async function handleCaptureAllTabsClick() {
            showExportLoading(true);
            showExportStatus('æ­£åœ¨å‡†å¤‡å…¨éƒ¨å†…å®¹PDFå¯¼å‡ºï¼Œè¯·ç¨å€™...', 'info');
            
            try {
                // æš‚æ—¶éšè—å¯¼å‡ºå·¥å…·
                const exportTool = document.getElementById('export-tool');
                const exportToolButton = document.getElementById('show-export-tool');
                exportTool.style.display = 'none';
                exportToolButton.style.display = 'none';
                
                // è·å–æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹å…ƒç´ 
                const dayContents = document.querySelectorAll('.day-content');
                
                // å¤‡ä»½å½“å‰æ¿€æ´»çŠ¶æ€
                const activeContents = Array.from(document.querySelectorAll('.day-content.active')).map(el => el.id);
                const activeTabs = Array.from(document.querySelectorAll('.tab-item.active')).map(el => {
                    return el.getAttribute('data-day') || el.getAttribute('data-food-day');
                });
                
                // ä½¿æ‰€æœ‰å†…å®¹å¯è§ä»¥ä¾¿æ‰“å°
                dayContents.forEach(function(content) {
                    content.classList.add('active');
                });
                
                // æ·»åŠ ä¸´æ—¶æ‰“å°æ ·å¼
                const printStyle = document.createElement('style');
                printStyle.id = 'temp-print-style';
                printStyle.textContent = `
                    @media print {
                        body * {
                            visibility: visible !important;
                            display: block !important;
                        }
                        .day-content {
                            display: block !important;
                            opacity: 1 !important;
                            height: auto !important;
                            overflow: visible !important;
                            margin-bottom: 30px !important;
                            page-break-after: always;
                        }
                        #export-tool, #show-export-tool, .api-notice, #map-loading, .search-container, .search-filter-btn, .search-reset-btn {
                            display: none !important;
                        }
                        .tab-item {
                            border-bottom: none !important;
                            color: #333 !important;
                            font-weight: normal !important;
                        }
                        .tab-item.active {
                            color: #FF6B00 !important;
                            font-weight: bold !important;
                        }
                        @page {
                            size: A4;
                            margin: 1cm;
                        }
                        .day-content::before {
                            font-weight: bold;
                            font-size: 20px;
                            margin-bottom: 15px;
                            display: block;
                            border-bottom: 2px solid #FF6B00;
                            padding-bottom: 10px;
                            color: #FF6B00;
                        }
                        #day1::before { content: "ç¬¬ä¸€å¤©è¡Œç¨‹"; }
                        #day2::before { content: "ç¬¬äºŒå¤©è¡Œç¨‹"; }
                        #day3::before { content: "ç¬¬ä¸‰å¤©è¡Œç¨‹"; }
                        #food1::before { content: "ç¬¬ä¸€å¤©ç¾é£Ÿ"; }
                        #food2::before { content: "ç¬¬äºŒå¤©ç¾é£Ÿ"; }
                        #food3::before { content: "ç¬¬ä¸‰å¤©ç¾é£Ÿ"; }
                    }
                `;
                document.head.appendChild(printStyle);
                
                // æ˜¾ç¤ºæ›¿ä»£è§£å†³æ–¹æ¡ˆçš„è¯´æ˜
                const alternativeSolution = document.createElement('div');
                alternativeSolution.style.position = 'fixed';
                alternativeSolution.style.top = '50%';
                alternativeSolution.style.left = '50%';
                alternativeSolution.style.transform = 'translate(-50%, -50%)';
                alternativeSolution.style.backgroundColor = 'white';
                alternativeSolution.style.padding = '20px';
                alternativeSolution.style.borderRadius = '10px';
                alternativeSolution.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
                alternativeSolution.style.zIndex = '10000';
                alternativeSolution.style.maxWidth = '600px';
                alternativeSolution.style.width = '90%';
                alternativeSolution.innerHTML = `
                    <h3 style="color: #FF6B00; margin-top: 0;">å®Œæ•´è¡Œç¨‹PDFå¯¼å‡ºæŒ‡å—</h3>
                    <p>æˆ‘ä»¬å°†ä¸ºæ‚¨ç”Ÿæˆä¸€ä»½åŒ…å«æ‰€æœ‰è¡Œç¨‹å’Œç¾é£Ÿå†…å®¹çš„PDFæ–‡æ¡£ï¼š</p>
                    <ol>
                        <li>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå°†æ‰“å¼€æµè§ˆå™¨çš„æ‰“å°å¯¹è¯æ¡†</li>
                        <li>åœ¨æ‰“å°å¯¹è¯æ¡†ä¸­ï¼Œé€‰æ‹©"ä¿å­˜ä¸ºPDF"é€‰é¡¹ï¼ˆè€Œä¸æ˜¯å®é™…æ‰“å°ï¼‰</li>
                        <li>ç¡®ä¿é€‰æ‹©"èƒŒæ™¯å›¾å½¢"é€‰é¡¹ä»¥ä¿ç•™æ‰€æœ‰å›¾ç‰‡å’Œé¢œè‰²</li>
                        <li>å†…å®¹å·²ä¼˜åŒ–ä¸ºæ¯ä¸ªè¡Œç¨‹éƒ¨åˆ†è‡ªåŠ¨åˆ†é¡µï¼Œä¾¿äºé˜…è¯»</li>
                        <li>ç‚¹å‡»"ä¿å­˜"ï¼Œé€‰æ‹©ä¿å­˜ä½ç½®</li>
                    </ol>
                    <p>è¿™æ ·æ‚¨å°†è·å¾—ä¸€ä»½ç²¾ç¾çš„ã€å®Œæ•´çš„å¦é—¨æ—…æ¸¸æŒ‡å—PDFï¼Œæ–¹ä¾¿éšæ—¶æŸ¥é˜…ã€‚</p>
                    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                        <button id="proceed-to-print-all" style="background-color: #FF6B00; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1; margin-right: 10px;">ç»§ç»­å¯¼å‡ºPDF</button>
                        <button id="cancel-print-all" style="background-color: #999; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1; margin-left: 10px;">å–æ¶ˆ</button>
                    </div>
                `;
                document.body.appendChild(alternativeSolution);
                
                // æ·»åŠ æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
                document.getElementById('proceed-to-print-all').addEventListener('click', function() {
                    // ç§»é™¤æç¤ºæ¡†
                    document.body.removeChild(alternativeSolution);
                    
                    // æ‰“å°
                    window.print();
                    
                    // æ¢å¤åŸå§‹çŠ¶æ€
                    document.head.removeChild(printStyle);
                    
                    // é‡ç½®ä¸ºåŸå§‹æ˜¾ç¤ºçŠ¶æ€
                    dayContents.forEach(function(content) {
                        content.classList.remove('active');
                    });
                    
                    // æ¢å¤ä¹‹å‰æ´»è·ƒçš„æ ‡ç­¾é¡µ
                    activeContents.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.classList.add('active');
                    });
                    
                    activeTabs.forEach(id => {
                        if (!id) return;
                        const selector = `[data-day="${id}"], [data-food-day="${id}"]`;
                        const el = document.querySelector(selector);
                        if (el) el.classList.add('active');
                    });
                    
                    // æ¢å¤æ˜¾ç¤ºå¯¼å‡ºå·¥å…·
                    exportTool.style.display = 'block';
                    exportToolButton.style.display = 'block';
                    
                    showExportLoading(false);
                    showExportStatus('PDFå¯¼å‡ºå®Œæˆï¼', 'success');
                });
                
                document.getElementById('cancel-print-all').addEventListener('click', function() {
                    // ç§»é™¤æç¤ºæ¡†
                    document.body.removeChild(alternativeSolution);
                    
                    // ç§»é™¤ä¸´æ—¶æ ·å¼
                    if (document.getElementById('temp-print-style')) {
                        document.head.removeChild(printStyle);
                    }
                    
                    // é‡ç½®ä¸ºåŸå§‹æ˜¾ç¤ºçŠ¶æ€
                    dayContents.forEach(function(content) {
                        content.classList.remove('active');
                    });
                    
                    // æ¢å¤ä¹‹å‰æ´»è·ƒçš„æ ‡ç­¾é¡µ
                    activeContents.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.classList.add('active');
                    });
                    
                    activeTabs.forEach(id => {
                        if (!id) return;
                        const selector = `[data-day="${id}"], [data-food-day="${id}"]`;
                        const el = document.querySelector(selector);
                        if (el) el.classList.add('active');
                    });
                    
                    // æ¢å¤æ˜¾ç¤ºå¯¼å‡ºå·¥å…·
                    exportTool.style.display = 'block';
                    exportToolButton.style.display = 'block';
                    
                    showExportLoading(false);
                    showExportStatus('å·²å–æ¶ˆPDFå¯¼å‡º', 'info');
                });
            } catch (err) {
                console.error('å‡†å¤‡å¯¼å‡ºPDFå¤±è´¥:', err);
                showExportLoading(false);
                showExportStatus('å‡†å¤‡å¯¼å‡ºPDFå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚', 'error');
                
                // æ¢å¤æ˜¾ç¤ºå¯¼å‡ºå·¥å…·
                const exportTool = document.getElementById('export-tool');
                const exportToolButton = document.getElementById('show-export-tool');
                if (exportTool) exportTool.style.display = 'block';
                if (exportToolButton) exportToolButton.style.display = 'block';
            }
        }
    </script>
    
    <!-- å¯¼å‡ºå·¥å…· -->
    <div id="export-tool" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; overflow-y: auto;">
        <div style="max-width: 800px; margin: 20px auto; background: white; border-radius: 10px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #FF6B00; margin: 0;">å¦é—¨æ—…æ¸¸æŒ‡å—å¯¼å‡ºå·¥å…·</h2>
                <button id="close-export-tool" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <div id="export-status" style="padding: 10px; margin: 10px 0; border-radius: 5px; display: none;"></div>
            
            <div style="margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                <h3 style="color: #0084FF; margin-bottom: 15px;">1. æ§åˆ¶å†…å®¹æ˜¾ç¤º</h3>
                <div style="background-color: #fff8e1; padding: 15px; border-left: 4px solid #FFB800; margin: 20px 0; border-radius: 0 5px 5px 0;">
                    <p>ä½¿ç”¨ä¸‹é¢çš„æŒ‰é’®æ§åˆ¶æ—…æ¸¸æŒ‡å—é¡µé¢ä¸­æ˜¾ç¤ºçš„å†…å®¹ã€‚æ‚¨å¯ä»¥æ˜¾ç¤ºç‰¹å®šå¤©æ•°çš„è¡Œç¨‹æˆ–ç¾é£Ÿï¼Œæˆ–æ˜¾ç¤ºæ‰€æœ‰å†…å®¹ã€‚</p>
                </div>
                
                <button id="show-all-btn" style="background-color: #FF6B00; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 0; display: block; width: 100%;">æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹</button>
                <button id="reset-btn" style="background-color: #999; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 0; display: block; width: 100%;">æ¢å¤é»˜è®¤æ˜¾ç¤º</button>
                
                <h4 style="margin-top: 20px;">è¡Œç¨‹å†…å®¹æ§åˆ¶</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;">
                    <button id="day1-btn" style="flex: 1; background-color: #0084FF; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; min-width: 120px;">ç¬¬ä¸€å¤©è¡Œç¨‹</button>
                    <button id="day2-btn" style="flex: 1; background-color: #0084FF; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; min-width: 120px;">ç¬¬äºŒå¤©è¡Œç¨‹</button>
                    <button id="day3-btn" style="flex: 1; background-color: #0084FF; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; min-width: 120px;">ç¬¬ä¸‰å¤©è¡Œç¨‹</button>
                </div>
                
                <h4 style="margin-top: 20px;">ç¾é£Ÿå†…å®¹æ§åˆ¶</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;">
                    <button id="food1-btn" style="flex: 1; background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; min-width: 120px;">ç¬¬ä¸€å¤©ç¾é£Ÿ</button>
                    <button id="food2-btn" style="flex: 1; background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; min-width: 120px;">ç¬¬äºŒå¤©ç¾é£Ÿ</button>
                    <button id="food3-btn" style="flex: 1; background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; min-width: 120px;">ç¬¬ä¸‰å¤©ç¾é£Ÿ</button>
                </div>
            </div>
            
            <div>
                <h3 style="color: #0084FF; margin-bottom: 15px;">2. å¯¼å‡ºå†…å®¹</h3>
                <div style="background-color: #fff8e1; padding: 15px; border-left: 4px solid #FFB800; margin: 20px 0; border-radius: 0 5px 5px 0;">
                    <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯æŸ¥çœ‹å…¨æ–‡å†…å®¹ï¼Œä¾¿äºä½¿ç”¨FireShotè¿›è¡Œå…¨æ–‡æˆªå±ï¼š</p>
                </div>
                
                <button id="show-all-btn" style="background-color: #0084FF; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 0; display: block; width: 100%;">æ˜¾ç¤ºå…¨æ–‡å†…å®¹</button>
                
                <div id="export-loading" style="display: none; text-align: center; padding: 20px;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(255, 107, 0, 0.3); border-radius: 50%; border-top-color: #FF6B00; animation: spin 1s ease-in-out infinite;"></div>
                    <p>æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...</p>
                </div>
                
                <div id="export-result" style="margin-top: 20px; display: none;">
                    <h3>å¯¼å‡ºç»“æœï¼š</h3>
                    <div id="export-download-links"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å¯¼å‡ºå·¥å…·æŒ‰é’® -->
    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 9998;">
        <button id="show-export-tool" style="background-color: #FF6B00; color: white; border: none; width: 60px; height: 60px; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.3); font-size: 24px;">
            <i class='bx bx-export'></i>
        </button>
    </div>
    
    <!-- å¯¼å‡ºå·¥å…·è„šæœ¬ -->
    <script>
        // ç­‰å¾…DOMå®Œå…¨åŠ è½½åå†åˆå§‹åŒ–å¯¼å‡ºå·¥å…·
        document.addEventListener('DOMContentLoaded', function() {
            // é˜²æ­¢é‡å¤åˆå§‹åŒ–
            if (!window.exportToolInitialized) {
                window.exportToolInitialized = true;
                initExportTool();
                
                // åˆå§‹åŒ–å¯¼å‡ºæŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
                initExportButtonListeners();
            }
        });
        
        // åˆå§‹åŒ–å¯¼å‡ºå·¥å…·
        function initExportTool() {
            // æ£€æŸ¥å¿…è¦çš„å…ƒç´ æ˜¯å¦å­˜åœ¨
            const showExportToolBtn = document.getElementById('show-export-tool');
            const closeExportToolBtn = document.getElementById('close-export-tool');
            const showAllBtn = document.getElementById('show-all-btn');
            const resetBtn = document.getElementById('reset-btn');
            const day1Btn = document.getElementById('day1-btn');
            const day2Btn = document.getElementById('day2-btn');
            const day3Btn = document.getElementById('day3-btn');
            const food1Btn = document.getElementById('food1-btn');
            const food2Btn = document.getElementById('food2-btn');
            const food3Btn = document.getElementById('food3-btn');
            
            // ç¡®ä¿æ‰€æœ‰å¿…è¦å…ƒç´ éƒ½å­˜åœ¨
            if (!showExportToolBtn || !closeExportToolBtn || !showAllBtn || !resetBtn || 
                !day1Btn || !day2Btn || !day3Btn || !food1Btn || !food2Btn || !food3Btn) {
                console.error('å¯¼å‡ºå·¥å…·åˆå§‹åŒ–å¤±è´¥ï¼šæ— æ³•æ‰¾åˆ°å¿…è¦çš„DOMå…ƒç´ ');
                return;
            }
            
            // æ˜¾ç¤º/éšè—å¯¼å‡ºå·¥å…·
            showExportToolBtn.addEventListener('click', function() {
                document.getElementById('export-tool').style.display = 'block';
            });
            
            closeExportToolBtn.addEventListener('click', function() {
                document.getElementById('export-tool').style.display = 'none';
            });
            
            // æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            showAllBtn.addEventListener('click', function() {
                try {
                    // è·å–æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹å…ƒç´ 
                    const dayContents = document.querySelectorAll('.day-content');
                    
                    // ä½¿æ‰€æœ‰å†…å®¹å¯è§
                    dayContents.forEach(function(content) {
                        content.classList.add('active');
                    });
                    
                    showExportStatus('æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹å·²æ˜¾ç¤ºï¼Œç°åœ¨å¯ä»¥æˆªå›¾æˆ–æ‰“å°é¡µé¢äº†ï¼', 'success');
                } catch (err) {
                    console.error('æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹å¤±è´¥:', err);
                    showExportStatus('æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚', 'error');
                }
            });
            
            // æ¢å¤é»˜è®¤æ˜¾ç¤º
            resetBtn.addEventListener('click', function() {
                try {
                    // è·å–æ‰€æœ‰æ ‡ç­¾é¡µå’Œå†…å®¹å…ƒç´ 
                    const dayTabs = document.querySelectorAll('.tab-item');
                    const dayContents = document.querySelectorAll('.day-content');
                    
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    dayTabs.forEach(function(tab) {
                        tab.classList.remove('active');
                    });
                    
                    dayContents.forEach(function(content) {
                        content.classList.remove('active');
                    });
                    
                    // è®¾ç½®ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µä¸ºæ´»åŠ¨çŠ¶æ€
                    const firstDayTab = document.querySelector('.tab-item[data-day="day1"]');
                    const firstFoodTab = document.querySelector('.tab-item[data-food-day="food1"]');
                    const firstDayContent = document.getElementById('day1');
                    const firstFoodContent = document.getElementById('food1');
                    
                    if (firstDayTab) firstDayTab.classList.add('active');
                    if (firstFoodTab) firstFoodTab.classList.add('active');
                    if (firstDayContent) firstDayContent.classList.add('active');
                    if (firstFoodContent) firstFoodContent.classList.add('active');
                    
                    showExportStatus('å·²æ¢å¤é»˜è®¤æ˜¾ç¤ºçŠ¶æ€ï¼', 'success');
                } catch (err) {
                    console.error('æ¢å¤é»˜è®¤æ˜¾ç¤ºå¤±è´¥:', err);
                    showExportStatus('æ¢å¤é»˜è®¤æ˜¾ç¤ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚', 'error');
                }
            });
            
            // ç»‘å®šè¡Œç¨‹æŒ‰é’®äº‹ä»¶
            day1Btn.addEventListener('click', function() {
                showSpecificDay('day1');
            });
            
            day2Btn.addEventListener('click', function() {
                showSpecificDay('day2');
            });
            
            day3Btn.addEventListener('click', function() {
                showSpecificDay('day3');
            });
            
            // ç»‘å®šç¾é£ŸæŒ‰é’®äº‹ä»¶
            food1Btn.addEventListener('click', function() {
                showSpecificFood('food1');
            });
            
            food2Btn.addEventListener('click', function() {
                showSpecificFood('food2');
            });
            
            food3Btn.addEventListener('click', function() {
                showSpecificFood('food3');
            });
            
            // åˆ é™¤ä¸éœ€è¦çš„å¯¼å‡ºåŠŸèƒ½ç›‘å¬å™¨
        }
        
        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showExportStatus(message, type = 'info') {
            const statusEl = document.getElementById('export-status');
            if (!statusEl) return;
            
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            // è®¾ç½®ä¸åŒç±»å‹çš„æ ·å¼
            if (type === 'success') {
                statusEl.style.backgroundColor = '#e8f5e9';
                statusEl.style.color = '#2e7d32';
                statusEl.style.borderLeft = '4px solid #2e7d32';
            } else if (type === 'error') {
                statusEl.style.backgroundColor = '#ffebee';
                statusEl.style.color = '#c62828';
                statusEl.style.borderLeft = '4px solid #c62828';
            } else {
                statusEl.style.backgroundColor = '#e3f2fd';
                statusEl.style.color = '#1565c0';
                statusEl.style.borderLeft = '4px solid #1565c0';
            }
            
            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
        
        // æ˜¾ç¤ºåŠ è½½ä¸­
        function showExportLoading(show = true) {
            const loadingEl = document.getElementById('export-loading');
            if (!loadingEl) return;
            loadingEl.style.display = show ? 'block' : 'none';
        }
        
        // æ˜¾ç¤ºç‰¹å®šå¤©çš„è¡Œç¨‹
        function showSpecificDay(dayId) {
            try {
                // è·å–æ‰€æœ‰è¡Œç¨‹æ ‡ç­¾é¡µå’Œå†…å®¹
                const dayTabs = document.querySelectorAll('.tab-item[data-day]');
                const dayContents = document.querySelectorAll('.itinerary .day-content');
                
                // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                dayTabs.forEach(function(tab) {
                    tab.classList.remove('active');
                });
                
                dayContents.forEach(function(content) {
                    content.classList.remove('active');
                });
                
                // è®¾ç½®æŒ‡å®šæ ‡ç­¾é¡µä¸ºæ´»åŠ¨çŠ¶æ€
                const targetTab = document.querySelector(`.tab-item[data-day="${dayId}"]`);
                const targetContent = document.getElementById(dayId);
                
                if (targetTab) targetTab.classList.add('active');
                if (targetContent) targetContent.classList.add('active');
                
                // æ»šåŠ¨åˆ°è¡Œç¨‹éƒ¨åˆ†
                const itinerary = document.querySelector('.itinerary');
                if (itinerary) {
                    itinerary.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
                
                showExportStatus(`å·²æ˜¾ç¤º${targetTab ? targetTab.textContent : ''}è¡Œç¨‹å†…å®¹`, 'success');
            } catch (err) {
                console.error('æ˜¾ç¤ºç‰¹å®šå¤©è¡Œç¨‹å¤±è´¥:', err);
                showExportStatus('æ˜¾ç¤ºç‰¹å®šå¤©è¡Œç¨‹å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚', 'error');
            }
        }
        
        // æ˜¾ç¤ºç‰¹å®šå¤©çš„ç¾é£Ÿ
        function showSpecificFood(foodId) {
            try {
                // è·å–æ‰€æœ‰ç¾é£Ÿæ ‡ç­¾é¡µå’Œå†…å®¹
                const foodTabs = document.querySelectorAll('.tab-item[data-food-day]');
                const foodContents = document.querySelectorAll('.food-card .day-content');
                
                // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                foodTabs.forEach(function(tab) {
                    tab.classList.remove('active');
                });
                
                foodContents.forEach(function(content) {
                    content.classList.remove('active');
                });
                
                // è®¾ç½®æŒ‡å®šæ ‡ç­¾é¡µä¸ºæ´»åŠ¨çŠ¶æ€
                const targetTab = document.querySelector(`.tab-item[data-food-day="${foodId}"]`);
                const targetContent = document.getElementById(foodId);
                
                if (targetTab) targetTab.classList.add('active');
                if (targetContent) targetContent.classList.add('active');
                
                // æ»šåŠ¨åˆ°ç¾é£Ÿéƒ¨åˆ†
                const foodCard = document.querySelector('.food-card');
                if (foodCard) {
                    foodCard.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
                
                showExportStatus(`å·²æ˜¾ç¤º${targetTab ? targetTab.textContent : ''}ç¾é£Ÿå†…å®¹`, 'success');
            } catch (err) {
                console.error('æ˜¾ç¤ºç‰¹å®šå¤©ç¾é£Ÿå¤±è´¥:', err);
                showExportStatus('æ˜¾ç¤ºç‰¹å®šå¤©ç¾é£Ÿå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚', 'error');
            }
        }

        // åŠ è½½html2canvasåº“
        function loadHtml2Canvas() {
            return new Promise((resolve, reject) => {
                if (window.html2canvas) {
                    resolve(window.html2canvas);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
                script.onload = () => resolve(window.html2canvas);
                script.onerror = () => reject(new Error('Failed to load html2canvas'));
                document.head.appendChild(script);
            });
        }
        
        // é€ä¸ªå¤„ç†æ ‡ç­¾é¡µ
        async function processNextTab(tabs, index, originalActiveItems, originalActiveContents, html2canvas) {
            if (index >= tabs.length) {
                // æ¢å¤åŸå§‹æ´»åŠ¨æ ‡ç­¾
                originalActiveItems.forEach(item => item.classList.add('active'));
                originalActiveContents.forEach(content => content.classList.add('active'));
                
                showExportLoading(false);
                showExportStatus('æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹å¯¼å‡ºå®Œæˆï¼', 'success');
                return;
            }
            
            const currentTab = tabs[index];
            const tabName = currentTab.textContent.trim();
            
            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.day-content').forEach(content => content.classList.remove('active'));
            
            // æ¿€æ´»å½“å‰æ ‡ç­¾
            currentTab.classList.add('active');
            
            // è·å–å…³è”çš„å†…å®¹ID
            const dayId = currentTab.getAttribute('data-day');
            const foodDayId = currentTab.getAttribute('data-food-day');
            const contentId = dayId || foodDayId;
            
            if (contentId) {
                const content = document.getElementById(contentId);
                if (content) {
                    content.classList.add('active');
                }
            }
            
            // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿DOMæ›´æ–°
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // ç¡®å®šè¦æˆªå›¾çš„å…ƒç´ 
            let targetElement;
            if (dayId) {
                targetElement = document.querySelector('.itinerary');
            } else if (foodDayId) {
                targetElement = document.querySelector('.food-card');
            } else {
                // å¦‚æœæ— æ³•ç¡®å®šå…ƒç´ ï¼Œè·³åˆ°ä¸‹ä¸€ä¸ª
                await processNextTab(tabs, index + 1, originalActiveItems, originalActiveContents, html2canvas);
                return;
            }
            
            try {
                // å¤„ç†æœ¬åœ°å›¾ç‰‡è·¨åŸŸé—®é¢˜
                const images = targetElement.querySelectorAll('img');
                const originalSrcs = [];
                
                // å¤‡ä»½åŸå§‹å›¾ç‰‡è·¯å¾„å¹¶æ›¿æ¢ä¸ºå ä½ç¬¦
                for (let i = 0; i < images.length; i++) {
                    originalSrcs.push(images[i].src);
                    if (images[i].src.startsWith('file://') || images[i].src.includes('image/')) {
                        // æ›¿æ¢ä¸ºå ä½å›¾ç‰‡
                        images[i].setAttribute('data-original-src', images[i].src);
                        images[i].src = 'data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22' + 
                                      (images[i].width || 300) + '%22%20height%3D%22' + (images[i].height || 200) + 
                                      '%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23f5f5f5%22%2F%3E%3Ctext%20x%3D%2250%25%22%20' + 
                                      'y%3D%2250%25%22%20dominant-baseline%3D%22middle%22%20text-anchor%3D%22middle%22%20font-family%3D%22Arial%22%20font-size%3D%2214%22%20fill%3D%22%23999%22%3E' + 
                                      images[i].alt + '%3C%2Ftext%3E%3C%2Fsvg%3E';
                    }
                }
                
                // æ•è·å½“å‰æ ‡ç­¾é¡µå†…å®¹
                const canvas = await html2canvas(targetElement, {
                    allowTaint: false,
                    useCORS: true,
                    scale: 1,
                    logging: true,
                    backgroundColor: '#ffffff',
                    foreignObjectRendering: false,
                    removeContainer: true
                });
                
                // æ¢å¤åŸå§‹å›¾ç‰‡è·¯å¾„
                for (let i = 0; i < images.length; i++) {
                    if (images[i].hasAttribute('data-original-src')) {
                        images[i].src = images[i].getAttribute('data-original-src');
                        images[i].removeAttribute('data-original-src');
                    }
                }
                
                try {
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const downloadLink = document.createElement('a');
                    downloadLink.href = canvas.toDataURL('image/png');
                    downloadLink.download = `å¦é—¨æ—…æ¸¸æŒ‡å—_${tabName}.png`;
                    downloadLink.textContent = `ä¸‹è½½${tabName}å†…å®¹æˆªå›¾`;
                    downloadLink.style.display = 'block';
                    downloadLink.style.margin = '10px 0';
                    downloadLink.style.padding = '8px';
                    downloadLink.style.backgroundColor = '#0084FF';
                    downloadLink.style.color = 'white';
                    downloadLink.style.textDecoration = 'none';
                    downloadLink.style.borderRadius = '5px';
                    downloadLink.style.textAlign = 'center';
                    
                    // æ·»åŠ åˆ°ä¸‹è½½åŒºåŸŸ
                    const downloadLinks = document.getElementById('export-download-links');
                    if (downloadLinks) {
                        downloadLinks.appendChild(downloadLink);
                    }
                } catch (err) {
                    console.error(`${tabName}æˆªå›¾ç”ŸæˆæˆåŠŸï¼Œä½†æ— æ³•åˆ›å»ºä¸‹è½½é“¾æ¥:`, err);
                    
                    // æ˜¾ç¤ºæˆªå›¾ç»“æœ
                    const imgContainer = document.createElement('div');
                    imgContainer.style.maxWidth = '100%';
                    imgContainer.style.overflow = 'auto';
                    imgContainer.style.border = '1px solid #ddd';
                    imgContainer.style.padding = '10px';
                    imgContainer.style.marginTop = '10px';
                    imgContainer.appendChild(canvas);
                    
                    const downloadLinks = document.getElementById('export-download-links');
                    if (downloadLinks) {
                        downloadLinks.appendChild(document.createTextNode(`${tabName}å†…å®¹æˆªå›¾ï¼ˆå³é”®ç‚¹å‡»å¹¶é€‰æ‹©"å›¾ç‰‡å¦å­˜ä¸º"ä¿å­˜ï¼‰ï¼š`));
                        downloadLinks.appendChild(imgContainer);
                    }
                }
            } catch (err) {
                console.error(`${tabName}æˆªå›¾å¤±è´¥:`, err);
                
                // æ¢å¤åŸå§‹å›¾ç‰‡è·¯å¾„
                const images = targetElement.querySelectorAll('img');
                for (let i = 0; i < images.length; i++) {
                    if (images[i].hasAttribute('data-original-src')) {
                        images[i].src = images[i].getAttribute('data-original-src');
                        images[i].removeAttribute('data-original-src');
                    }
                }
            }
            
            // å¤„ç†ä¸‹ä¸€ä¸ªæ ‡ç­¾é¡µ
            await processNextTab(tabs, index + 1, originalActiveItems, originalActiveContents, html2canvas);
        }
        
        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html> 