<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>厦门旅行指南 - 探索、发现、享受</title>
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <style>
        :root {
            --primary: #FF6B00;
            --secondary: #0084FF;
            --accent: #FFB800;
            --bg-light: #FAFAFA;
            --text-dark: #333333;
            --text-light: #777777;
            --shadow: 0 10px 20px rgba(0,0,0,0.05);
            --radius: 16px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .logo {
            color: var(--primary);
            font-size: 1.8rem;
            margin-right: 10px;
        }
        
        h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-auto-rows: minmax(100px, auto);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .highlight {
            background: linear-gradient(135deg, rgba(255,107,0,0.1) 0%, rgba(255,184,0,0.1) 100%);
            border-left: 4px solid var(--primary);
        }
        
        .hero {
            grid-column: span 8;
            grid-row: span 3;
            background-image: url('image/xiamen/background.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            position: relative;
        }
        
        .hero::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70%;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
            z-index: 1;
        }
        
        .hero-content {
            position: relative;
            z-index: 2;
        }
        
        .hero h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .tag {
            display: inline-block;
            padding: 6px 12px;
            background-color: var(--primary);
            color: white;
            border-radius: 50px;
            font-size: 0.8rem;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .info {
            grid-column: span 4;
            grid-row: span 3;
        }
        
        .map-card {
            grid-column: span 6;
            grid-row: span 3;
            position: relative;
            overflow: hidden;
            padding: 0;
        }
        
        #map-container {
            width: 100%;
            height: 100%;
            min-height: 400px;
        }
        
        /* 地图覆盖物样式 */
        .map-overlay {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: var(--radius);
            padding: 15px;
            margin: 15px;
            width: calc(100% - 30px);
            position: absolute;
            bottom: 10px;
            left: 0;
            z-index: 10;
            box-shadow: var(--shadow);
        }
        
        .map-overlay h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: var(--primary);
        }
        
        .map-overlay p {
            margin: 0;
            line-height: 1.5;
        }
        
        .location-tag {
            display: inline-block;
            cursor: pointer;
            color: var(--primary);
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .location-tag:hover {
            color: var(--accent);
            text-decoration: underline;
        }
        
        /* 移除地图切换按钮样式 */
        
        /* 信息窗口样式 */
        .info-window {
            padding: 10px;
            max-width: 250px;
        }
        
        .info-window h4 {
            margin: 0 0 8px 0;
            color: var(--primary);
            font-size: 16px;
        }
        
        .time-display {
            text-align: center;
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(255, 107, 0, 0.05);
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
        }
        
        .current-time {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .search-container {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 10;
            display: flex;
            width: calc(100% - 30px);
            max-width: 400px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: var(--radius) 0 0 var(--radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        .search-button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 0 var(--radius) var(--radius) 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .search-button:hover {
            background-color: #e05d00;
        }
        
        .search-options {
            position: absolute;
            top: 50px;
            left: 0;
            width: 100%;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 10px 0;
            display: none;
            z-index: 20;
        }
        
        .search-options.active {
            display: block;
        }
        
        .search-option {
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .search-option:hover {
            background-color: #f5f5f5;
        }
        
        .search-option i {
            margin-right: 8px;
            color: var(--primary);
        }
        
        .search-filter-btn {
            position: absolute;
            top: 10px;
            right: 60px;
            background-color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10;
            transition: background-color 0.3s;
        }
        
        .search-filter-btn:hover {
            background-color: #f5f5f5;
        }
        
        .search-filter-btn i {
            color: var(--primary);
            font-size: 18px;
        }
        
        .search-reset-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background-color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10;
            transition: all 0.3s;
        }
        
        .search-reset-btn:hover {
            background-color: #f5f5f5;
        }
        
        .search-reset-btn i {
            color: #ff4d4f;
            font-size: 18px;
        }
        
        .search-reset-btn.active {
            transform: rotate(180deg);
        }
        
        .itinerary {
            grid-column: span 6;
            grid-row: span 3;
        }
        
        .day-tab {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .tab-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab-item.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .day-content {
            display: none;
        }
        
        .day-content.active {
            display: block;
        }
        
        .icon-block {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .icon {
            color: var(--primary);
            font-size: 1.5rem;
            margin-right: 10px;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 107, 0, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .hotel-link {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
            transition: opacity 0.3s;
        }
        
        .hotel-link:hover {
            opacity: 0.8;
        }
        
        .tips {
            grid-column: span 4;
            grid-row: span 2;
        }
        
        .image-card {
            grid-column: span 4;
            grid-row: span 2;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .image-container {
            height: 70%;
            overflow: hidden;
        }
        
        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-content {
            padding: 15px;
            background-color: white;
            flex-grow: 1;
        }
        
        .footer-card {
            grid-column: span 12;
            text-align: center;
            padding: 15px;
            background-color: var(--primary);
            color: white;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }
        
        .timeline-item:before {
            content: '';
            position: absolute;
            left: -30px;
            top: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border: 2px solid white;
            box-shadow: 0 0 8px rgba(255, 107, 0, 0.4);
            z-index: 1;
            transform: scale(0.9);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .timeline-item:hover:before {
            transform: scale(1.1);
            box-shadow: 0 0 12px rgba(255, 107, 0, 0.6);
        }
        
        .timeline-item:after {
            content: '';
            position: absolute;
            left: -24px;
            top: 14px;
            width: 2px;
            height: calc(100% - 2px);
            background: linear-gradient(to bottom, var(--primary) 0%, rgba(255, 107, 0, 0.2) 100%);
            opacity: 0.7;
        }
        
        .timeline-item:last-child:after {
            display: none;
        }
        
        .timeline-time {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
            background: -webkit-linear-gradient(var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
            padding: 2px 0;
            position: relative;
        }
        
        h2 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            font-size: 1.4rem;
        }
        
        h2 i {
            margin-right: 10px;
            color: var(--primary);
        }
        
        .checklist {
            list-style: none;
        }
        
        .checklist li {
            padding: 8px 0;
            display: flex;
            align-items: flex-start;
        }
        
        .checklist i {
            color: var(--primary);
            margin-right: 10px;
            flex-shrink: 0;
            margin-top: 3px;
        }
        
        .weather-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .weather-day {
            text-align: center;
            flex: 1;
        }
        
        .weather-icon {
            font-size: 1.8rem;
            margin: 5px 0;
            color: var(--accent);
        }
        
        .temp {
            font-weight: 600;
        }
        
        @media (max-width: 1024px) {
            .bento-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .hero, .info, .map-card, .itinerary, .tips {
                grid-column: span 6;
            }
            
            .image-card {
                grid-column: span 3;
            }
            
            .footer-card {
                grid-column: span 6;
            }
        }
        
        @media (max-width: 768px) {
            .bento-grid {
                grid-template-columns: repeat(1, 1fr);
            }
            
            .hero, .info, .map-card, .itinerary, .tips, .image-card, .footer-card {
                grid-column: span 1;
            }
        }
        
        .api-notice {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #fff;
            border-radius: var(--radius);
            padding: 15px 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 800px;
            z-index: 1000;
            display: none;
        }
        
        .api-notice.active {
            display: block;
        }
        
        .api-notice h3 {
            margin: 0 0 10px 0;
            color: var(--primary);
            display: flex;
            align-items: center;
        }
        
        .api-notice h3 i {
            margin-right: 8px;
        }
        
        .api-notice p {
            margin: 8px 0;
            font-size: 14px;
        }
        
        .api-notice .code {
            background: #f5f5f5;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            margin: 8px 0;
            overflow-x: auto;
        }
        
        .api-notice .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #999;
            transition: color 0.3s;
        }
        
        .api-notice .close-btn:hover {
            color: var(--primary);
        }
        
        /* 天气加载状态样式 */
        .weather-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px;
        }
        
        .weather-loading i {
            color: var(--primary);
            animation: rotate 1s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* 天气错误状态样式 */
        .weather-error {
            color: #ff4d4f;
            font-size: 12px;
            text-align: center;
            padding: 5px;
        }
        
        /* 百度天气iframe容器样式 */
        .baidu-weather-wrapper {
            width: 100%;
            height: 160px; 
            overflow: hidden;
            border-radius: 10px;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        /* 搜索结果下拉列表样式 */
        .search-results {
            position: absolute;
            top: 50px;
            left: 0;
            width: 100%;
            max-height: 350px;
            overflow-y: auto;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
            z-index: 30;
        }
        
        .search-results.active {
            display: block;
        }
        
        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .search-result-item:hover {
            background-color: #f9f9f9;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-name {
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 3px;
        }
        
        .search-result-address {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .search-result-distance {
            font-size: 12px;
            color: var(--secondary);
            margin-top: 3px;
        }
        
        /* 位置提示样式 */
        .location-notice {
            animation: fadeInOut 3s ease-in-out;
            position: relative;
            z-index: 100;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            10% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        @media print {
            /* 打印时显示所有标签页内容 */
            .day-content {
                display: block !important;
                opacity: 1 !important;
                height: auto !important;
                overflow: visible !important;
            }
            
            /* 添加分页标记 */
            .itinerary, .food-card, .tips, .souvenir-card {
                page-break-inside: avoid;
                margin-bottom: 20px;
            }
            
            /* 隐藏不需要打印的元素 */
            .search-container, .search-filter-btn, .search-reset-btn, .map-overlay {
                display: none !important;
            }
            
            /* 确保地图区域有合适的高度 */
            .map-card {
                height: 400px;
                overflow: hidden;
            }
            
            /* 调整标签页样式 */
            .tab-item {
                border-bottom: none !important;
                font-weight: normal !important;
                color: var(--text-dark) !important;
            }
            
            .tab-item.active {
                font-weight: bold !important;
                color: var(--primary) !important;
            }
            
            /* 为每个标签页内容添加标题 */
            #day1::before, #day2::before, #day3::before,
            #food1::before, #food2::before, #food3::before {
                font-weight: bold;
                margin-bottom: 10px;
                display: block;
                border-bottom: 1px solid #eee;
                padding-bottom: 5px;
            }
            
            #day1::before { content: "第一天行程"; }
            #day2::before { content: "第二天行程"; }
            #day3::before { content: "第三天行程"; }
            #food1::before { content: "第一天美食"; }
            #food2::before { content: "第二天美食"; }
            #food3::before { content: "第三天美食"; }
        }
    </style>
</head>
<body>
    <header>
        <i class='bx bxs-plane-take-off logo'></i>
        <h1>厦门旅行指南</h1>
    </header>
    
    <div class="bento-grid">
        <!-- 英雄卡片 -->
        <div class="card hero">
            <div class="hero-content">
                <span class="tag">3天行程</span>
                <span class="tag">海岛风情</span>
                <h2>厦门 · 鼓浪屿之旅</h2>
                <p>探索环岛路的海岸风光、厦门大学的人文景致与鼓浪屿的异国风情</p>
            </div>
        </div>
        
        <!-- 行程概览信息卡片 -->
        <div class="card info">
            <h2><i class='bx bxs-info-circle'></i> 行程概览</h2>
            <div class="icon-block">
                <div class="icon"><i class='bx bxs-hotel'></i></div>
                <div>
                    <strong>住宿</strong>
                    <p class="hotel-link" id="hotel-location">厦门国际会展中心环岛路美居酒店</p>
                    <small>近黄厝沙滩，便于首日行程</small>
                </div>
            </div>
            <div class="icon-block">
                <div class="icon"><i class='bx bxs-car'></i></div>
                <div>
                    <strong>交通</strong>
                    <p>网约车 + 骑行</p>
                    <small>打车费用日均约50元</small>
                </div>
            </div>
            <div class="icon-block">
                <div class="icon"><i class='bx bxs-receipt'></i></div>
                <div>
                    <strong>门票预约</strong>
                    <p>鼓浪屿船票、厦门大学</p>
                    <small class="highlight">需提前预约！</small>
                </div>
            </div>
            <div class="icon-block">
                <div class="icon"><i class='bx bxs-sun'></i></div>
                <div>
                    <strong>厦门天气</strong>
                    <p id="current-weather-text">加载中...</p>
                </div>
            </div>
            <div class="weather-container" id="weather-container" style="margin-bottom: 15px;">
                <div class="weather-loading">
                    <i class='bx bx-loader'></i>
                </div>
            </div>
            <div class="time-display">
                <div class="current-time">当前时间</div>
            </div>
        </div>
        
        <!-- 地图卡片 -->
        <div class="card map-card">
            <div id="map-container">
                <div id="map-loading" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; color: var(--primary); margin-bottom: 10px;">
                            <i class='bx bx-loader-alt bx-spin' style="font-size: 36px;"></i>
                        </div>
                        <div>地图加载中，请稍候...</div>
                    </div>
                </div>
            </div>
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="搜索厦门的地点..." />
                <button id="search-button" class="search-button">
                    <i class='bx bx-search'></i>
                </button>
                <div class="search-options" id="search-options">
                    <div class="search-option" data-type="餐饮"><i class='bx bx-restaurant'></i>餐饮美食</div>
                    <div class="search-option" data-type="酒店"><i class='bx bx-hotel'></i>酒店住宿</div>
                    <div class="search-option" data-type="购物"><i class='bx bx-shopping-bag'></i>购物</div>
                    <div class="search-option" data-type="景点"><i class='bx bx-camera'></i>景点</div>
                    <div class="search-option" data-type="交通"><i class='bx bx-bus'></i>交通设施</div>
                    <div class="search-option" data-type=""><i class='bx bx-x'></i>清除筛选</div>
                </div>
            </div>
            <button id="search-filter" class="search-filter-btn">
                <i class='bx bx-filter'></i>
            </button>
            <button id="search-reset" class="search-reset-btn">
                <i class='bx bx-x'></i>
            </button>
            <!-- 移除地图切换按钮 -->
            <div class="map-overlay">
                <h3>厦门热门景点</h3>
                <p>
                    <span class="location-tag" data-location="环岛路">环岛路</span> · 
                    <span class="location-tag" data-location="黄厝海滩">黄厝海滩</span> · 
                    <span class="location-tag" data-location="厦门大学">厦门大学</span> · 
                    <span class="location-tag" data-location="鼓浪屿">鼓浪屿</span> · 
                    <span class="location-tag" data-location="植物园">植物园</span>
                </p>
            </div>
        </div>
        
        <!-- 行程卡片 -->
        <div class="card itinerary">
            <div class="day-tab">
                <div class="tab-item active" data-day="day1">第一天</div>
                <div class="tab-item" data-day="day2">第二天</div>
                <div class="tab-item" data-day="day3">第三天</div>
            </div>
            
            <div id="day1" class="day-content active">
                <h3>环岛路与黄厝日落</h3>
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-time">上午 9:30-13:00</div>
                        <div class="timeline-content">
                            <strong>SM城市广场</strong>
                            <p>寄存行李 + 避暑逛吃</p>
                            <p>推荐："纸的时代"书店、%Arabica咖啡、按摩放松、商场购物</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">中午 13:30</div>
                        <div class="timeline-content">
                            <strong>美居酒店</strong>
                            <p>放行李、休息片刻、化妆、涂防晒、喷驱蚊水</p>
                            <p>高档型酒店中性价比之选</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">下午 14:30-19:30</div>
                        <div class="timeline-content">
                            <strong>环岛路海边行程</strong>
                            <p>一国俩制沙滩 → 椰风寨 → 黄厝沙滩 → 玩月坡 → 溪头下 → 音乐广场 → 曾厝垵</p>
                            <p>傍晚欣赏橘色日落美景</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="day2" class="day-content">
                <h3>植物园森系和厦大</h3>
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-time">上午 9:00-11:00</div>
                        <div class="timeline-content">
                            <strong>厦门植物园</strong>
                            <p>西门入，重点雨林区+多肉植物区</p>
                            <p>雨林喷雾时间（9:30-11:30），光影如梦似幻</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">中午 11:30-13:30</div>
                        <div class="timeline-content">
                            <strong>植物园</strong>
                            <p>素斋馆推荐"普照楼"</p>
                            <p>招牌：南海金莲、素沙茶面、馅饼</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">下午 14:00-17:00</div>
                        <div class="timeline-content">
                            <strong>厦门大学</strong>
                            <p>路线：芙蓉湖 → 芙蓉隧道 → 上弦场 → 白城沙滩</p>
                            <p>从白城校门直通白城沙滩，看双子塔日落</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="day3" class="day-content">
                <h3>鼓浪屿</h3>
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-time">上午 7:30-12:00</div>
                        <div class="timeline-content">
                            <strong>东渡客运码头</strong>
                            <p>乘船至三丘田码头（9:10班次，7点起床）</p>
                            <p>最美转角 → 晴天墙 → 风琴博物馆 → 菽庄花园</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">中午 12:30-13:30</div>
                        <div class="timeline-content">
                            <strong>龙头路小吃</strong>
                            <p>推荐：叶氏麻糍、林氏鱼丸、沈家闽南肠粉</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">下午 14:00-15:30</div>
                        <div class="timeline-content">
                            <strong>菽庄花园与返程</strong>
                            <p>漫游花园与钢琴博物馆</p>
                            <p>最晚16:00离岛，预留时间前往厦门站</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 贴士、美食和购物卡片在同一行 -->
        <!-- 贴士卡片 -->
        <div class="card tips" style="grid-column: span 4; grid-row: span 2;">
            <h2><i class='bx bxs-bookmark-star'></i> 旅行贴士</h2>
            <ul class="checklist">
                <li>
                    <i class='bx bx-check-circle'></i>
                    <div>
                        <strong>随时携带</strong>：身份证、充电宝、防晒霜、遮阳帽、墨镜、驱蚊水、驱蚊药膏、沙滩拖鞋
                    </div>
                </li>
                <li>
                    <i class='bx bx-check-circle'></i>
                    <div>
                        <strong>鼓浪屿船票</strong>："屿见厦门"小程序抢票（选"东渡客运码头→三丘田码头"）
                    </div>
                </li>
                <li>
                    <i class='bx bx-check-circle'></i>
                    <div>
                        <strong>厦门大学/风琴博物馆预约</strong>：提前3天08:00预约（风琴博物馆当天0点预约）
                    </div>
                </li>
                <li>
                    <i class='bx bx-check-circle'></i>
                    <div>
                        <strong>防晒准备</strong>：防晒霜SPF50+、遮阳帽、墨镜必不可少
                    </div>
                </li>
                <li>
                    <i class='bx bx-check-circle'></i>
                    <div>
                        <strong>防蚊准备</strong>：驱蚊水、驱蚊药膏、花露水、避免蠓虫叮咬
                    </div>
                </li>
                <li>
                    <i class='bx bx-check-circle'></i>
                    <div>
                        <strong>返程交通</strong>：第三天离岛选三丘田码头，提前2小时从岛上撤离前往厦门站
                    </div>
                </li>
            </ul>
        </div>
        
        <!-- 美食卡片 -->
        <div class="card food-card" style="grid-column: span 4; grid-row: span 2;">
            <h2><i class='bx bxs-food-menu'></i> 厦门美食指南</h2>
            <div class="day-tab">
                <div class="tab-item active" data-food-day="food1">第一天</div>
                <div class="tab-item" data-food-day="food2">第二天</div>
                <div class="tab-item" data-food-day="food3">第三天</div>
            </div>
            
            <div id="food1" class="day-content active">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-time">早餐</div>
                        <div class="timeline-content">
                            <strong>宿舍</strong>
                            <p>简餐，留足时间赶往白云机场</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">午餐</div>
                        <div class="timeline-content">
                            <strong>SM城市广场</strong>
                            <p>永民手作奶茶 + 荣先森福建菜</p>
                            <p>备选：三期汉烟火·福建融合菜/二期宴遇·福建菜</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">晚餐</div>
                        <div class="timeline-content">
                            <strong>曾厝垵</strong>
                            <p>海蛎煎 + 烧烤 + 特色小吃</p>
                            <p>推荐：夜市小吃一条街（品牌店）</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="food2" class="day-content">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-time">早餐</div>
                        <div class="timeline-content">
                            <strong>酒店</strong>
                            <p>自助早餐</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">午餐</div>
                        <div class="timeline-content">
                            <strong>植物园普照楼</strong>
                            <p>南普陀寺：素食南海金莲 + 素沙茶面</p>
                            <p>备选：植物园旁的小厨娘闽南菜</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">晚餐</div>
                        <div class="timeline-content">
                            <strong>厦大白城/沙坡尾</strong>
                            <p>老四沙茶面 + 澜金烘焙甜点 + 沙茶肉串</p>
                            <p>备选：香客来特色砂锅菜</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="food3" class="day-content">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-time">早餐</div>
                        <div class="timeline-content">
                            <strong>酒店</strong>
                            <p>简餐，留足时间赶往码头</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">午餐</div>
                        <div class="timeline-content">
                            <strong>鼓浪屿龙头路</strong>
                            <p>叶氏麻糍 + 林氏鱼丸 + 黄胜记肉粽</p>
                            <p>备选：龙头路小吃街（品牌店）</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">晚餐</div>
                        <div class="timeline-content">
                            <strong>返程前</strong>
                            <p>中山路附近簋街海鲜大排档</p>
                            <p>备选：厦门站附近连锁快餐</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 伴手礼购物卡片 -->
        <div class="card souvenir-card" style="grid-column: span 4; grid-row: span 2;">
            <h2><i class='bx bxs-shopping-bag'></i> 伴手礼购物清单</h2>
            <ul class="checklist">
                <li>
                    <i class='bx bx-gift'></i>
                    <div>
                        <strong>特色食品</strong>
                        <p>素馅饼（南普陀寺）、阿呆姜母鸭（八市店）、凤梨酥、椰子饼、牛轧糖、黄胜记肉粽、牛轧糖（鼓浪屿店）、铁观音茶叶（厦门站）、绿皮火车茶礼（沙坡尾店）</p>
                    </div>
                </li>
                <li>
                    <i class='bx bx-gift'></i>
                    <div>
                        <strong>纪念品</strong>
                        <p>鼓浪屿钢琴音乐盒、厦门大学文创、海边贝壳手工艺品、冰箱贴、手绘明信片等</p>
                    </div>
                </li>
                <li>
                    <i class='bx bx-gift'></i>
                    <div>
                        <strong>购物地点</strong>
                        <p>鼓浪屿：龙头路、三丘田</p>
                        <p>市区：中山路商业街、SM城市广场、南普陀寺</p>
                        <p>海边：曾厝垵文创街区、沙坡尾艺术西区</p>
                    </div>
                </li>
            </ul>
        </div>
        
        <!-- 第一行图片卡片 - 3张 -->
        <div class="card image-card">
            <div class="image-container">
                <img src="image/xiamen/鼓浪屿.jpg" alt="鼓浪屿">
            </div>
            <div class="image-content">
                <h3>鼓浪屿</h3>
                <p>文艺范的小岛，有各种特色建筑和美食</p>
                <p>推荐路线：三丘田码头登岛➡️管风琴艺术中心➡️最美转角➡️晴天墙➡️八卦楼➡️龙头路小吃街➡️菽庄花园➡️港仔后沙滩➡️钢琴码头➡️三丘田码头离岛</p>
            </div>
        </div>
        
        <div class="card image-card">
            <div class="image-container">
                <img src="image/xiamen/厦门大学.jpg" alt="厦门大学">
            </div>
            <div class="image-content">
                <h3>厦门大学</h3>
                <p>中国最美大学校园之一，依山傍海，环境优美</p>
                <p>推荐路线：厦大访客中心➡️演武场➡️陈嘉庚纪念像➡️校史馆➡️颂恩楼➡️芙蓉湖➡️上弦场➡️芙蓉隧道➡️芙蓉餐厅</p>
            </div>
        </div>
        
        <div class="card image-card">
            <div class="image-container">
                <img src="image/xiamen/环岛路.jpg" alt="环岛路">
            </div>
            <div class="image-content">
                <h3>环岛路</h3>
                <p>沿着海岸线的绝美骑行道，风景如画，适合骑行、散步、拍照</p>
                <p>推荐路线：一国俩制沙滩➡️椰风寨➡️黄厝沙滩➡️玩月坡➡️溪头下➡️音乐广场➡️曾厝垵➡️白城沙滩➡️演武大桥</p>
            </div>
        </div>
        
        <!-- 第二行图片卡片 - 3张 -->
        <div class="card image-card">
            <div class="image-container">
                <img src="image/xiamen/沙坡尾.jpg" alt="沙坡尾">
            </div>
            <div class="image-content">
                <h3>沙坡尾</h3>
                <p>沙坡尾艺术西区，有特色小店和美食街，适合拍照、购物、品尝美食</p>
                <p>推荐路线：咖飛狮（网红彩虹墙）➡️沙坡尾艺术西区院内➡️厦门的查查斯➡️TUUO➡️LHT古着屋➡️深夜食堂➡️返回艺术区方向➡️舒芙蕾红豆烧➡️茉莉奶白➡️转角合作社➡️沙坡尾的查查斯➡️厦门朝宗宫（双子塔最佳机位）</p>
            </div>
        </div>
        
        <div class="card image-card">
            <div class="image-container">
                <img src="image/xiamen/南普陀寺.jpg" alt="南普陀寺">
            </div>
            <div class="image-content">
                <h3>南普陀寺</h3>
                <p>厦门著名佛教寺庙，与厦大相邻，历史悠久，坐落于海滨山麓，依山面海</p>
                <p>推荐路线：南普陀寺➡️素菜馆➡️礼品区</p>
            </div>
        </div>
        
        <!-- 新增第6张图片卡片 -->
        <div class="card image-card">
            <div class="image-container">
                <img src="image/xiamen/黄厝沙滩.jpg" alt="黄厝沙滩">
            </div>
            <div class="image-content">
                <h3>黄厝沙滩</h3>
                <p>厦门最美沙滩，适合看日出，金色沙滩治愈满分</p>
                <p>推荐路线：椰风寨➡️黄厝沙滩➡️玩月坡➡️溪头下</p>
            </div>
        </div>
        
        <!-- 页脚卡片 -->
        <div class="card footer-card">
            <p>开始你的厦门之旅 🏝 探索、发现、享受</p>
        </div>
    </div>
    
    <!-- API密钥提示框 -->
    <div id="api-notice" class="api-notice">
        <button class="close-btn" onclick="document.getElementById('api-notice').classList.remove('active')">×</button>
        <h3><i class='bx bx-info-circle'></i> API密钥配置问题</h3>
        <p>当前使用的高德地图API密钥遇到了<strong>USERKEY_PLAT_NOMATCH</strong>错误，这表示API密钥与当前平台不匹配。</p>
        <p>要解决此问题，请按照以下步骤操作:</p>
        <ol>
            <li>登录<a href="https://lbs.amap.com/dev/key/app" target="_blank">高德开放平台控制台</a></li>
            <li>找到您的应用和对应的密钥</li>
            <li>确保密钥已启用<strong>JavaScript API</strong>权限</li>
            <li>检查<strong>域名白名单</strong>是否包含当前网站域名</li>
            <li>如果是本地开发，添加以下域名到白名单: <span class="code">localhost</span>, <span class="code">127.0.0.1</span>, <span class="code">file://</span></li>
        </ol>
        <p>修改完成后，可能需要等待几分钟才能生效。</p>
    </div>
    
    <!-- 天气API提示框 -->
    <div id="weather-api-notice" class="api-notice">
        <button class="close-btn" onclick="document.getElementById('weather-api-notice').classList.remove('active')">×</button>
        <h3><i class='bx bx-info-circle'></i> 高德天气API请求问题</h3>
        <p>高德天气API请求失败，可能有以下原因：</p>
        <ol>
            <li>网络连接问题</li>
            <li>API密钥权限不足或配置问题</li>
            <li>API服务暂时不可用或请求超时</li>
        </ol>
        <p>请检查浏览器控制台(F12)查看详细错误信息。</p>
        <p>如果您使用的是本地文件(file://协议)打开页面，请确保在高德开放平台控制台中的应用添加了以下域名白名单：</p>
        <div class="code">file://</div>
        <p>解决方案：</p>
        <ol>
            <li>登录<a href="https://lbs.amap.com/dev/key/app" target="_blank">高德开放平台控制台</a></li>
            <li>找到您的应用，点击"编辑"</li>
            <li>在"域名白名单"中添加"file://"</li>
            <li>保存更改并等待生效(通常需要几分钟)</li>
        </ol>
        <p>当前系统会自动切换到离线模式，显示预设的天气数据。</p>
    </div>
    
    <script>
        const keyManager = (function() {
            const keyParts = [
                '8163', 'ea46', 'aa68', 'a8fb', 'bdde', '9d92', '4236', '290b'
            ];
            
            function checkSecurity() {
                const allowedDomains = ['localhost', '127.0.0.1', 'lzx1902.github.io', window.location.hostname];
                let isAllowed = false;
                
                // 检查是否是允许的域名
                for (let domain of allowedDomains) {
                    if (window.location.hostname === domain || window.location.hostname.includes(domain)) {
                        console.log('域名验证通过:', window.location.hostname);
                        isAllowed = true;
                        break;
                    }
                }
                
                // 如果是GitHub Pages环境，特别允许
                const isGitHubPages = window.location.hostname.includes('github.io');
                return isAllowed || window.location.protocol === 'file:' || isGitHubPages;
            }
            
            return {
                getMapKey: function() {
                    if (checkSecurity()) {
                        return keyParts.join('');
                    }
                    return 'invalid_key_for_security_reasons';
                }
            };
        })();
        
        // 行程标签切换功能
        document.querySelectorAll('.tab-item[data-day]').forEach(function(tab) {
            tab.addEventListener('click', function() {
                // 移除所有标签的活动状态
                document.querySelectorAll('.tab-item[data-day]').forEach(function(t) {
                    t.classList.remove('active');
                });
                // 添加当前标签的活动状态
                this.classList.add('active');
                
                // 获取当前选中的日期ID
                const dayId = this.getAttribute('data-day');
                
                // 隐藏所有日期内容
                document.querySelectorAll('.itinerary .day-content').forEach(function(content) {
                    content.classList.remove('active');
                });
                
                // 显示当前选中的日期内容
                document.getElementById(dayId).classList.add('active');
            });
        });
        
        // 美食标签切换功能
        document.querySelectorAll('.tab-item[data-food-day]').forEach(function(tab) {
            tab.addEventListener('click', function() {
                // 移除所有标签的活动状态
                document.querySelectorAll('.tab-item[data-food-day]').forEach(function(t) {
                    t.classList.remove('active');
                });
                // 添加当前标签的活动状态
                this.classList.add('active');
                
                // 获取当前选中的日期ID
                const foodDayId = this.getAttribute('data-food-day');
                
                // 隐藏所有日期内容
                document.querySelectorAll('.food-card .day-content').forEach(function(content) {
                    content.classList.remove('active');
                });
                
                // 显示当前选中的日期内容
                document.getElementById(foodDayId).classList.add('active');
            });
        });
        
        // 初始化地图
        function initMap() {
            // 加载高德地图API
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://webapi.amap.com/maps?v=2.0&key=' + keyManager.getMapKey() + '&plugin=AMap.ToolBar,AMap.Scale,AMap.HawkEye,AMap.MapType,AMap.Geolocation';
            script.onload = function() {
                // 确保AMap对象可用
                window.AMap = AMap;
                
                // 创建地图实例
                window.map = new AMap.Map('map-container', {
                    resizeEnable: true,
                    zoom: 12,
                    center: [118.1022, 24.4452] // 厦门市中心
                });
                
                // 确保地图完全加载后再初始化标记和事件
                window.map.on('complete', function() {
                    console.log('地图加载完成');
                    window.mapReady = true;
                    
                    // 隐藏加载提示
                    document.getElementById('map-loading').style.display = 'none';
                    
                    // 打印所有标记，确认它们已被正确创建
                    console.log('地图加载完成后的标记:', Object.keys(window.markers));
                    
                    // 为环岛路标记添加额外的标识，便于调试
                    if (window.markers['环岛路']) {
                        console.log('环岛路标记已创建:', window.markers['环岛路']);
                        
                        // 确保环岛路标记可见
                        window.markers['环岛路'].marker.setMap(window.map);
                        
                        // 使环岛路标记更大更显眼，便于调试
                        var markerHeight = 80;
                        var markerWidth = 36; // 更窄的标记
                        var fontSize = 16;
                        
                        // 创建垂直文本
                        var verticalText = '';
                        for (var i = 0; i < '环岛路'.length; i++) {
                            verticalText += '环岛路'[i] + (i < '环岛路'.length - 1 ? '<br>' : '');
                        }
                        
                        // 更新环岛路标记的内容
                        window.markers['环岛路'].marker.setContent(`<div style="background-color:#FFB800; color:white; width:${markerWidth}px; height:${markerHeight}px; 
                            border-radius:18px; text-align:center; display:flex; align-items:center; justify-content:center; 
                            font-weight:bold; font-size:${fontSize}px; box-shadow:0 2px 6px rgba(0,0,0,0.3); padding:5px 0;">
                            ${verticalText}
                        </div>`);
                        
                        // 更新偏移
                        window.markers['环岛路'].marker.setOffset(new AMap.Pixel(-markerWidth/2, -markerHeight/2));
                    } else {
                        console.warn('环岛路标记未创建!');
                        
                        // 如果环岛路标记未创建，手动创建一个
                        console.log('尝试手动创建环岛路标记');
                        // 使用延迟创建，确保地图已完全加载
                        setTimeout(function() {
                            addMarker('环岛路', 118.1257, 24.4348, '环海风景道，全长约43公里');
                        }, 500);
                    }
                });
                
                // 添加地图控件
                map.addControl(new AMap.ToolBar({
                    position: 'LB'
                }));
                map.addControl(new AMap.Scale({
                    position: 'LB',
                    offset: new AMap.Pixel(10, 50)
                }));
                
                // 添加地图类型切换控件
                map.addControl(new AMap.MapType({
                    defaultType: 0,
                    position: 'RB'
                }));
                
                // 添加定位控件
                map.addControl(new AMap.Geolocation({
                    buttonPosition: 'RB',
                    buttonOffset: new AMap.Pixel(10, 20),
                    showMarker: true,
                    showCircle: true
                }));
                
                // 预设景点标记
                window.markers = {};
                // 搜索结果标记
                window.searchMarkers = [];
                
                // 添加景点标记
                addMarker('鼓浪屿', 118.063467,24.444968, '厦门著名景点，有"钢琴之岛"、"万国建筑博览"之称');
                addMarker('厦门大学', 118.102483,24.438133, '中国最美大学之一，依山傍海，风景如画');
                addMarker('南普陀寺', 118.100007,24.439637, '闽南佛教胜地，始建于唐代');
                addMarker('环岛路', 118.10086,24.430721, '环海风景道，全长约43公里');
                addMarker('黄厝海滩', 118.165343,24.446982, '厦门最美沙滩，适合看日出，金色沙滩治愈满分');
                addMarker('曾厝垵', 118.128615,24.422618, '文艺小村，有特色小店和美食街');
                addMarker('沙坡尾', 118.090006,24.442901, '文艺艺术区，原渔港改建');
                addMarker('植物园', 118.111746,24.446333, '厦门植物园，拥有丰富的植物资源和优美的自然景观');
                
                // 添加酒店位置标记
                addMarker('美居酒店', 118.181045,24.486699, '厦门国际会展中心环岛路美居酒店', 'hotel');
                
                // 添加标记函数
                function addMarker(name, lng, lat, info, type = 'attraction') {
                    // 定义自定义图标颜色，与网站主题色匹配
                    var iconColor;
                    var iconScale = 1.0;
                    
                    if (type === 'hotel') {
                        // 酒店使用蓝色
                        iconColor = '#0084FF'; // --secondary
                        iconScale = 1.1;
                    } else if (name.includes('鼓浪屿') || name.includes('厦门大学') || name.includes('南普陀')) {
                        // 主要景点使用主题橙色
                        iconColor = '#FF6B00'; // --primary
                        iconScale = 1.1;
                    } else if (name.includes('沙坡尾') || name.includes('曾厝垵')) {
                        // 文艺区域使用紫色
                        iconColor = '#9C27B0';
                    } else if (name.includes('环岛路') || name.includes('黄厝')) {
                        // 海滩区域使用黄色
                        iconColor = '#FFB800'; // --accent
                    } else {
                        // 其他景点使用橙红色
                        iconColor = '#FF4500';
                    }
                    
                    // 创建自定义SVG图标
                    var svgMarker = {
                        path: 'M20,0C8.96,0,0,8.96,0,20c0,17.73,20,44,20,44s20-26.27,20-44C40,8.96,31.04,0,20,0z M20,27c-3.87,0-7-3.13-7-7s3.13-7,7-7,7,3.13,7,7S23.87,27,20,27z',
                        fillColor: iconColor,
                        fillOpacity: 1,
                        scale: iconScale,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 2,
                        anchor: new AMap.Pixel(20, 40)
                    };
                    
                    // 创建标记 - 使用图片中样式的垂直圆角矩形标记
                    var markerHeight = type === 'hotel' ? 100 : 70; // 酒店标记更高一些
                    var markerWidth = 36; // 更窄的标记
                    var fontSize = type === 'hotel' ? 18 : 14;
                    
                    // 创建垂直文本标记
                    var verticalText = '';
                    for (var i = 0; i < name.length; i++) {
                        verticalText += name[i] + (i < name.length - 1 ? '<br>' : '');
                    }
                    
                    // 创建标记
                    var marker = new AMap.Marker({
                        position: new AMap.LngLat(lng, lat),
                        title: name,
                        map: map,
                        content: `<div style="background-color:${iconColor}; color:white; width:${markerWidth}px; height:${markerHeight}px; 
                            border-radius:18px; text-align:center; display:flex; align-items:center; justify-content:center; 
                            font-weight:bold; font-size:${fontSize}px; box-shadow:0 2px 6px rgba(0,0,0,0.3); padding:5px 0;">
                            ${verticalText}
                        </div>`,
                        offset: new AMap.Pixel(-markerWidth/2, -markerHeight/2) // 调整偏移以保持标记位置准确
                    });
                    
                    // 不再需要额外的文本标签，因为我们已经将文本集成到标记中了
                    var text = null;
                    
                    // 创建信息窗体
                    var infoWindow = new AMap.InfoWindow({
                        content: `<div style="padding:12px; border-radius:8px;">
                            <h4 style="margin:0 0 8px 0; color:#FF6B00; font-size:16px;">${name}</h4>
                            <p style="margin:0; line-height:1.5; color:#333;">${info}</p>
                        </div>`,
                        offset: new AMap.Pixel(0, -30),
                        isCustom: true,
                        autoMove: true
                    });
                    
                    // 添加点击事件
                    marker.on('click', function() {
                        // 关闭之前的信息窗体
                        if (window.currentInfoWindow) {
                            window.currentInfoWindow.close();
                        }
                        
                        infoWindow.open(map, marker.getPosition());
                        window.currentInfoWindow = infoWindow;
                        
                        // 如果是酒店，设置缩放级别更高
                        if (type === 'hotel') {
                            map.setZoomAndCenter(15, marker.getPosition());
                        } else {
                            map.setZoomAndCenter(14, marker.getPosition());
                        }
                    });
                    
                    // 保存标记引用
                    window.markers[name] = {
                        marker: marker,
                        infoWindow: infoWindow,
                        type: type
                    };
                    
                    // 如果有文本标签，保存引用
                    if (text) {
                        window.markers[name].text = text;
                    }
                }
                
                // 添加热门景点标签点击事件
                document.querySelectorAll('.location-tag').forEach(function(tag) {
                    tag.addEventListener('click', function() {
                        // 检查地图和AMap对象是否已加载
                        if (!window.map || !window.AMap || !window.mapReady) {
                            console.warn('地图尚未加载完成，请稍后再试');
                            return;
                        }
                        
                        // 如果当前是路线图模式，先切换到普通地图模式
                        if (window.currentMapMode === 'route') {
                            switchMapMode('normal');
                        }
                        
                        var location = this.getAttribute('data-location');
                        var found = false;
                        
                        // 打印所有可用的标记，用于调试
                        console.log('可用的标记:', Object.keys(window.markers));
                        console.log('正在查找标记:', location);
                        
                        // 延迟执行，确保地图标记已经加载
                        setTimeout(function() {
                            // 再次检查地图和标记是否已加载
                            if (!window.map || !window.markers || !window.AMap || !window.mapReady) {
                                console.warn('地图或标记尚未加载完成，请稍后再试');
                                return;
                            }
                            
                            for (var name in window.markers) {
                                // 使用更宽松的匹配方式，转换为小写并去除空格进行比较
                                const normalizedName = name.toLowerCase().replace(/\s+/g, '');
                                const normalizedLocation = location.toLowerCase().replace(/\s+/g, '');
                                
                                // 打印每次比较的结果，用于调试
                                console.log(`比较: "${normalizedName}" vs "${normalizedLocation}"`);
                                
                                // 特殊情况处理
                                if (location === '环岛路' && name === '环岛路') {
                                    console.log('找到环岛路精确匹配!');
                                    try {
                                        // 使用通用的定位函数
                                        if (focusOnMarker('环岛路')) {
                                        } else {
                                            // 如果标记不存在，使用硬编码坐标
                                            console.log('环岛路标记不存在，使用硬编码坐标');
                                            const pos = new AMap.LngLat(118.1257, 24.4348);
                                            
                                            // 先设置中心点
                                            window.map.setCenter(pos);
                                            
                                            // 使用动画效果平滑缩放，并考虑地图容器高度的一半作为垂直偏移
                                            const mapContainer = document.getElementById('map-container');
                                            const verticalOffset = mapContainer.clientHeight / 4;
                                            
                                            // 设置缩放级别和偏移
                                            window.map.setZoomAndCenter(14, pos, false);
                                            window.map.panBy(0, -verticalOffset);
                                        }
                                        
                                        found = true;
                                        break;
                                    } catch (e) {
                                        console.error('环岛路定位失败:', e);
                                    }
                                }
                                
                                if (normalizedName.includes(normalizedLocation) || normalizedLocation.includes(normalizedName)) {
                                    console.log('找到匹配景点:', name, '对应查询:', location);
                                    try {
                                        // 使用通用的定位函数
                                        if (focusOnMarker(name)) {
                                            found = true;
                                        }
                                        break;
                                    } catch (e) {
                                        console.error('触发标记点击事件失败:', e);
                                    }
                                }
                            }
                            
                            if (!found) {
                                console.log('未找到匹配的景点:', location);
                                
                                // 特殊情况处理 - 如果是环岛路，直接使用坐标
                                // 注：环岛路已经在上面处理过，这里作为备份逻辑
                                if (location === '环岛路' && !found) {
                                    console.log('使用环岛路的备用硬编码坐标');
                                    try {
                                        // 使用通用的定位函数
                                        if (focusOnMarker('环岛路')) {
                                        } else {
                                            // 如果标记不存在，使用硬编码坐标
                                            const pos = new AMap.LngLat(118.1257, 24.4348);
                                            
                                            // 先设置中心点
                                            window.map.setCenter(pos);
                                            
                                            // 使用动画效果平滑缩放，并考虑地图容器高度的一半作为垂直偏移
                                            const mapContainer = document.getElementById('map-container');
                                            const verticalOffset = mapContainer.clientHeight / 4;
                                            
                                            // 设置缩放级别和偏移
                                            window.map.setZoomAndCenter(14, pos, false);
                                            window.map.panBy(0, -verticalOffset);
                                        }
                                        
                                        found = true;
                                    } catch (e) {
                                        console.error('环岛路备用定位失败:', e);
                                    }
                                }
                                
                                if (!found) {
                                    // 显示友好提示，而不是自动搜索
                                    const mapOverlay = document.querySelector('.map-overlay');
                                    
                                    // 创建一个临时提示元素
                                    const noticeElement = document.createElement('div');
                                    noticeElement.className = 'location-notice';
                                    noticeElement.innerHTML = `
                                        <div style="background-color: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); margin-top: 10px; text-align: center; color: #ff6b00;">
                                            <i class='bx bx-info-circle'></i> 未找到"${location}"景点，您可以尝试在搜索框中搜索
                                        </div>
                                    `;
                                    
                                    // 添加到地图覆盖层
                                    mapOverlay.appendChild(noticeElement);
                                    
                                    // 将景点名称填入搜索框，但不自动搜索
                                    document.getElementById('search-input').value = location;
                                    document.getElementById('search-input').focus();
                                    
                                    // 3秒后移除提示
                                    setTimeout(function() {
                                        if (noticeElement.parentNode) {
                                            noticeElement.parentNode.removeChild(noticeElement);
                                        }
                                    }, 3000);
                                }
                            }
                        }, 100);
                    });
                });
                
                // 添加酒店位置点击事件
                document.getElementById('hotel-location').addEventListener('click', function() {
                    // 检查地图和AMap对象是否已加载
                    if (!window.map || !window.AMap || !window.mapReady) {
                        console.warn('地图尚未加载完成，请稍后再试');
                        return;
                    }
                    
                    // 如果当前是路线图模式，先切换到普通地图模式
                    if (window.currentMapMode === 'route') {
                        switchMapMode('normal');
                    }
                    
                    // 延迟执行，确保地图标记已经加载
                    setTimeout(function() {
                        // 再次检查地图和标记是否已加载
                        if (!window.map || !window.markers || !window.AMap || !window.mapReady) {
                            console.warn('地图或标记尚未加载完成，请稍后再试');
                            return;
                        }
                        
                        // 触发酒店标记点击
                        if (window.markers['美居酒店']) {
                            try {
                                // 使用通用的定位函数
                                focusOnMarker('美居酒店');
                                
                                // 滚动到地图卡片
                                document.querySelector('.map-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
                            } catch (e) {
                                console.error('触发酒店标记点击事件失败:', e);
                            }
                        } else {
                            console.log('未找到酒店标记');
                            // 显示友好提示，而不是自动搜索
                            const mapOverlay = document.querySelector('.map-overlay');
                            
                            // 创建一个临时提示元素
                            const noticeElement = document.createElement('div');
                            noticeElement.className = 'location-notice';
                            noticeElement.innerHTML = `
                                <div style="background-color: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); margin-top: 10px; text-align: center; color: #ff6b00;">
                                    <i class='bx bx-info-circle'></i> 未找到"美居酒店"，您可以尝试在搜索框中搜索
                                </div>
                            `;
                            
                            // 添加到地图覆盖层
                            mapOverlay.appendChild(noticeElement);
                            
                            // 将酒店名称填入搜索框，但不自动搜索
                            document.getElementById('search-input').value = '美居酒店';
                            document.getElementById('search-input').focus();
                            
                            // 3秒后移除提示
                            setTimeout(function() {
                                if (noticeElement.parentNode) {
                                    noticeElement.parentNode.removeChild(noticeElement);
                                }
                            }, 3000);
                        }
                    }, 100);
                });
                
                // 添加搜索重置按钮点击事件
                document.getElementById('search-reset').addEventListener('click', function() {
                    // 清除搜索结果
                    if (window.searchMarkers && window.searchMarkers.length > 0) {
                        window.searchMarkers.forEach(function(marker) {
                            marker.setMap(null);
                        });
                    }
                    
                    // 关闭信息窗体
                    if (window.currentInfoWindow) {
                        window.currentInfoWindow.close();
                    }
                    
                    // 重置搜索框
                    document.getElementById('search-input').value = '';
                    document.getElementById('search-input').placeholder = '搜索厦门的地点...';
                    window.searchType = null;
                    
                    // 调整地图视图
                    var allMarkers = [];
                    for (var name in window.markers) {
                        allMarkers.push(window.markers[name].marker);
                    }
                    map.setFitView(allMarkers);
                });
                
                // 初始化地图切换功能
                initMapToggle();
                
                // 添加搜索按钮点击事件
                document.getElementById('search-button').addEventListener('click', function() {
                    searchPlaces();
                });
                
                // 添加筛选按钮点击事件
                document.getElementById('search-filter').addEventListener('click', function() {
                    document.getElementById('search-options').classList.toggle('active');
                });
                
                // 添加搜索选项点击事件
                document.querySelectorAll('.search-option').forEach(function(option) {
                    option.addEventListener('click', function() {
                        var type = this.getAttribute('data-type');
                        var searchInput = document.getElementById('search-input');
                        
                        // 更新搜索类型
                        window.searchType = type;
                        
                        // 更新提示文字
                        if (type) {
                            searchInput.placeholder = `搜索厦门的${type}...`;
                        } else {
                            searchInput.placeholder = "搜索厦门的地点...";
                        }
                        
                        // 关闭选项菜单
                        document.getElementById('search-options').classList.remove('active');
                        
                        // 如果搜索框已有内容，自动执行搜索
                        if (searchInput.value.trim() !== '') {
                            searchPlaces();
                        }
                    });
                });
            };
            document.head.appendChild(script);
        }
        
        // 页面加载完成后初始化地图
        window.onload = function() {
            initMap();
            initWeather();
            initTimeDisplay();
        };
        
        // 添加输入框回车事件
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('search-button').click();
            }
        });
        
        // 初始化时间显示功能
        function initTimeDisplay() {
            // 更新当前时间
            updateTime();
            // 每秒更新一次时间
            setInterval(updateTime, 1000);
        }
        
        // 更新当前时间
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const dateString = now.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                weekday: 'short'
            });
            
            // 更新时间显示
            const timeDisplay = document.querySelector('.current-time');
            timeDisplay.innerHTML = `${dateString}<br>${timeString}`;
        }
        
        // 初始化天气功能
        function initWeather() {
            // 使用高德地图天气API获取厦门实时天气
            fetchAmapWeather();
        }
        
        // 使用高德地图天气API获取厦门天气
        function fetchAmapWeather() {
            document.getElementById('current-weather-text').innerHTML = "正在获取天气数据...";
            
            // 创建天气展示区域
            const weatherContainer = document.getElementById('weather-container');
            weatherContainer.innerHTML = `
                <div class="baidu-weather-wrapper" style="padding: 15px; height: auto;">
                    <div id="amap-weather-content">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 28px; font-weight: bold;"><span id="current-temp">26</span>°C</div>
                                <div style="color: #666; margin-top: 5px;"><span id="current-weather">晴</span> | <span id="current-humidity">湿度 75%</span></div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 14px; color: #666;">厦门市</div>
                                <div style="margin-top: 5px; font-size: 12px; color: #999;">
                                    <span id="current-wind">东南风 2级</span>
                                </div>
                            </div>
                        </div>
                        <div id="forecast-container" style="display: flex; justify-content: space-between; text-align: center; border-top: 1px solid #eee; padding-top: 15px;">
                            <!-- 天气预报将在这里动态添加 -->
                        </div>
                        <div style="text-align: right; margin-top: 10px; font-size: 12px; color: #999;">
                            数据来源: 高德地图天气API
                        </div>
                    </div>
                </div>
            `;
            
            // 使用密钥管理器获取安全的API密钥
            const apiKey = keyManager.getMapKey();            
            // 厦门的城市编码（厦门: 350200）
            const cityCode = '350200';
            
            // 处理API请求异常情况的函数
            function handleApiError(error) {
                console.error("获取天气数据失败:", error);
                
                // 检查是否为本地文件访问
                if (window.location.protocol === 'file:') {
                    console.warn("您正在使用本地文件(file://)访问页面，请确保在高德开放平台已添加file://到域名白名单");
                    // 显示天气API提示框
                    document.getElementById('weather-api-notice').classList.add('active');
                }
                
                // 更新天气文本为静态数据
                document.getElementById('current-weather-text').innerHTML = "厦门实时天气 <span style='color:#ff6b00;font-size:12px;'>(静态数据)</span>";
                
                // 使用静态数据显示
                return Promise.reject(error);
            }
            
            // 构建实时天气API请求URL
            const liveWeatherUrl = `https://restapi.amap.com/v3/weather/weatherInfo?key=${apiKey}&city=${cityCode}&extensions=base`;
            
            // 构建天气预报API请求URL
            const forecastWeatherUrl = `https://restapi.amap.com/v3/weather/weatherInfo?key=${apiKey}&city=${cityCode}&extensions=all`;
            
            // 获取实时天气数据
            fetch(liveWeatherUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`网络响应错误 (${response.status}): ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("高德实时天气数据:", data);
                    
                    if (data.status === '1' && data.lives && data.lives.length > 0) {
                        const liveWeather = data.lives[0];
                        
                        // 更新实时天气信息
                        document.getElementById('current-temp').textContent = liveWeather.temperature;
                        document.getElementById('current-weather').textContent = liveWeather.weather;
                        document.getElementById('current-humidity').textContent = `湿度 ${liveWeather.humidity}%`;
                        document.getElementById('current-wind').textContent = `${liveWeather.winddirection}风 ${liveWeather.windpower}`;
                        
                        // 更新天气文本
                        document.getElementById('current-weather-text').innerHTML = `${liveWeather.temperature}°C，${liveWeather.weather}`;
                    } else {
                        // 检查常见API错误
                        if (data.status === '0') {
                            if (data.info === 'INVALID_USER_KEY') {
                                throw new Error("无效的API密钥");
                            } else if (data.info === 'USER_KEY_PLAT_NOMATCH') {
                                throw new Error("API密钥与平台不匹配，请检查域名白名单");
                                // 显示API密钥提示框
                                document.getElementById('api-notice').classList.add('active');
                            } else if (data.info === 'DAILY_QUERY_OVER_LIMIT') {
                                throw new Error("API查询超过日限额");
                            } else {
                                throw new Error(`高德API错误: ${data.info}`);
                            }
                        } else {
                            throw new Error("高德天气API返回数据无效");
                        }
                    }
                })
                .catch(handleApiError);
            
            // 获取天气预报数据
            fetch(forecastWeatherUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`网络响应错误 (${response.status}): ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("高德天气预报数据:", data);
                    
                    if (data.status === '1' && data.forecasts && data.forecasts.length > 0 && data.forecasts[0].casts) {
                        const forecasts = data.forecasts[0].casts;
                        const forecastContainer = document.getElementById('forecast-container');
                        
                        // 清除现有内容
                        forecastContainer.innerHTML = '';
                        
                        // 最多显示3天预报
                        const maxDays = Math.min(forecasts.length, 3);
                        
                        // 定义天气图标映射
                        const weatherIcons = {
                            '晴': 'bxs-sun',
                            '多云': 'bxs-cloud',
                            '阴': 'bxs-cloud',
                            '小雨': 'bxs-cloud-rain',
                            '中雨': 'bxs-cloud-rain',
                            '大雨': 'bxs-cloud-rain',
                            '暴雨': 'bxs-cloud-rain',
                            '雷阵雨': 'bxs-bolt',
                            '小雪': 'bxs-cloud-snow',
                            '中雪': 'bxs-cloud-snow',
                            '大雪': 'bxs-cloud-snow',
                            '暴雪': 'bxs-cloud-snow',
                            '雾': 'bxs-fog',
                            '霾': 'bxs-fog'
                        };
                        
                        // 定义日期映射
                        const dayNames = ['今天', '明天', '后天', '第4天'];
                        
                        // 添加预报信息
                        for (let i = 0; i < maxDays; i++) {
                            const forecast = forecasts[i];
                            
                            // 确定天气图标
                            const weatherIcon = weatherIcons[forecast.dayweather] || 'bxs-cloud';
                            
                            // 创建预报元素
                            const dayElement = document.createElement('div');
                            dayElement.className = 'weather-day';
                            dayElement.style.flex = '1';
                            dayElement.innerHTML = `
                                <div>${dayNames[i]}</div>
                                <i class='bx ${weatherIcon} weather-icon'></i>
                                <div class="temp">${forecast.daytemp}°C / ${forecast.nighttemp}°C</div>
                                <div style="font-size: 12px;">${forecast.dayweather}</div>
                            `;
                            
                            forecastContainer.appendChild(dayElement);
                        }
                    } else {
                        // 检查常见API错误
                        if (data.status === '0') {
                            if (data.info === 'INVALID_USER_KEY') {
                                throw new Error("无效的API密钥");
                            } else if (data.info === 'USER_KEY_PLAT_NOMATCH') {
                                throw new Error("API密钥与平台不匹配，请检查域名白名单");
                                // 显示API密钥提示框
                                document.getElementById('api-notice').classList.add('active');
                            } else if (data.info === 'DAILY_QUERY_OVER_LIMIT') {
                                throw new Error("API查询超过日限额");
                            } else {
                                throw new Error(`高德API错误: ${data.info}`);
                            }
                        } else {
                            throw new Error("高德天气预报API返回数据无效");
                        }
                    }
                })
                .catch(error => {
                    console.error("获取天气预报数据失败:", error);
                    
                    // 使用静态预报数据
                    const forecastContainer = document.getElementById('forecast-container');
                    forecastContainer.innerHTML = `
                        <div class="weather-day" style="flex: 1;">
                            <div>今天</div>
                            <i class='bx bxs-sun weather-icon'></i>
                            <div class="temp">29°C / 24°C</div>
                            <div style="font-size: 12px;">晴</div>
                        </div>
                        <div class="weather-day" style="flex: 1;">
                            <div>明天</div>
                            <i class='bx bxs-cloud weather-icon'></i>
                            <div class="temp">28°C / 23°C</div>
                            <div style="font-size: 12px;">多云</div>
                        </div>
                        <div class="weather-day" style="flex: 1;">
                            <div>后天</div>
                            <i class='bx bxs-cloud weather-icon'></i>
                            <div class="temp">27°C / 22°C</div>
                            <div style="font-size: 12px;">多云</div>
                        </div>
                    `;
                    
                    // 如果实时天气也失败，显示提示信息
                    // 这里不直接调用handleApiError是为了避免重复显示提示框
                    if (window.location.protocol === 'file:' && document.getElementById('weather-api-notice').classList.contains('active') === false) {
                        console.warn("您正在使用本地文件(file://)访问页面，请确保在高德开放平台已添加file://到域名白名单");
                        document.getElementById('weather-api-notice').classList.add('active');
                    }
                });
        }
        
        // 删除行程路线数据
        
        // 初始化地图交互功能
        function initMapToggle() {
            // 移除不需要的按钮事件监听
            if (document.getElementById('map-normal')) {
                document.getElementById('map-normal').style.display = 'none';
            }
            if (document.getElementById('map-route')) {
                document.getElementById('map-route').style.display = 'none';
            }
            
            // 确保地图覆盖物和搜索控件可见
            document.querySelector('.map-overlay').style.display = 'block';
            document.querySelector('.search-container').style.display = 'flex';
            document.getElementById('search-filter').style.display = 'block';
            document.getElementById('search-reset').style.display = 'block';
        }
        
        // 搜索地点函数
        function searchPlaces(directKeyword) {
            var keyword = directKeyword || document.getElementById('search-input').value;
            if (keyword.trim() === '') {
                return;
            }
            
            // 如果是直接传入的关键词，更新搜索框
            if (directKeyword) {
                document.getElementById('search-input').value = directKeyword;
            }
            
            // 确保地图已加载
            if (!window.map || !window.AMap || !window.mapReady) {
                console.error('地图尚未加载完成，请稍后再试');
                alert('地图正在加载中，请稍后再试');
                return;
            }
            
            // 清除之前的搜索结果
            if (window.searchMarkers && window.searchMarkers.length > 0) {
                window.searchMarkers.forEach(function(marker) {
                    marker.setMap(null);
                });
            }
            window.searchMarkers = [];
            
            // 清除之前的信息窗体
            if (window.currentInfoWindow) {
                window.currentInfoWindow.close();
            }
            
            // 使用密钥管理器获取安全的API密钥
            const apiKey = keyManager.getMapKey();
            
            // 构建请求参数
            const params = {
                keywords: keyword,                           // 搜索关键词
                city: "厦门",                                // 城市
                offset: 20,                                  // 每页记录数
                page: 1,                                     // 当前页数
                key: apiKey,                                 // API密钥
                extensions: "all"                            // 返回扩展信息
            };
            
            // 如果设置了类型，添加types参数
            if (window.searchType) {
                params.types = window.searchType;
            }
            
            // 构建查询字符串
            const queryString = Object.keys(params)
                .map(key => `${key}=${encodeURIComponent(params[key])}`)
                .join('&');
            
            // 构建最终URL
            const apiUrl = `https://restapi.amap.com/v3/place/text?${queryString}`;
            
            // 发起JSONP请求，因为跨域限制无法直接使用fetch
            searchWithJSONP(apiUrl);
        }
        
        // 使用JSONP发起请求
        function searchWithJSONP(url) {
            // 创建一个唯一的回调函数名
            const callbackName = 'amapJsonpCallback_' + Math.random().toString(36).substring(2, 10);
            
            // 在window对象上定义回调函数
            window[callbackName] = function(result) {
                console.log("API响应:", result);
                try {
                    handleSearchResult(result);
                } finally {
                    // 清理全局回调
                    delete window[callbackName];
                    document.head.removeChild(script);
                }
            };
            
            // 添加回调参数到URL
            url = url + '&callback=' + callbackName;
            
            // 创建script标签
            const script = document.createElement('script');
            script.src = url;
            
            // 错误处理
            script.onerror = function() {
                console.error("API请求失败");
                alert("搜索服务请求失败，请检查网络连接");
                delete window[callbackName];
                document.head.removeChild(script);
            };
            
            // 将script标签添加到文档
            document.head.appendChild(script);
        }
        
        // 处理搜索结果
        function handleSearchResult(result) {
            if (result.status === '1' && result.pois && result.pois.length > 0) {
                console.log("搜索到", result.pois.length, "个结果");
                // 清除之前的搜索结果标记
                if (window.searchMarkers && window.searchMarkers.length > 0) {
                    window.searchMarkers.forEach(function(item) {
                        if (item && item.marker) {
                            item.marker.setMap(null);
                        }
                        if (item && item.text) {
                            item.text.setMap(null);
                        }
                    });
                }
                window.searchMarkers = [];
                
                // 获取搜索结果容器
                const searchResultsContainer = document.getElementById('search-results');
                searchResultsContainer.innerHTML = ''; // 清空之前的结果
                
                // 创建搜索结果列表
                result.pois.forEach(function(poi, index) {
                    console.log("POI信息:", index, poi.name, poi.type);
                    
                    // 创建结果项
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    
                    // 计算距离文本
                    let distanceText = '';
                    if (poi.distance) {
                        const distance = parseInt(poi.distance);
                        distanceText = distance < 1000 ? 
                            `距离 ${distance} 米` : 
                            `距离 ${(distance/1000).toFixed(1)} 公里`;
                    }
                    
                    // 设置结果项内容
                    resultItem.innerHTML = `
                        <div class="search-result-name">${poi.name}</div>
                        ${poi.address ? `<div class="search-result-address">${poi.address}</div>` : ''}
                        ${distanceText ? `<div class="search-result-distance"><i class='bx bx-walk'></i> ${distanceText}</div>` : ''}
                    `;
                    
                    // 为结果项添加点击事件
                    resultItem.addEventListener('click', function() {
                        try {
                            // 解析坐标
                            const location = poi.location.split(',');
                            const lng = parseFloat(location[0]);
                            const lat = parseFloat(location[1]);
                            
                            // 创建标记(如果不存在)
                            if (!window.searchMarkers[index]) {
                                // 创建标记图标
                                var markerIcon = new AMap.Icon({
                                    size: new AMap.Size(36, 48),  
                                    image: "https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png", // 使用红色标记
                                    imageSize: new AMap.Size(36, 48)
                                });
                                
                                // 定义自定义图标颜色，与网站主题色匹配
                                var iconColor;
                                
                                // 如果是不同类型的地点，使用不同的图标颜色
                                if (poi.type && poi.type.includes("餐饮")) {
                                    iconColor = '#FF6B00'; // 主题橙色 - 餐饮
                                } else if (poi.type && poi.type.includes("酒店")) {
                                    iconColor = '#0084FF'; // 蓝色 - 酒店
                                } else if (poi.type && poi.type.includes("景点")) {
                                    iconColor = '#FFB800'; // 黄色 - 景点
                                } else if (poi.type && poi.type.includes("购物")) {
                                    iconColor = '#9C27B0'; // 紫色 - 购物
                                } else if (poi.type && poi.type.includes("交通")) {
                                    iconColor = '#4CAF50'; // 绿色 - 交通
                                } else {
                                    iconColor = '#FF4500'; // 橙红色 - 其他
                                }
                                
                                // 创建自定义SVG图标
                                markerIcon = new AMap.Icon({
                                    size: new AMap.Size(40, 40),
                                    imageSize: new AMap.Size(40, 40),
                                    image: 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
                                        <path d="M20 0C8.96 0 0 8.96 0 20c0 17.73 20 44 20 44s20-26.27,20-44C40,8.96,31.04,0,20,0z M20,27c-3.87,0-7-3.13-7-7s3.13-7,7-7,7,3.13,7,7S23.87,27,20,27z" 
                                        fill="${iconColor}" stroke="#FFFFFF" stroke-width="2"/>
                                    </svg>`)
                                });
                                
                                // 创建垂直文本标记 - 与主标记风格一致
                                var markerHeight = 70;
                                var markerWidth = 36; // 更窄的标记
                                var fontSize = 14;
                                
                                // 创建垂直文本
                                var verticalText = '';
                                // 限制名称长度，避免标记过高
                                var displayName = poi.name.length > 8 ? poi.name.substring(0, 8) : poi.name;
                                for (var i = 0; i < displayName.length; i++) {
                                    verticalText += displayName[i] + (i < displayName.length - 1 ? '<br>' : '');
                                }
                                
                                // 创建标记
                                var marker = new AMap.Marker({
                                    position: new AMap.LngLat(lng, lat),
                                    title: poi.name,
                                    map: window.map,
                                    content: `<div style="background-color:${iconColor}; color:white; width:${markerWidth}px; height:${markerHeight}px; 
                                        border-radius:18px; text-align:center; display:flex; align-items:center; justify-content:center; 
                                        font-weight:bold; font-size:${fontSize}px; box-shadow:0 2px 6px rgba(0,0,0,0.3); padding:5px 0;">
                                        ${verticalText}
                                    </div>`,
                                    offset: new AMap.Pixel(-markerWidth/2, -markerHeight/2),
                                    animation: 'AMAP_ANIMATION_DROP',
                                    zIndex: 110
                                });
                                
                                // 不再需要额外的文本标签
                                var text = null;
                                
                                // 创建信息窗体
                                var infoWindow = new AMap.InfoWindow({
                                    content: `
                                        <div style="padding: 12px; max-width: 300px; border-radius: 8px;">
                                            <h4 style="margin:0 0 8px 0; color: ${iconColor}; font-size:16px;">${poi.name}</h4>
                                            ${poi.address ? `<p style="margin:0; font-size:12px; color:#666;"><i class='bx bx-map'></i> ${poi.address}</p>` : ''}
                                            ${poi.tel ? `<p style="margin:5px 0 0 0; font-size:12px;"><i class='bx bx-phone'></i> ${poi.tel}</p>` : ''}
                                            ${poi.distance ? `<p style="margin:5px 0 0 0; font-size:12px; color:${iconColor};"><i class='bx bx-walk'></i> 距离约 ${(parseInt(poi.distance)/1000).toFixed(1)} 公里</p>` : ''}
                                            ${poi.type ? `<p style="margin:5px 0 0 0; font-size:12px; color:#666;"><i class='bx bx-category'></i> ${poi.type}</p>` : ''}
                                        </div>
                                    `,
                                    offset: new AMap.Pixel(0, -30),
                                    closeWhenClickMap: true,
                                    isCustom: true,
                                    autoMove: true
                                });
                                
                                // 为标记添加点击事件
                                marker.on('click', function() {
                                    // 关闭之前的信息窗体
                                    if (window.currentInfoWindow) {
                                        window.currentInfoWindow.close();
                                    }
                                    
                                    infoWindow.open(window.map, marker.getPosition());
                                    window.currentInfoWindow = infoWindow;
                                });
                                
                                // 保存标记和文本标签的引用
                                var markerObj = {
                                    marker: marker
                                };
                                
                                // 如果有文本标签，保存引用
                                if (text) {
                                    markerObj.text = text;
                                }
                                
                                window.searchMarkers[index] = markerObj;
                            }
                            
                            // 关闭之前的信息窗体
                            if (window.currentInfoWindow) {
                                window.currentInfoWindow.close();
                            }
                            
                            // 打开当前标记的信息窗体
                            const currentMarkerObj = window.searchMarkers[index];
                            const currentMarker = currentMarkerObj ? currentMarkerObj.marker : null;
                            const currentInfoWindow = new AMap.InfoWindow({
                                content: `
                                    <div style="padding: 12px; max-width: 300px; border-radius: 8px;">
                                        <h4 style="margin:0 0 8px 0; color: ${iconColor}; font-size:16px;">${poi.name}</h4>
                                        ${poi.address ? `<p style="margin:0; font-size:12px; color:#666;"><i class='bx bx-map'></i> ${poi.address}</p>` : ''}
                                        ${poi.tel ? `<p style="margin:5px 0 0 0; font-size:12px;"><i class='bx bx-phone'></i> ${poi.tel}</p>` : ''}
                                        ${poi.distance ? `<p style="margin:5px 0 0 0; font-size:12px; color:${iconColor};"><i class='bx bx-walk'></i> 距离约 ${(parseInt(poi.distance)/1000).toFixed(1)} 公里</p>` : ''}
                                        ${poi.type ? `<p style="margin:5px 0 0 0; font-size:12px; color:#666;"><i class='bx bx-category'></i> ${poi.type}</p>` : ''}
                                    </div>
                                `,
                                offset: new AMap.Pixel(0, -30),
                                closeWhenClickMap: true,
                                isCustom: true,
                                autoMove: true
                            });
                            
                            currentInfoWindow.open(window.map, new AMap.LngLat(lng, lat));
                            
                            // 聚焦到当前位置 - 使用更好的定位方式
                            // 设置中心点和缩放级别，根据用户需求保持在地图中间
                            window.map.setCenter(new AMap.LngLat(lng, lat));
                            window.map.setZoomAndCenter(15, new AMap.LngLat(lng, lat), false); // 向上偏移
                            
                            // 隐藏搜索结果列表
                            document.getElementById('search-results').classList.remove('active');
                            
                        } catch (e) {
                            console.error("点击搜索结果处理失败:", e, poi);
                        }
                    });
                    
                    // 将结果项添加到容器
                    searchResultsContainer.appendChild(resultItem);
                });
                
                // 显示搜索结果列表
                searchResultsContainer.classList.add('active');
                
            } else {
                var errorMsg = "搜索失败或未找到结果";
                
                if (result.status === '0') {
                    if (result.info === 'INVALID_USER_KEY') {
                        errorMsg = "无效的API密钥。请检查您的密钥是否正确。";
                    } else if (result.info === 'DAILY_QUERY_OVER_LIMIT') {
                        errorMsg = "API密钥超过日配额限制，请明天再试或升级您的API使用量。";
                    } else {
                        errorMsg = "搜索失败: " + result.info;
                    }
                    
                    if (result.info === 'USER_KEY_PLAT_NOMATCH') {
                        // 显示API密钥提示框
                        document.getElementById('api-notice').classList.add('active');
                    }
                } else if (result.pois && result.pois.length === 0) {
                    errorMsg = "未找到相关地点，请尝试其他关键词";
                }
                
                alert(errorMsg);
                console.error("搜索结果:", result);
            }
        }
        
        // 页面加载完成后初始化地图
        window.onload = function() {
            initMap();
            initWeather();
            initTimeDisplay();
        };
        
        // 添加定位到标记的通用函数
        function focusOnMarker(markerName) {
            if (window.markers && window.markers[markerName] && window.markers[markerName].marker) {
                // 获取标记位置
                const pos = window.markers[markerName].marker.getPosition();
                
                // 设置中心点
                window.map.setCenter(pos);
                
                // 设置缩放级别
                const zoom = window.markers[markerName].type === 'hotel' ? 15 : 14;
                window.map.setZoomAndCenter(zoom, pos, false);
                
                // 触发标记点击事件，显示信息窗体
                if (window.AMap && window.AMap.event && typeof window.AMap.event.trigger === 'function') {
                    window.AMap.event.trigger(window.markers[markerName].marker, 'click');
                }
                
                return true;
            }
            return false;
        }
        
        // 加载html2canvas库
        function loadHtml2Canvas() {
            return new Promise((resolve, reject) => {
                if (window.html2canvas) {
                    resolve(window.html2canvas);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
                script.onload = () => resolve(window.html2canvas);
                script.onerror = () => reject(new Error('Failed to load html2canvas'));
                document.head.appendChild(script);
            });
        }
        
        // 显示备用方案函数
        function showPrintAlternative() {
            const alternativeSolution = document.createElement('div');
            alternativeSolution.style.position = 'fixed';
            alternativeSolution.style.top = '50%';
            alternativeSolution.style.left = '50%';
            alternativeSolution.style.transform = 'translate(-50%, -50%)';
            alternativeSolution.style.backgroundColor = 'white';
            alternativeSolution.style.padding = '20px';
            alternativeSolution.style.borderRadius = '10px';
            alternativeSolution.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
            alternativeSolution.style.zIndex = '10000';
            alternativeSolution.style.maxWidth = '600px';
            alternativeSolution.style.width = '90%';
            alternativeSolution.innerHTML = `
                <h3 style="color: #FF6B00; margin-top: 0;">截图功能暂时不可用</h3>
                <p>由于浏览器限制或者页面复杂度较高，截图功能暂时无法使用。我们建议您尝试以下备用方案：</p>
                <ol>
                    <li>使用打印功能将网页保存为PDF</li>
                    <li>使用浏览器自带的截图工具</li>
                    <li>使用FireShot等专业截图插件</li>
                </ol>
                <p>点击下方按钮使用打印功能：</p>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button id="proceed-to-print-alt" style="background-color: #FF6B00; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1; margin-right: 10px;">打印为PDF</button>
                    <button id="cancel-print-alt" style="background-color: #999; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1; margin-left: 10px;">取消</button>
                </div>
            `;
            document.body.appendChild(alternativeSolution);
            
            document.getElementById('proceed-to-print-alt').addEventListener('click', function() {
                document.body.removeChild(alternativeSolution);
                window.print();
            });
            
            document.getElementById('cancel-print-alt').addEventListener('click', function() {
                document.body.removeChild(alternativeSolution);
            });
        }
        
        // 逐个处理标签页
        
        // 逐个处理标签页
        async function processNextTab(tabs, index, originalActiveItems, originalActiveContents, html2canvas) {
            if (index >= tabs.length) {
                // 恢复原始活动标签
                originalActiveItems.forEach(item => item.classList.add('active'));
                originalActiveContents.forEach(content => content.classList.add('active'));
                
                showExportLoading(false);
                showExportStatus('所有标签页内容导出完成！', 'success');
                return;
            }
            
            const currentTab = tabs[index];
            const tabName = currentTab.textContent.trim();
            
            // 移除所有活动状态
            document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.day-content').forEach(content => content.classList.remove('active'));
            
            // 激活当前标签
            currentTab.classList.add('active');
            
            // 获取关联的内容ID
            const dayId = currentTab.getAttribute('data-day');
            const foodDayId = currentTab.getAttribute('data-food-day');
            const contentId = dayId || foodDayId;
            
            if (contentId) {
                const content = document.getElementById(contentId);
                if (content) {
                    content.classList.add('active');
                }
            }
            
            // 延迟执行以确保DOM更新
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 确定要截图的元素
            let targetElement;
            if (dayId) {
                targetElement = document.querySelector('.itinerary');
            } else if (foodDayId) {
                targetElement = document.querySelector('.food-card');
            } else {
                // 如果无法确定元素，跳到下一个
                await processNextTab(tabs, index + 1, originalActiveItems, originalActiveContents, html2canvas);
                return;
            }
            
            try {
                // 处理本地图片跨域问题
                const images = targetElement.querySelectorAll('img');
                const originalSrcs = [];
                
                // 备份原始图片路径并替换为占位符
                for (let i = 0; i < images.length; i++) {
                    originalSrcs.push(images[i].src);
                    if (images[i].src.startsWith('file://') || images[i].src.includes('image/')) {
                        // 替换为占位图片
                        images[i].setAttribute('data-original-src', images[i].src);
                        images[i].src = 'data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22' + 
                                      (images[i].width || 300) + '%22%20height%3D%22' + (images[i].height || 200) + 
                                      '%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23f5f5f5%22%2F%3E%3Ctext%20x%3D%2250%25%22%20' + 
                                      'y%3D%2250%25%22%20dominant-baseline%3D%22middle%22%20text-anchor%3D%22middle%22%20font-family%3D%22Arial%22%20font-size%3D%2214%22%20fill%3D%22%23999%22%3E' + 
                                      images[i].alt + '%3C%2Ftext%3E%3C%2Fsvg%3E';
                    }
                }
                
                // 捕获当前标签页内容
                const canvas = await html2canvas(targetElement, {
                    allowTaint: false,
                    useCORS: true,
                    scale: 1,
                    logging: true,
                    backgroundColor: '#ffffff',
                    foreignObjectRendering: false,
                    removeContainer: true
                });
                
                // 恢复原始图片路径
                for (let i = 0; i < images.length; i++) {
                    if (images[i].hasAttribute('data-original-src')) {
                        images[i].src = images[i].getAttribute('data-original-src');
                        images[i].removeAttribute('data-original-src');
                    }
                }
                
                try {
                    // 创建下载链接
                    const downloadLink = document.createElement('a');
                    downloadLink.href = canvas.toDataURL('image/png');
                    downloadLink.download = `厦门旅游指南_${tabName}.png`;
                    downloadLink.textContent = `下载${tabName}内容截图`;
                    downloadLink.style.display = 'block';
                    downloadLink.style.margin = '10px 0';
                    downloadLink.style.padding = '8px';
                    downloadLink.style.backgroundColor = '#0084FF';
                    downloadLink.style.color = 'white';
                    downloadLink.style.textDecoration = 'none';
                    downloadLink.style.borderRadius = '5px';
                    downloadLink.style.textAlign = 'center';
                    
                    // 添加到下载区域
                    const downloadLinks = document.getElementById('export-download-links');
                    if (downloadLinks) {
                        downloadLinks.appendChild(downloadLink);
                    }
                } catch (err) {
                    console.error(`${tabName}截图生成成功，但无法创建下载链接:`, err);
                    
                    // 显示截图结果
                    const imgContainer = document.createElement('div');
                    imgContainer.style.maxWidth = '100%';
                    imgContainer.style.overflow = 'auto';
                    imgContainer.style.border = '1px solid #ddd';
                    imgContainer.style.padding = '10px';
                    imgContainer.style.marginTop = '10px';
                    imgContainer.appendChild(canvas);
                    
                    const downloadLinks = document.getElementById('export-download-links');
                    if (downloadLinks) {
                        downloadLinks.appendChild(document.createTextNode(`${tabName}内容截图（右键点击并选择"图片另存为"保存）：`));
                        downloadLinks.appendChild(imgContainer);
                    }
                }
            } catch (err) {
                console.error(`${tabName}截图失败:`, err);
                
                // 恢复原始图片路径
                const images = targetElement.querySelectorAll('img');
                for (let i = 0; i < images.length; i++) {
                    if (images[i].hasAttribute('data-original-src')) {
                        images[i].src = images[i].getAttribute('data-original-src');
                        images[i].removeAttribute('data-original-src');
                    }
                }
            }
            
            // 处理下一个标签页
            await processNextTab(tabs, index + 1, originalActiveItems, originalActiveContents, html2canvas);
        }
        
        // 等待DOM完全加载后再初始化导出工具
        document.addEventListener('DOMContentLoaded', function() {
            // 防止重复初始化
            if (!window.exportToolInitialized) {
                window.exportToolInitialized = true;
                initExportTool();
                
                // 初始化导出按钮的事件监听器
                initExportButtonListeners();
            }
        });
        
        // 初始化导出按钮的事件监听器
        function initExportButtonListeners() {
            // 不需要初始化任何导出按钮，因为我们已经移除了这些按钮
            console.log('导出按钮初始化 - 已经移除，只保留显示全文内容按钮');
        }
        
        // 定义全局变量用于存储元素原始状态
        let originalStates;
        
        // 截图导出处理函数
        async function handleCaptureClick() {
            showExportLoading(true);
            showExportStatus('正在准备页面截图，请稍候...', 'info');
            
            try {
                // 初始化originalStates
                originalStates = {
                    images: new Map(),
                    backgroundElements: new Map(),
                    iframes: new Map(),
                    canvases: new Map()
                };
                // 暂时隐藏导出工具
                const exportTool = document.getElementById('export-tool');
                const exportToolButton = document.getElementById('show-export-tool');
                exportTool.style.display = 'none';
                exportToolButton.style.display = 'none';
                
                // 获取所有标签页内容元素
                const dayContents = document.querySelectorAll('.day-content');
                
                // 备份当前激活状态
                const activeContents = Array.from(document.querySelectorAll('.day-content.active')).map(el => el.id);
                const activeTabs = Array.from(document.querySelectorAll('.tab-item.active')).map(el => {
                    return el.getAttribute('data-day') || el.getAttribute('data-food-day');
                });
                
                // 使所有内容可见以便截图
                dayContents.forEach(function(content) {
                    content.classList.add('active');
                });
                
                // 加载html2canvas库
                const html2canvas = await loadHtml2Canvas();
                
                // 检查页面高度，是否需要使用分段技术
                const bodyHeight = document.body.scrollHeight;
                const isLargePage = bodyHeight > 15000; // 判断是否为特大页面
                
                // 准备页面，隐藏干扰元素
                const elementsToHide = document.querySelectorAll('.search-container, #map-loading, .api-notice');
                elementsToHide.forEach(el => {
                    if (el) el.style.display = 'none';
                });
                
                // 如果是特大页面，临时隐藏不需要的内容以减小页面大小
                if (isLargePage) {
                    // 创建一个提示，告知用户正在处理大页面
                    progressText.insertAdjacentHTML('afterend', 
                        '<p style="font-size: 12px; color: #777;">检测到页面内容较多，优化处理中...</p>');
                    
                    // 创建临时样式，提高页面渲染性能
                    const tempStyle = document.createElement('style');
                    tempStyle.id = 'temp-screenshot-style';
                    tempStyle.textContent = `
                        .map-container { height: 300px !important; overflow: hidden; }
                        iframe { max-height: 200px !important; }
                        img { max-height: 600px !important; }
                    `;
                    document.head.appendChild(tempStyle);
                    
                    // 待截图完成后移除临时样式
                    setTimeout(() => {
                        const styleToRemove = document.getElementById('temp-screenshot-style');
                        if (styleToRemove) document.head.removeChild(styleToRemove);
                    }, 10000);
                }
                
                // 移除所有可能导致跨域问题的元素
                // 创建一个简单的纯色占位符
                const placeholderSVG = `data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 100"><rect width="100%" height="100%" fill="%23f0f0f0"/><text x="50%" y="50%" font-family="Arial" font-size="14" text-anchor="middle" fill="%23999">图片</text></svg>`;
                const placeholderCSS = "background-color: #f0f0f0 !important; background-image: none !important;";
                
                // 备份所有需要恢复的元素信息 - 已在函数开始时初始化
                
                // 提前禁用所有图像加载，防止跨域错误
                document.querySelectorAll('img').forEach(img => {
                    // 保存额外的属性和样式信息
                    if (img.style.cssText) {
                        img.setAttribute('data-original-style', img.style.cssText);
                    }
                    // 阻止图像重新加载
                    img.setAttribute('loading', 'lazy');
                });
                
                // 创建一个临时样式，阻止所有背景图片和图片加载
                const tempStyle = document.createElement('style');
                tempStyle.id = 'temp-screenshot-style';
                tempStyle.textContent = `
                    img {
                        background-color: #f0f0f0 !important;
                        min-width: 50px !important;
                        min-height: 50px !important;
                    }
                    [style*="background-image"] {
                        background-image: none !important;
                        background-color: #f0f0f0 !important;
                    }
                `;
                document.head.appendChild(tempStyle);
                
                // 处理所有图片元素
                const images = document.querySelectorAll('img');
                images.forEach(img => {
                    try {
                        if (!img.src.startsWith('data:')) {
                            // 保存原始图片信息
                            originalStates.images.set(img, {
                                src: img.src,
                                width: img.width || 100,
                                height: img.height || 100,
                                styleDisplay: img.style.display
                            });
                            
                            // 替换为本地安全的SVG占位符
                            img.src = placeholderSVG;
                            
                            // 保持原始尺寸并强制显示
                            const width = originalStates.images.get(img).width;
                            const height = originalStates.images.get(img).height;
                            img.style.width = (width > 10 ? width : 100) + 'px';
                            img.style.height = (height > 10 ? height : 100) + 'px';
                            img.style.display = 'inline-block';
                            img.style.backgroundColor = '#f0f0f0';
                            img.style.border = '1px dashed #ccc';
                            
                            // 添加内容标识
                            if (img.alt) {
                                // 创建一个标签显示图片原来的alt文本
                                const label = document.createElement('span');
                                label.textContent = img.alt;
                                label.style.position = 'absolute';
                                label.style.top = '50%';
                                label.style.left = '50%';
                                label.style.transform = 'translate(-50%, -50%)';
                                label.style.color = '#999';
                                label.style.fontSize = '12px';
                                label.style.textAlign = 'center';
                                label.style.pointerEvents = 'none';
                                
                                // 确保图片容器是相对定位的
                                img.style.position = 'relative';
                                img.parentNode.insertBefore(label, img.nextSibling);
                                
                                // 保存标签以便后续恢复
                                originalStates.images.get(img).label = label;
                            }
                        }
                    } catch (err) {
                        console.warn("替换图片失败:", err);
                    }
                });
                
                // 处理背景图片
                const elementsWithBackgroundImage = Array.from(document.querySelectorAll('*')).filter(el => {
                    const style = window.getComputedStyle(el);
                    return style.backgroundImage && style.backgroundImage !== 'none' && !style.backgroundImage.startsWith('url("data:');
                });
                
                elementsWithBackgroundImage.forEach(el => {
                    try {
                        // 保存原始背景信息
                        originalStates.backgroundElements.set(el, {
                            backgroundImage: el.style.backgroundImage,
                            cssText: el.style.cssText
                        });
                        
                        // 移除背景图片
                        el.style.cssText += placeholderCSS;
                    } catch (err) {
                        console.warn("处理背景图片失败:", err);
                    }
                });
                
                // 处理iframe元素
                const iframes = document.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    try {
                        // 保存原始iframe信息
                        originalStates.iframes.set(iframe, {
                            src: iframe.src,
                            srcdoc: iframe.srcdoc
                        });
                        
                        // 替换为空白内容
                        iframe.src = "about:blank";
                        iframe.srcdoc = "<html><body style='background:#f0f0f0'><p style='text-align:center;color:#999'>iframe 内容</p></body></html>";
                    } catch (err) {
                        console.warn("处理iframe失败:", err);
                    }
                });
                
                // 处理canvas元素
                const canvases = document.querySelectorAll('canvas');
                canvases.forEach(canvas => {
                    try {
                        const ctx = canvas.getContext('2d');
                        if (ctx) {
                            // 保存canvas数据
                            try {
                                originalStates.canvases.set(canvas, {
                                    dataUrl: canvas.toDataURL()
                                });
                            } catch (e) {
                                // 已经被污染的canvas无法获取数据，忽略错误
                            }
                            
                            // 清空并绘制占位符
                            ctx.fillStyle = "#f0f0f0";
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.fillStyle = "#999";
                            ctx.font = "14px Arial";
                            ctx.textAlign = "center";
                            ctx.fillText("画布内容", canvas.width/2, canvas.height/2);
                        }
                    } catch (err) {
                        console.warn("处理canvas失败:", err);
                    }
                });
                
                // 创建一个状态提示对话框
                const statusDialog = document.createElement('div');
                statusDialog.style.position = 'fixed';
                statusDialog.style.top = '50%';
                statusDialog.style.left = '50%';
                statusDialog.style.transform = 'translate(-50%, -50%)';
                statusDialog.style.backgroundColor = 'white';
                statusDialog.style.padding = '20px';
                statusDialog.style.borderRadius = '10px';
                statusDialog.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
                statusDialog.style.zIndex = '10000';
                statusDialog.style.maxWidth = '400px';
                statusDialog.style.width = '90%';
                statusDialog.style.textAlign = 'center';
                statusDialog.innerHTML = `
                    <h3 style="color: #FF6B00; margin-top: 0;">正在生成完整页面截图</h3>
                    <div style="margin: 20px 0;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(255, 107, 0, 0.3); border-radius: 50%; border-top-color: #FF6B00; animation: spin 1s ease-in-out infinite;"></div>
                        <p style="margin-top: 15px;">页面截图处理中，请稍候...</p>
                        <p style="font-size: 12px; color: #777;">截图较大时可能需要30秒左右</p>
                    </div>
                    <div id="screenshot-progress" style="width: 100%; height: 10px; background-color: #f0f0f0; border-radius: 5px; overflow: hidden; margin-top: 15px;">
                        <div id="screenshot-progress-bar" style="width: 0%; height: 100%; background-color: #FF6B00; transition: width 0.5s;"></div>
                    </div>
                    <p id="screenshot-progress-text" style="font-size: 12px; color: #777; margin-top: 5px;">0%</p>
                `;
                document.body.appendChild(statusDialog);
                
                // 获取进度条元素
                const progressBar = document.getElementById('screenshot-progress-bar');
                const progressText = document.getElementById('screenshot-progress-text');
                
                // 真正的FireShot风格的完整页面截图方法 - 借鉴FireShot的渐进渲染机制
                async function captureFullPage() {
                    // 加入延迟函数，使用Promise确保每一步都能等待足够时间
                    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
                    
                    // 显示状态更新
                    progressText.innerText = "准备中...";
                    progressBar.style.width = '5%';
                    
                    // 强制等待页面完全加载
                    await delay(500);
                    
                    // 计算实际页面尺寸 - 多次测量取最大值以确保准确性
                    let pageHeight = 0;
                    let pageWidth = 0;
                    
                    // 多次测量页面尺寸，取最大值，确保获取正确尺寸
                    for (let i = 0; i < 3; i++) {
                        const body = document.body;
                        const html = document.documentElement;
                        
                        // 测量当前尺寸
                        const currentHeight = Math.max(
                            body.scrollHeight, body.offsetHeight,
                            html.clientHeight, html.scrollHeight, html.offsetHeight
                        );
                        const currentWidth = Math.max(
                            body.scrollWidth, body.offsetWidth,
                            html.clientWidth, html.scrollWidth, html.offsetWidth
                        );
                        
                        // 取最大值
                        pageHeight = Math.max(pageHeight, currentHeight);
                        pageWidth = Math.max(pageWidth, currentWidth);
                        
                        // 在测量之间等待，允许任何异步加载内容完成
                        await delay(100);
                    }
                    
                    progressText.innerText = "测量页面尺寸完成: " + pageWidth + "x" + pageHeight + "px";
                    progressBar.style.width = '10%';
                    
                    // 保存当前滚动位置
                    const originalScrollPos = window.pageYOffset;
                    
                    // 添加一个可视指示器，展示当前捕获区域（开发模式）
                    let captureIndicator = null;
                    const enableCaptureIndicator = false; // 设为true可用于调试
                    if (enableCaptureIndicator) {
                        captureIndicator = document.createElement('div');
                        captureIndicator.style.cssText = `
                            position: absolute;
                            border: 2px solid red;
                            background-color: rgba(255,0,0,0.1);
                            pointer-events: none;
                            z-index: 9999;
                            transition: all 0.3s ease;
                        `;
                        document.body.appendChild(captureIndicator);
                    }
                    
                    // 创建一个画布以容纳整个页面
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = window.devicePixelRatio || 1;
                    
                    // 创建稍大一点的画布以避免任何内容被裁剪
                    const safetyMargin = 100 * scale;
                    canvas.width = (pageWidth + 50) * scale;  // 添加50px边距
                    canvas.height = (pageHeight + 50) * scale; // 添加50px边距
                    ctx.scale(scale, scale);
                    
                    // 填充白色背景
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // FireShot使用的是视口高度的动态计算，我们这里也采用类似方法
                    // 这个变量非常重要，它被多个地方引用，不要重命名或删除
                    const viewportHeight = window.innerHeight; // 当前浏览器视口高度
                    // 添加重叠区域以确保无缝拼接 (FireShot使用的是100-200px的重叠)
                    const overlap = Math.round(viewportHeight * 0.2); // 视口高度的20%作为重叠
                    // 计算滚动步长，考虑重叠
                    const scrollStep = viewportHeight - overlap;
                    // 计算总滚动次数
                    const totalScrolls = Math.ceil(pageHeight / scrollStep);
                    
                    // 更新进度
                    progressText.innerText = `准备分段捕获: 总共${totalScrolls}个片段`;
                    progressBar.style.width = '15%';
                    
                    // 配置html2canvas选项
                    const options = {
                        scale: scale,
                        allowTaint: true,
                        useCORS: true,
                        logging: false,
                        scrollY: 0,
                        width: pageWidth,
                        height: pageHeight,
                        windowWidth: document.documentElement.offsetWidth,
                        windowHeight: viewportHeight,
                        // 提高渲染质量
                        backgroundColor: '#ffffff', // 使用白色背景
                        // 图像处理
                        imageTimeout: 0,
                        foreignObjectRendering: false, // 禁用foreignObject，避免跨域问题
                        removeContainer: true, // 捕获完成后自动移除临时容器
                        ignoreElements: (element) => {
                            // 忽略导出工具和动态添加的元素
                            return element.id === 'export-tool' || 
                                   element.id === 'show-export-tool' || 
                                   element.id === 'export-loading' || 
                                   element.id === 'export-status' ||
                                   element.id === 'statusDialog' ||
                                   element.classList.contains('loading-indicator');
                        },
                        // 关闭辅助工具以避免干扰
                        onclone: (clonedDoc) => {
                            // 隐藏不需要的元素
                            const elementsToHide = clonedDoc.querySelectorAll('#export-tool, #show-export-tool, #export-loading, #export-status');
                            elementsToHide.forEach(el => {
                                if (el) el.style.display = 'none';
                            });
                            
                            // 为每个图片元素添加占位符
                            clonedDoc.querySelectorAll('img').forEach(img => {
                                if (!img.complete || img.naturalHeight === 0) {
                                    img.style.backgroundColor = '#f0f0f0';
                                    img.style.border = '1px dashed #ccc';
                                }
                            });
                        }
                    };
                    
                    try {
                        // FireShot的核心是分段渲染与等待策略
                        
                        // 1. 预先添加页面渲染防止样式干扰
                        document.documentElement.style.scrollBehavior = 'auto'; // 禁用平滑滚动
                        
                        // 2. 保留原始样式值以便后续恢复
                        const originalScrollBehavior = document.documentElement.style.scrollBehavior;
                        const originalBodyHeight = document.body.style.height;
                        
                        // 3. 确保所有内容都可见
                        document.body.style.height = `${pageHeight + 200}px`;
                        
                        // 4. FireShot的分段策略 - 使用视口高度而非固定值
                        // 添加渲染延迟函数 - FireShot会根据页面复杂度动态调整延迟
                        const getScrollDelay = () => {
                            // 判断页面复杂度的简单方法
                            const imageCount = document.querySelectorAll('img').length;
                            const elementCount = document.querySelectorAll('*').length;
                            
                            // 根据页面元素数量和图片数量动态调整延迟
                            if (imageCount > 50 || elementCount > 3000) {
                                return 1000; // 复杂页面
                            } else if (imageCount > 20 || elementCount > 1000) {
                                return 800;  // 中等复杂度
                            }
                            return 600;      // 简单页面
                        };
                        
                        const scrollDelay = getScrollDelay();
                        progressText.innerText = `页面复杂度评估完成，滚动延迟设为: ${scrollDelay}ms`;
                        
                        // 5. 逐段捕获页面
                        let capturedHeight = 0;
                        
                        // 先滚动到顶部
                        window.scrollTo(0, 0);
                        await delay(600); // 给足够时间让页面顶部完全加载
                        
                        // 逐段滚动捕获
                        for (let i = 0; i < totalScrolls; i++) {
                            // 计算当前滚动位置
                            const scrollPosition = i * scrollStep;
                            
                            // 更新进度指示器
                            const progress = Math.round(15 + ((i + 0.2) / totalScrolls) * 70);  // 15%-85%之间
                            progressBar.style.width = `${progress}%`;
                            progressText.innerText = `正在捕获 (${i+1}/${totalScrolls}) - ${progress}%`;
                            
                            // FireShot风格的指示器显示当前捕获区域
                            if (enableCaptureIndicator) {
                                captureIndicator.style.top = scrollPosition + 'px';
                                captureIndicator.style.left = '0px';
                                captureIndicator.style.width = pageWidth + 'px';
                                captureIndicator.style.height = (viewportHeight) + 'px';
                            }
                            
                            // 滚动到指定位置
                            window.scrollTo(0, scrollPosition);
                            
                            // 给页面足够的时间来加载和渲染
                            // FireShot有特殊的等待策略，等到页面完全稳定
                            await delay(scrollDelay);
                            
                            // 创建段落的捕获选项 - 类似FireShot的设置
                            const segmentOptions = {
                                ...options,
                                scrollY: -scrollPosition,
                                windowWidth: pageWidth,
                                windowHeight: viewportHeight + overlap, // 包括重叠区域
                                height: viewportHeight + overlap,
                                x: 0,
                                y: 0
                            };
                            
                            try {
                                // FireShot风格的渐进式捕获和拼接
                                // 每次捕获当前可见部分，精确定位拼接位置
                                
                                // 1. 捕获当前视口内容
                                const segmentCanvas = await html2canvas(document.documentElement, segmentOptions);
                                
                                // 2. 计算拼接位置 (FireShot使用精确定位)
                                // 如果是首个片段，直接从顶部开始
                                // 否则从准确的滚动位置开始精确拼接
                                const destY = Math.max(0, scrollPosition);
                                
                                // 3. 计算需要的源区域 - 避免重复内容
                                // 首个片段完整使用，后续片段跳过顶部的重叠区域
                                const sourceY = (i === 0) ? 0 : 0;
                                const drawHeight = (i === 0) ? viewportHeight : viewportHeight;
                                
                                // 4. FireShot风格的精确拼接
                                // 更新进度指示
                                const mergeProgress = Math.round(15 + ((i + 0.8) / totalScrolls) * 70);
                                progressBar.style.width = `${mergeProgress}%`;
                                progressText.innerText = `拼接片段 (${i+1}/${totalScrolls}) - ${mergeProgress}%`;
                                
                                // 绘制到主画布
                                ctx.drawImage(
                                    segmentCanvas,
                                    0, sourceY,       // 源位置 
                                    pageWidth, drawHeight,  // 源尺寸
                                    0, destY,         // 目标位置
                                    pageWidth, drawHeight   // 目标尺寸
                                );
                                
                                // 5. FireShot的内存优化 - 清理不再需要的资源
                                // 防止内存泄漏
                                segmentCanvas.width = 1;
                                segmentCanvas.height = 1;
                                
                                // 记录已成功捕获的高度
                                capturedHeight = Math.max(capturedHeight, scrollPosition + viewportHeight);
                                
                                // 短暂延迟，允许浏览器处理其他任务
                                await delay(50);
                                
                            } catch (segError) {
                                console.warn(`段落 ${i + 1} 捕获失败:`, segError);
                                
                                // FireShot风格的错误恢复处理
                                try {
                                    // 分割当前视口高度为更小的片段
                                    progressText.innerText = `片段${i+1}捕获失败，尝试分段恢复...`;
                                    
                                    // 1. 分割当前视口高度
                                    const subHeight = Math.floor(viewportHeight / 2);
                                    
                                    // 2. 捕获上半部分
                                    window.scrollTo(0, scrollPosition);
                                    await delay(400);
                                    
                                    const upperOptions = {
                                        ...segmentOptions,
                                        height: subHeight,
                                        windowHeight: subHeight
                                    };
                                    
                                    const upperCanvas = await html2canvas(document.documentElement, upperOptions);
                                    
                                    // 3. 绘制上半部分
                                    ctx.drawImage(
                                        upperCanvas,
                                        0, 0,                 // 源位置
                                        pageWidth, subHeight, // 源尺寸
                                        0, scrollPosition,    // 目标位置
                                        pageWidth, subHeight  // 目标尺寸
                                    );
                                    
                                    // 清理资源
                                    upperCanvas.width = 1;
                                    upperCanvas.height = 1;
                                    
                                    // 4. 捕获下半部分
                                    window.scrollTo(0, scrollPosition + subHeight - 50); // 50px的额外重叠
                                    await delay(400);
                                    
                                    const lowerOptions = {
                                        ...segmentOptions,
                                        scrollY: -(scrollPosition + subHeight - 50),
                                        height: subHeight + 50,
                                        windowHeight: subHeight + 50
                                    };
                                    
                                    const lowerCanvas = await html2canvas(document.documentElement, lowerOptions);
                                    
                                    // 5. 绘制下半部分
                                    ctx.drawImage(
                                        lowerCanvas,
                                        0, 50,                    // 源位置 (跳过50px重叠)
                                        pageWidth, subHeight,     // 源尺寸
                                        0, scrollPosition + subHeight, // 目标位置
                                        pageWidth, subHeight      // 目标尺寸
                                    );
                                    
                                    // 清理资源
                                    lowerCanvas.width = 1;
                                    lowerCanvas.height = 1;
                                    
                                    // 更新捕获高度
                                    capturedHeight = Math.max(capturedHeight, scrollPosition + viewportHeight);
                                } catch (fallbackError) {
                                    console.error(`段落 ${i+1} 恢复捕获也失败:`, fallbackError);
                                    // 继续处理下一个段落
                                }
                                
                                // 防止浏览器崩溃，给予喘息时间
                                await delay(100);
                            }
                        }
                        
                        // FireShot风格的收尾工作
                        progressBar.style.width = '85%';
                        progressText.innerText = `拼接完成，进行后期处理...`;
                        
                        // 恢复原始样式
                        document.documentElement.style.scrollBehavior = originalScrollBehavior;
                        document.body.style.height = originalBodyHeight;
                        
                        // 移除调试指示器
                        if (enableCaptureIndicator && captureIndicator && captureIndicator.parentNode) {
                            captureIndicator.parentNode.removeChild(captureIndicator);
                        }
                    } catch (error) {
                        console.error('捕获页面过程中发生错误:', error);
                        
                        // 尝试使用单次捕获方法 - 更稳定的方式
                        progressBar.style.width = '50%';
                        progressText.innerText = '50%';
                        progressText.insertAdjacentHTML('afterend', '<p style="font-size: 12px; color: #777;">分段捕获失败，尝试优化捕获...</p>');
                        
                        // 先备份原始文档滚动
                        const originalOverflow = document.documentElement.style.overflow;
                        const originalPosition = document.documentElement.style.position;
                        
                        // 修改文档样式以更好地捕获
                        document.documentElement.style.overflow = 'visible';
                        document.documentElement.style.position = 'static';
                        
                        // 滚回顶部以捕获完整页面
                        window.scrollTo(0, 0);
                        await new Promise(resolve => setTimeout(resolve, 800)); // 给足够时间让页面稳定
                        
                        // 使用优化配置重新尝试捕获
                        const fallbackOptions = {
                            scale: scale,
                            allowTaint: true,
                            useCORS: true,
                            width: pageWidth,
                            height: pageHeight,
                            windowWidth: pageWidth,
                            windowHeight: pageHeight,  // 使用全页面高度
                            scrollX: 0,
                            scrollY: 0,
                            x: 0,
                            y: 0,
                            backgroundColor: '#ffffff',
                            removeContainer: true,
                            imageTimeout: 0,
                            ignoreElements: (element) => {
                                return element.id === 'export-tool' || 
                                       element.id === 'show-export-tool' || 
                                       element.id === 'export-loading' || 
                                       element.id === 'export-status' ||
                                       element.id === 'statusDialog';
                            },
                            foreignObjectRendering: false,
                            onclone: (clonedDoc) => {
                                // 隐藏不需要的元素
                                clonedDoc.querySelectorAll('#export-tool, #show-export-tool, #export-loading, #export-status, #statusDialog').forEach(el => {
                                    if (el) el.style.display = 'none';
                                });
                                
                                // 确保所有内容可见
                                clonedDoc.querySelectorAll('.day-content').forEach(content => {
                                    content.style.display = 'block';
                                    content.style.height = 'auto';
                                    content.style.overflow = 'visible';
                                    content.style.opacity = '1';
                                });
                            }
                        };
                        
                        const fallbackCanvas = await html2canvas(document.body, fallbackOptions);
                        
                        // 恢复原始文档样式
                        document.documentElement.style.overflow = originalOverflow;
                        document.documentElement.style.position = originalPosition;
                        
                        // 绘制到主画布
                        ctx.drawImage(fallbackCanvas, 0, 0);
                        
                        // 显示捕获完成
                        progressBar.style.width = '90%';
                        progressText.innerText = '90%';
                    }
                    
                    // 恢复原始滚动位置
                    window.scrollTo(0, originalScrollPos);
                    
                    // 恢复所有原始元素状态
                    // 首先移除临时样式
                    const tempStyleToRemove = document.getElementById('temp-screenshot-style');
                    if (tempStyleToRemove) {
                        document.head.removeChild(tempStyleToRemove);
                    }
                    
                    // 恢复图片
                    originalStates.images.forEach((state, img) => {
                        if (img && state.src) {
                            // 恢复原始src
                            img.src = state.src;
                            
                            // 恢复原始尺寸
                            if (state.width) img.width = state.width;
                            if (state.height) img.height = state.height;
                            
                            // 清除添加的样式
                            img.style.width = '';
                            img.style.height = '';
                            img.style.display = state.styleDisplay || '';
                            img.style.backgroundColor = '';
                            img.style.border = '';
                            img.style.position = '';
                            
                            // 恢复原始样式
                            if (img.hasAttribute('data-original-style')) {
                                img.style.cssText = img.getAttribute('data-original-style');
                                img.removeAttribute('data-original-style');
                            }
                            
                            // 移除loading属性
                            img.removeAttribute('loading');
                            
                            // 删除添加的标签
                            if (state.label && state.label.parentNode) {
                                state.label.parentNode.removeChild(state.label);
                            }
                        }
                    });
                    
                    // 恢复背景图片
                    originalStates.backgroundElements.forEach((state, el) => {
                        if (el && state.cssText) {
                            el.style.cssText = state.cssText;
                        }
                    });
                    
                    // 恢复iframe
                    originalStates.iframes.forEach((state, iframe) => {
                        if (iframe && state.src) {
                            iframe.src = state.src;
                            if (state.srcdoc) iframe.srcdoc = state.srcdoc;
                        }
                    });
                    
                    // 恢复canvas
                    originalStates.canvases.forEach((state, canvas) => {
                        if (canvas && state.dataUrl) {
                            try {
                                const img = new Image();
                                img.onload = () => {
                                    const ctx = canvas.getContext('2d');
                                    if (ctx) {
                                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                                        ctx.drawImage(img, 0, 0);
                                    }
                                };
                                img.src = state.dataUrl;
                            } catch (e) {
                                console.warn('恢复canvas失败:', e);
                            }
                        }
                    });
                    
                    // 完成进度显示
                    progressBar.style.width = '100%';
                    progressText.innerText = '100%';
                    
                    // 增加额外的后处理：增强对比度和清晰度
                    try {
                        // 创建一个新画布以应用后处理效果
                        const enhancedCanvas = document.createElement('canvas');
                        enhancedCanvas.width = canvas.width;
                        enhancedCanvas.height = canvas.height;
                        const enhancedCtx = enhancedCanvas.getContext('2d');
                        
                        // 绘制原始图像
                        enhancedCtx.drawImage(canvas, 0, 0);
                        
                        // 应用优化效果
                        try {
                            // 尝试应用轻微锐化
                            const imageData = enhancedCtx.getImageData(0, 0, enhancedCanvas.width, enhancedCanvas.height);
                            const data = imageData.data;
                            
                            // 轻微调整对比度
                            const contrast = 1.1; // 轻微增强对比度值
                            const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
                            
                            for (let i = 0; i < data.length; i += 4) {
                                // 对比度调整
                                data[i] = factor * (data[i] - 128) + 128;     // 红色
                                data[i+1] = factor * (data[i+1] - 128) + 128; // 绿色
                                data[i+2] = factor * (data[i+2] - 128) + 128; // 蓝色
                            }
                            
                            enhancedCtx.putImageData(imageData, 0, 0);
                            return enhancedCanvas;
                        } catch (enhanceError) {
                            console.warn('图像增强处理失败，使用原始截图:', enhanceError);
                            return canvas;
                        }
                    } catch (error) {
                        console.warn('后处理失败，使用原始截图:', error);
                        return canvas;
                    }
                }
                
                try {
                    // 捕获完整页面
                    const canvas = await captureFullPage();
                    
                    // 移除状态对话框
                    document.body.removeChild(statusDialog);
                    
                    // 显示结果对话框
                    const resultDialog = document.createElement('div');
                    resultDialog.style.position = 'fixed';
                    resultDialog.style.top = '50%';
                    resultDialog.style.left = '50%';
                    resultDialog.style.transform = 'translate(-50%, -50%)';
                    resultDialog.style.backgroundColor = 'white';
                    resultDialog.style.padding = '20px';
                    resultDialog.style.borderRadius = '10px';
                    resultDialog.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
                    resultDialog.style.zIndex = '10000';
                    resultDialog.style.maxWidth = '600px';
                    resultDialog.style.width = '90%';
                    
                    // 创建缩略图预览（缩小尺寸以适应对话框）
                    const scaleFactor = 0.2; // 缩小比例
                    const thumbnail = document.createElement('canvas');
                    const thumbCtx = thumbnail.getContext('2d');
                    thumbnail.width = canvas.width * scaleFactor;
                    thumbnail.height = canvas.height * scaleFactor;
                    thumbCtx.drawImage(canvas, 0, 0, thumbnail.width, thumbnail.height);
                    
                    // 计算文件大小（估计值）
                    const imgData = canvas.toDataURL('image/png');
                    const imgSize = Math.round((imgData.length * 3/4) / 1024); // 估计KB大小
                    
                    // 获取设备像素比
                    const devicePixelRatio = window.devicePixelRatio || 1;
                    
                    resultDialog.innerHTML = `
                        <h3 style="color: #FF6B00; margin-top: 0; display: flex; justify-content: space-between; align-items: center;">
                            <span>截图已完成</span>
                            <button id="close-screenshot-dialog" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #777;">&times;</button>
                        </h3>
                        <div style="display: flex; margin: 20px 0;">
                            <div style="flex: 1; max-height: 300px; overflow-y: auto; border: 1px solid #eee; position: relative;">
                                <div style="width: ${thumbnail.width}px; margin: 0 auto;">
                                    <img src="${thumbnail.toDataURL('image/png')}" alt="截图预览" style="width: 100%; height: auto; display: block;">
                                </div>
                            </div>
                            <div style="flex: 1; padding-left: 20px;">
                                <p><strong>尺寸:</strong> ${Math.round(canvas.width/devicePixelRatio)}×${Math.round(canvas.height/devicePixelRatio)}px</p>
                                <p><strong>大小:</strong> 约 ${imgSize} KB</p>
                                <p><strong>格式:</strong> PNG</p>
                                <p style="margin-top: 20px; color: #777; font-size: 13px;">点击下方按钮保存截图</p>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                            <button id="save-screenshot-png" style="background-color: #FF6B00; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1; margin-right: 10px;">
                                <i class='bx bx-download' style="margin-right: 5px;"></i> 保存为PNG
                            </button>
                            <button id="save-screenshot-pdf" style="background-color: #0084FF; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1; margin-left: 10px;">
                                <i class='bx bxs-file-pdf' style="margin-right: 5px;"></i> 保存为PDF
                            </button>
                        </div>
                    `;
                    
                    document.body.appendChild(resultDialog);
                    
                    // 添加关闭按钮事件
                    document.getElementById('close-screenshot-dialog').addEventListener('click', function() {
                        document.body.removeChild(resultDialog);
                        
                        // 重置为原始显示状态
                        dayContents.forEach(function(content) {
                            content.classList.remove('active');
                        });
                        
                        // 恢复之前活跃的标签页
                        activeContents.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.classList.add('active');
                        });
                        
                        activeTabs.forEach(id => {
                            if (!id) return;
                            const selector = `[data-day="${id}"], [data-food-day="${id}"]`;
                            const el = document.querySelector(selector);
                            if (el) el.classList.add('active');
                        });
                        
                        // 恢复显示导出工具
                        exportTool.style.display = 'block';
                        exportToolButton.style.display = 'block';
                        
                        showExportLoading(false);
                    });
                    
                    // 添加保存PNG按钮事件
                    document.getElementById('save-screenshot-png').addEventListener('click', function() {
                        try {
                            // 创建下载链接
                            const downloadLink = document.createElement('a');
                            downloadLink.href = canvas.toDataURL('image/png');
                            downloadLink.download = '厦门旅游指南_' + new Date().toISOString().replace(/[:.]/g, '-') + '.png';
                            downloadLink.click();
                            
                            // 显示成功消息
                            const successMsg = document.createElement('div');
                            successMsg.style.position = 'absolute';
                            successMsg.style.bottom = '10px';
                            successMsg.style.left = '50%';
                            successMsg.style.transform = 'translateX(-50%)';
                            successMsg.style.backgroundColor = '#4CAF50';
                            successMsg.style.color = 'white';
                            successMsg.style.padding = '10px 20px';
                            successMsg.style.borderRadius = '5px';
                            successMsg.style.zIndex = '10001';
                            successMsg.textContent = '截图已保存为PNG格式';
                            resultDialog.appendChild(successMsg);
                            
                            setTimeout(() => {
                                if (successMsg.parentNode) {
                                    successMsg.parentNode.removeChild(successMsg);
                                }
                            }, 3000);
                        } catch (err) {
                            console.error('保存PNG失败:', err);
                            alert('保存PNG失败，请查看控制台获取详细错误信息。');
                        }
                    });
                    
                    // 添加保存PDF按钮事件 - 使用jsPDF
                    document.getElementById('save-screenshot-pdf').addEventListener('click', async function() {
                        try {
                            // 动态加载jsPDF库
                            if (!window.jspdf) {
                                const jsPdfScript = document.createElement('script');
                                jsPdfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                                document.head.appendChild(jsPdfScript);
                                
                                await new Promise((resolve, reject) => {
                                    jsPdfScript.onload = resolve;
                                    jsPdfScript.onerror = reject;
                                });
                            }
                            
                            // 创建PDF
                            const { jsPDF } = window.jspdf;
                            const imgData = canvas.toDataURL('image/png');
                            
                            // 确定PDF大小 (A4: 210x297mm)
                            const pdf = new jsPDF({
                                orientation: canvas.height > canvas.width ? 'portrait' : 'landscape',
                                unit: 'mm',
                                format: 'a4'
                            });
                            
                            // 页面尺寸 (mm)
                            const pageWidth = pdf.internal.pageSize.getWidth();
                            const pageHeight = pdf.internal.pageSize.getHeight();
                            
                            // 图像比例 - 使用devicePixelRatio
                            const devicePixelRatio = window.devicePixelRatio || 1;
                            const imgWidth = canvas.width / devicePixelRatio;
                            const imgHeight = canvas.height / devicePixelRatio;
                            const ratio = Math.min(pageWidth / imgWidth, pageHeight / imgHeight);
                            
                            // 如果图像太大，需要分页
                            if (imgHeight * ratio > pageHeight) {
                                // 计算需要的页数
                                const pagesCount = Math.ceil(imgHeight * ratio / pageHeight);
                                
                                // 在每页中添加图像的一部分
                                for (let i = 0; i < pagesCount; i++) {
                                    if (i > 0) {
                                        pdf.addPage();
                                    }
                                    
                                    const sourceY = i * pageHeight / ratio;
                                    const sourceHeight = Math.min(pageHeight / ratio, imgHeight - sourceY);
                                    
                                    pdf.addImage(
                                        imgData, 
                                        'PNG', 
                                        0, 0, // 目标位置
                                        imgWidth * ratio, sourceHeight * ratio, // 目标尺寸
                                        0, sourceY, // 源位置
                                        imgWidth, sourceHeight // 源尺寸
                                    );
                                    
                                    // 添加页脚
                                    pdf.setFontSize(8);
                                    pdf.setTextColor(150);
                                    pdf.text(`厦门旅游指南 - 第 ${i + 1} 页，共 ${pagesCount} 页`, pageWidth / 2, pageHeight - 5, { align: 'center' });
                                }
                            } else {
                                // 单页添加图像
                                const yPos = (pageHeight - imgHeight * ratio) / 2;
                                pdf.addImage(imgData, 'PNG', 0, yPos, imgWidth * ratio, imgHeight * ratio);
                            }
                            
                            // 保存PDF
                            pdf.save('厦门旅游指南_' + new Date().toISOString().replace(/[:.]/g, '-') + '.pdf');
                            
                            // 显示成功消息
                            const successMsg = document.createElement('div');
                            successMsg.style.position = 'absolute';
                            successMsg.style.bottom = '10px';
                            successMsg.style.left = '50%';
                            successMsg.style.transform = 'translateX(-50%)';
                            successMsg.style.backgroundColor = '#4CAF50';
                            successMsg.style.color = 'white';
                            successMsg.style.padding = '10px 20px';
                            successMsg.style.borderRadius = '5px';
                            successMsg.style.zIndex = '10001';
                            successMsg.textContent = '截图已保存为PDF格式';
                            resultDialog.appendChild(successMsg);
                            
                            setTimeout(() => {
                                if (successMsg.parentNode) {
                                    successMsg.parentNode.removeChild(successMsg);
                                }
                            }, 3000);
                        } catch (err) {
                            console.error('保存PDF失败:', err);
                            alert('保存PDF失败，请查看控制台获取详细错误信息。');
                        }
                    });
                    
                    showExportLoading(false);
                    showExportStatus('截图生成完成！', 'success');
                } catch (err) {
                    console.error('截图失败:', err);
                    
                    // 移除状态对话框
                    if (document.contains(statusDialog)) {
                        document.body.removeChild(statusDialog);
                    }
                    
                    // 恢复所有原始元素状态
                    // 恢复图片
                    originalStates.images.forEach((state, img) => {
                        if (img && state.src) {
                            img.src = state.src;
                            if (state.width) img.width = state.width;
                            if (state.height) img.height = state.height;
                        }
                    });
                    
                    // 恢复背景图片
                    originalStates.backgroundElements.forEach((state, el) => {
                        if (el && state.cssText) {
                            el.style.cssText = state.cssText;
                        }
                    });
                    
                    // 恢复iframe
                    originalStates.iframes.forEach((state, iframe) => {
                        if (iframe && state.src) {
                            iframe.src = state.src;
                            if (state.srcdoc) iframe.srcdoc = state.srcdoc;
                        }
                    });
                    
                    // 恢复canvas
                    originalStates.canvases.forEach((state, canvas) => {
                        if (canvas && state.dataUrl) {
                            try {
                                const img = new Image();
                                img.onload = () => {
                                    const ctx = canvas.getContext('2d');
                                    if (ctx) {
                                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                                        ctx.drawImage(img, 0, 0);
                                    }
                                };
                                img.src = state.dataUrl;
                            } catch (e) {
                                console.warn('恢复canvas失败:', e);
                            }
                        }
                    });
                    
                    // 重置为原始显示状态
                    dayContents.forEach(function(content) {
                        content.classList.remove('active');
                    });
                    
                    // 恢复之前活跃的标签页
                    activeContents.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.classList.add('active');
                    });
                    
                    activeTabs.forEach(id => {
                        if (!id) return;
                        const selector = `[data-day="${id}"], [data-food-day="${id}"]`;
                        const el = document.querySelector(selector);
                        if (el) el.classList.add('active');
                    });
                    
                    // 恢复显示导出工具
                    exportTool.style.display = 'block';
                    exportToolButton.style.display = 'block';
                    
                    showExportLoading(false);
                    showExportStatus('截图失败，请尝试使用打印功能导出为PDF。', 'error');
                    
                    // 显示备用方案
                    showPrintAlternative();
                }
                            } catch (err) {
                    console.error('准备截图失败:', err);
                    showExportLoading(false);
                    showExportStatus('准备截图失败，请尝试使用打印功能。', 'error');
                    
                    // 恢复所有原始元素状态
                    if (originalStates) {
                        // 恢复图片
                        if (originalStates.images) {
                            originalStates.images.forEach((state, img) => {
                                if (img && state.src) {
                                    img.src = state.src;
                                    if (state.width) img.width = state.width;
                                    if (state.height) img.height = state.height;
                                }
                            });
                        }
                        
                        // 恢复背景图片
                        if (originalStates.backgroundElements) {
                            originalStates.backgroundElements.forEach((state, el) => {
                                if (el && state.cssText) {
                                    el.style.cssText = state.cssText;
                                }
                            });
                        }
                        
                        // 恢复iframe
                        if (originalStates.iframes) {
                            originalStates.iframes.forEach((state, iframe) => {
                                if (iframe && state.src) {
                                    iframe.src = state.src;
                                    if (state.srcdoc) iframe.srcdoc = state.srcdoc;
                                }
                            });
                        }
                        
                        // 恢复canvas
                        if (originalStates.canvases) {
                            originalStates.canvases.forEach((state, canvas) => {
                                if (canvas && state.dataUrl) {
                                    try {
                                        const img = new Image();
                                        img.onload = () => {
                                            const ctx = canvas.getContext('2d');
                                            if (ctx) {
                                                ctx.clearRect(0, 0, canvas.width, canvas.height);
                                                ctx.drawImage(img, 0, 0);
                                            }
                                        };
                                        img.src = state.dataUrl;
                                    } catch (e) {
                                        console.warn('恢复canvas失败:', e);
                                    }
                                }
                            });
                        }
                    }
                    
                    // 恢复显示导出工具
                const exportTool = document.getElementById('export-tool');
                const exportToolButton = document.getElementById('show-export-tool');
                if (exportTool) exportTool.style.display = 'block';
                if (exportToolButton) exportToolButton.style.display = 'block';
                
                // 显示备用方案
                showPrintAlternative();
            }
        }
        
        // 导出所有标签页处理函数
        async function handleCaptureAllTabsClick() {
            showExportLoading(true);
            showExportStatus('正在准备全部内容PDF导出，请稍候...', 'info');
            
            try {
                // 暂时隐藏导出工具
                const exportTool = document.getElementById('export-tool');
                const exportToolButton = document.getElementById('show-export-tool');
                exportTool.style.display = 'none';
                exportToolButton.style.display = 'none';
                
                // 获取所有标签页内容元素
                const dayContents = document.querySelectorAll('.day-content');
                
                // 备份当前激活状态
                const activeContents = Array.from(document.querySelectorAll('.day-content.active')).map(el => el.id);
                const activeTabs = Array.from(document.querySelectorAll('.tab-item.active')).map(el => {
                    return el.getAttribute('data-day') || el.getAttribute('data-food-day');
                });
                
                // 使所有内容可见以便打印
                dayContents.forEach(function(content) {
                    content.classList.add('active');
                });
                
                // 添加临时打印样式
                const printStyle = document.createElement('style');
                printStyle.id = 'temp-print-style';
                printStyle.textContent = `
                    @media print {
                        body * {
                            visibility: visible !important;
                            display: block !important;
                        }
                        .day-content {
                            display: block !important;
                            opacity: 1 !important;
                            height: auto !important;
                            overflow: visible !important;
                            margin-bottom: 30px !important;
                            page-break-after: always;
                        }
                        #export-tool, #show-export-tool, .api-notice, #map-loading, .search-container, .search-filter-btn, .search-reset-btn {
                            display: none !important;
                        }
                        .tab-item {
                            border-bottom: none !important;
                            color: #333 !important;
                            font-weight: normal !important;
                        }
                        .tab-item.active {
                            color: #FF6B00 !important;
                            font-weight: bold !important;
                        }
                        @page {
                            size: A4;
                            margin: 1cm;
                        }
                        .day-content::before {
                            font-weight: bold;
                            font-size: 20px;
                            margin-bottom: 15px;
                            display: block;
                            border-bottom: 2px solid #FF6B00;
                            padding-bottom: 10px;
                            color: #FF6B00;
                        }
                        #day1::before { content: "第一天行程"; }
                        #day2::before { content: "第二天行程"; }
                        #day3::before { content: "第三天行程"; }
                        #food1::before { content: "第一天美食"; }
                        #food2::before { content: "第二天美食"; }
                        #food3::before { content: "第三天美食"; }
                    }
                `;
                document.head.appendChild(printStyle);
                
                // 显示替代解决方案的说明
                const alternativeSolution = document.createElement('div');
                alternativeSolution.style.position = 'fixed';
                alternativeSolution.style.top = '50%';
                alternativeSolution.style.left = '50%';
                alternativeSolution.style.transform = 'translate(-50%, -50%)';
                alternativeSolution.style.backgroundColor = 'white';
                alternativeSolution.style.padding = '20px';
                alternativeSolution.style.borderRadius = '10px';
                alternativeSolution.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
                alternativeSolution.style.zIndex = '10000';
                alternativeSolution.style.maxWidth = '600px';
                alternativeSolution.style.width = '90%';
                alternativeSolution.innerHTML = `
                    <h3 style="color: #FF6B00; margin-top: 0;">完整行程PDF导出指南</h3>
                    <p>我们将为您生成一份包含所有行程和美食内容的PDF文档：</p>
                    <ol>
                        <li>点击下方按钮，将打开浏览器的打印对话框</li>
                        <li>在打印对话框中，选择"保存为PDF"选项（而不是实际打印）</li>
                        <li>确保选择"背景图形"选项以保留所有图片和颜色</li>
                        <li>内容已优化为每个行程部分自动分页，便于阅读</li>
                        <li>点击"保存"，选择保存位置</li>
                    </ol>
                    <p>这样您将获得一份精美的、完整的厦门旅游指南PDF，方便随时查阅。</p>
                    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                        <button id="proceed-to-print-all" style="background-color: #FF6B00; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1; margin-right: 10px;">继续导出PDF</button>
                        <button id="cancel-print-all" style="background-color: #999; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1; margin-left: 10px;">取消</button>
                    </div>
                `;
                document.body.appendChild(alternativeSolution);
                
                // 添加按钮事件监听器
                document.getElementById('proceed-to-print-all').addEventListener('click', function() {
                    // 移除提示框
                    document.body.removeChild(alternativeSolution);
                    
                    // 打印
                    window.print();
                    
                    // 恢复原始状态
                    document.head.removeChild(printStyle);
                    
                    // 重置为原始显示状态
                    dayContents.forEach(function(content) {
                        content.classList.remove('active');
                    });
                    
                    // 恢复之前活跃的标签页
                    activeContents.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.classList.add('active');
                    });
                    
                    activeTabs.forEach(id => {
                        if (!id) return;
                        const selector = `[data-day="${id}"], [data-food-day="${id}"]`;
                        const el = document.querySelector(selector);
                        if (el) el.classList.add('active');
                    });
                    
                    // 恢复显示导出工具
                    exportTool.style.display = 'block';
                    exportToolButton.style.display = 'block';
                    
                    showExportLoading(false);
                    showExportStatus('PDF导出完成！', 'success');
                });
                
                document.getElementById('cancel-print-all').addEventListener('click', function() {
                    // 移除提示框
                    document.body.removeChild(alternativeSolution);
                    
                    // 移除临时样式
                    if (document.getElementById('temp-print-style')) {
                        document.head.removeChild(printStyle);
                    }
                    
                    // 重置为原始显示状态
                    dayContents.forEach(function(content) {
                        content.classList.remove('active');
                    });
                    
                    // 恢复之前活跃的标签页
                    activeContents.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.classList.add('active');
                    });
                    
                    activeTabs.forEach(id => {
                        if (!id) return;
                        const selector = `[data-day="${id}"], [data-food-day="${id}"]`;
                        const el = document.querySelector(selector);
                        if (el) el.classList.add('active');
                    });
                    
                    // 恢复显示导出工具
                    exportTool.style.display = 'block';
                    exportToolButton.style.display = 'block';
                    
                    showExportLoading(false);
                    showExportStatus('已取消PDF导出', 'info');
                });
            } catch (err) {
                console.error('准备导出PDF失败:', err);
                showExportLoading(false);
                showExportStatus('准备导出PDF失败，请查看控制台获取详细错误信息。', 'error');
                
                // 恢复显示导出工具
                const exportTool = document.getElementById('export-tool');
                const exportToolButton = document.getElementById('show-export-tool');
                if (exportTool) exportTool.style.display = 'block';
                if (exportToolButton) exportToolButton.style.display = 'block';
            }
        }
    </script>
    
    <!-- 导出工具 -->
    <div id="export-tool" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; overflow-y: auto;">
        <div style="max-width: 800px; margin: 20px auto; background: white; border-radius: 10px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #FF6B00; margin: 0;">厦门旅游指南导出工具</h2>
                <button id="close-export-tool" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <div id="export-status" style="padding: 10px; margin: 10px 0; border-radius: 5px; display: none;"></div>
            
            <div style="margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                <h3 style="color: #0084FF; margin-bottom: 15px;">1. 控制内容显示</h3>
                <div style="background-color: #fff8e1; padding: 15px; border-left: 4px solid #FFB800; margin: 20px 0; border-radius: 0 5px 5px 0;">
                    <p>使用下面的按钮控制旅游指南页面中显示的内容。您可以显示特定天数的行程或美食，或显示所有内容。</p>
                </div>
                
                <button id="show-all-btn" style="background-color: #FF6B00; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 0; display: block; width: 100%;">显示所有标签页内容</button>
                <button id="reset-btn" style="background-color: #999; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 0; display: block; width: 100%;">恢复默认显示</button>
                
                <h4 style="margin-top: 20px;">行程内容控制</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;">
                    <button id="day1-btn" style="flex: 1; background-color: #0084FF; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; min-width: 120px;">第一天行程</button>
                    <button id="day2-btn" style="flex: 1; background-color: #0084FF; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; min-width: 120px;">第二天行程</button>
                    <button id="day3-btn" style="flex: 1; background-color: #0084FF; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; min-width: 120px;">第三天行程</button>
                </div>
                
                <h4 style="margin-top: 20px;">美食内容控制</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;">
                    <button id="food1-btn" style="flex: 1; background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; min-width: 120px;">第一天美食</button>
                    <button id="food2-btn" style="flex: 1; background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; min-width: 120px;">第二天美食</button>
                    <button id="food3-btn" style="flex: 1; background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; min-width: 120px;">第三天美食</button>
                </div>
            </div>
            
            <div>
                <h3 style="color: #0084FF; margin-bottom: 15px;">2. 导出内容</h3>
                <div style="background-color: #fff8e1; padding: 15px; border-left: 4px solid #FFB800; margin: 20px 0; border-radius: 0 5px 5px 0;">
                    <p>点击下方按钮可查看全文内容，便于使用FireShot进行全文截屏：</p>
                </div>
                
                <button id="show-all-btn" style="background-color: #0084FF; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 0; display: block; width: 100%;">显示全文内容</button>
                
                <div id="export-loading" style="display: none; text-align: center; padding: 20px;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(255, 107, 0, 0.3); border-radius: 50%; border-top-color: #FF6B00; animation: spin 1s ease-in-out infinite;"></div>
                    <p>正在处理，请稍候...</p>
                </div>
                
                <div id="export-result" style="margin-top: 20px; display: none;">
                    <h3>导出结果：</h3>
                    <div id="export-download-links"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 导出工具按钮 -->
    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 9998;">
        <button id="show-export-tool" style="background-color: #FF6B00; color: white; border: none; width: 60px; height: 60px; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.3); font-size: 24px;">
            <i class='bx bx-export'></i>
        </button>
    </div>
    
    <!-- 导出工具脚本 -->
    <script>
        // 等待DOM完全加载后再初始化导出工具
        document.addEventListener('DOMContentLoaded', function() {
            // 防止重复初始化
            if (!window.exportToolInitialized) {
                window.exportToolInitialized = true;
                initExportTool();
                
                // 初始化导出按钮的事件监听器
                initExportButtonListeners();
            }
        });
        
        // 初始化导出工具
        function initExportTool() {
            // 检查必要的元素是否存在
            const showExportToolBtn = document.getElementById('show-export-tool');
            const closeExportToolBtn = document.getElementById('close-export-tool');
            const showAllBtn = document.getElementById('show-all-btn');
            const resetBtn = document.getElementById('reset-btn');
            const day1Btn = document.getElementById('day1-btn');
            const day2Btn = document.getElementById('day2-btn');
            const day3Btn = document.getElementById('day3-btn');
            const food1Btn = document.getElementById('food1-btn');
            const food2Btn = document.getElementById('food2-btn');
            const food3Btn = document.getElementById('food3-btn');
            
            // 确保所有必要元素都存在
            if (!showExportToolBtn || !closeExportToolBtn || !showAllBtn || !resetBtn || 
                !day1Btn || !day2Btn || !day3Btn || !food1Btn || !food2Btn || !food3Btn) {
                console.error('导出工具初始化失败：无法找到必要的DOM元素');
                return;
            }
            
            // 显示/隐藏导出工具
            showExportToolBtn.addEventListener('click', function() {
                document.getElementById('export-tool').style.display = 'block';
            });
            
            closeExportToolBtn.addEventListener('click', function() {
                document.getElementById('export-tool').style.display = 'none';
            });
            
            // 显示所有标签页内容
            showAllBtn.addEventListener('click', function() {
                try {
                    // 获取所有标签页内容元素
                    const dayContents = document.querySelectorAll('.day-content');
                    
                    // 使所有内容可见
                    dayContents.forEach(function(content) {
                        content.classList.add('active');
                    });
                    
                    showExportStatus('所有标签页内容已显示，现在可以截图或打印页面了！', 'success');
                } catch (err) {
                    console.error('显示所有标签页内容失败:', err);
                    showExportStatus('显示所有标签页内容失败，请查看控制台获取详细错误信息。', 'error');
                }
            });
            
            // 恢复默认显示
            resetBtn.addEventListener('click', function() {
                try {
                    // 获取所有标签页和内容元素
                    const dayTabs = document.querySelectorAll('.tab-item');
                    const dayContents = document.querySelectorAll('.day-content');
                    
                    // 移除所有活动状态
                    dayTabs.forEach(function(tab) {
                        tab.classList.remove('active');
                    });
                    
                    dayContents.forEach(function(content) {
                        content.classList.remove('active');
                    });
                    
                    // 设置第一个标签页为活动状态
                    const firstDayTab = document.querySelector('.tab-item[data-day="day1"]');
                    const firstFoodTab = document.querySelector('.tab-item[data-food-day="food1"]');
                    const firstDayContent = document.getElementById('day1');
                    const firstFoodContent = document.getElementById('food1');
                    
                    if (firstDayTab) firstDayTab.classList.add('active');
                    if (firstFoodTab) firstFoodTab.classList.add('active');
                    if (firstDayContent) firstDayContent.classList.add('active');
                    if (firstFoodContent) firstFoodContent.classList.add('active');
                    
                    showExportStatus('已恢复默认显示状态！', 'success');
                } catch (err) {
                    console.error('恢复默认显示失败:', err);
                    showExportStatus('恢复默认显示失败，请查看控制台获取详细错误信息。', 'error');
                }
            });
            
            // 绑定行程按钮事件
            day1Btn.addEventListener('click', function() {
                showSpecificDay('day1');
            });
            
            day2Btn.addEventListener('click', function() {
                showSpecificDay('day2');
            });
            
            day3Btn.addEventListener('click', function() {
                showSpecificDay('day3');
            });
            
            // 绑定美食按钮事件
            food1Btn.addEventListener('click', function() {
                showSpecificFood('food1');
            });
            
            food2Btn.addEventListener('click', function() {
                showSpecificFood('food2');
            });
            
            food3Btn.addEventListener('click', function() {
                showSpecificFood('food3');
            });
            
            // 删除不需要的导出功能监听器
        }
        
        // 显示状态信息
        function showExportStatus(message, type = 'info') {
            const statusEl = document.getElementById('export-status');
            if (!statusEl) return;
            
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            // 设置不同类型的样式
            if (type === 'success') {
                statusEl.style.backgroundColor = '#e8f5e9';
                statusEl.style.color = '#2e7d32';
                statusEl.style.borderLeft = '4px solid #2e7d32';
            } else if (type === 'error') {
                statusEl.style.backgroundColor = '#ffebee';
                statusEl.style.color = '#c62828';
                statusEl.style.borderLeft = '4px solid #c62828';
            } else {
                statusEl.style.backgroundColor = '#e3f2fd';
                statusEl.style.color = '#1565c0';
                statusEl.style.borderLeft = '4px solid #1565c0';
            }
            
            // 5秒后自动隐藏
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
        
        // 显示加载中
        function showExportLoading(show = true) {
            const loadingEl = document.getElementById('export-loading');
            if (!loadingEl) return;
            loadingEl.style.display = show ? 'block' : 'none';
        }
        
        // 显示特定天的行程
        function showSpecificDay(dayId) {
            try {
                // 获取所有行程标签页和内容
                const dayTabs = document.querySelectorAll('.tab-item[data-day]');
                const dayContents = document.querySelectorAll('.itinerary .day-content');
                
                // 移除所有活动状态
                dayTabs.forEach(function(tab) {
                    tab.classList.remove('active');
                });
                
                dayContents.forEach(function(content) {
                    content.classList.remove('active');
                });
                
                // 设置指定标签页为活动状态
                const targetTab = document.querySelector(`.tab-item[data-day="${dayId}"]`);
                const targetContent = document.getElementById(dayId);
                
                if (targetTab) targetTab.classList.add('active');
                if (targetContent) targetContent.classList.add('active');
                
                // 滚动到行程部分
                const itinerary = document.querySelector('.itinerary');
                if (itinerary) {
                    itinerary.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
                
                showExportStatus(`已显示${targetTab ? targetTab.textContent : ''}行程内容`, 'success');
            } catch (err) {
                console.error('显示特定天行程失败:', err);
                showExportStatus('显示特定天行程失败，请查看控制台获取详细错误信息。', 'error');
            }
        }
        
        // 显示特定天的美食
        function showSpecificFood(foodId) {
            try {
                // 获取所有美食标签页和内容
                const foodTabs = document.querySelectorAll('.tab-item[data-food-day]');
                const foodContents = document.querySelectorAll('.food-card .day-content');
                
                // 移除所有活动状态
                foodTabs.forEach(function(tab) {
                    tab.classList.remove('active');
                });
                
                foodContents.forEach(function(content) {
                    content.classList.remove('active');
                });
                
                // 设置指定标签页为活动状态
                const targetTab = document.querySelector(`.tab-item[data-food-day="${foodId}"]`);
                const targetContent = document.getElementById(foodId);
                
                if (targetTab) targetTab.classList.add('active');
                if (targetContent) targetContent.classList.add('active');
                
                // 滚动到美食部分
                const foodCard = document.querySelector('.food-card');
                if (foodCard) {
                    foodCard.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
                
                showExportStatus(`已显示${targetTab ? targetTab.textContent : ''}美食内容`, 'success');
            } catch (err) {
                console.error('显示特定天美食失败:', err);
                showExportStatus('显示特定天美食失败，请查看控制台获取详细错误信息。', 'error');
            }
        }

        // 加载html2canvas库
        function loadHtml2Canvas() {
            return new Promise((resolve, reject) => {
                if (window.html2canvas) {
                    resolve(window.html2canvas);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
                script.onload = () => resolve(window.html2canvas);
                script.onerror = () => reject(new Error('Failed to load html2canvas'));
                document.head.appendChild(script);
            });
        }
        
        // 逐个处理标签页
        async function processNextTab(tabs, index, originalActiveItems, originalActiveContents, html2canvas) {
            if (index >= tabs.length) {
                // 恢复原始活动标签
                originalActiveItems.forEach(item => item.classList.add('active'));
                originalActiveContents.forEach(content => content.classList.add('active'));
                
                showExportLoading(false);
                showExportStatus('所有标签页内容导出完成！', 'success');
                return;
            }
            
            const currentTab = tabs[index];
            const tabName = currentTab.textContent.trim();
            
            // 移除所有活动状态
            document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.day-content').forEach(content => content.classList.remove('active'));
            
            // 激活当前标签
            currentTab.classList.add('active');
            
            // 获取关联的内容ID
            const dayId = currentTab.getAttribute('data-day');
            const foodDayId = currentTab.getAttribute('data-food-day');
            const contentId = dayId || foodDayId;
            
            if (contentId) {
                const content = document.getElementById(contentId);
                if (content) {
                    content.classList.add('active');
                }
            }
            
            // 延迟执行以确保DOM更新
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 确定要截图的元素
            let targetElement;
            if (dayId) {
                targetElement = document.querySelector('.itinerary');
            } else if (foodDayId) {
                targetElement = document.querySelector('.food-card');
            } else {
                // 如果无法确定元素，跳到下一个
                await processNextTab(tabs, index + 1, originalActiveItems, originalActiveContents, html2canvas);
                return;
            }
            
            try {
                // 处理本地图片跨域问题
                const images = targetElement.querySelectorAll('img');
                const originalSrcs = [];
                
                // 备份原始图片路径并替换为占位符
                for (let i = 0; i < images.length; i++) {
                    originalSrcs.push(images[i].src);
                    if (images[i].src.startsWith('file://') || images[i].src.includes('image/')) {
                        // 替换为占位图片
                        images[i].setAttribute('data-original-src', images[i].src);
                        images[i].src = 'data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22' + 
                                      (images[i].width || 300) + '%22%20height%3D%22' + (images[i].height || 200) + 
                                      '%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23f5f5f5%22%2F%3E%3Ctext%20x%3D%2250%25%22%20' + 
                                      'y%3D%2250%25%22%20dominant-baseline%3D%22middle%22%20text-anchor%3D%22middle%22%20font-family%3D%22Arial%22%20font-size%3D%2214%22%20fill%3D%22%23999%22%3E' + 
                                      images[i].alt + '%3C%2Ftext%3E%3C%2Fsvg%3E';
                    }
                }
                
                // 捕获当前标签页内容
                const canvas = await html2canvas(targetElement, {
                    allowTaint: false,
                    useCORS: true,
                    scale: 1,
                    logging: true,
                    backgroundColor: '#ffffff',
                    foreignObjectRendering: false,
                    removeContainer: true
                });
                
                // 恢复原始图片路径
                for (let i = 0; i < images.length; i++) {
                    if (images[i].hasAttribute('data-original-src')) {
                        images[i].src = images[i].getAttribute('data-original-src');
                        images[i].removeAttribute('data-original-src');
                    }
                }
                
                try {
                    // 创建下载链接
                    const downloadLink = document.createElement('a');
                    downloadLink.href = canvas.toDataURL('image/png');
                    downloadLink.download = `厦门旅游指南_${tabName}.png`;
                    downloadLink.textContent = `下载${tabName}内容截图`;
                    downloadLink.style.display = 'block';
                    downloadLink.style.margin = '10px 0';
                    downloadLink.style.padding = '8px';
                    downloadLink.style.backgroundColor = '#0084FF';
                    downloadLink.style.color = 'white';
                    downloadLink.style.textDecoration = 'none';
                    downloadLink.style.borderRadius = '5px';
                    downloadLink.style.textAlign = 'center';
                    
                    // 添加到下载区域
                    const downloadLinks = document.getElementById('export-download-links');
                    if (downloadLinks) {
                        downloadLinks.appendChild(downloadLink);
                    }
                } catch (err) {
                    console.error(`${tabName}截图生成成功，但无法创建下载链接:`, err);
                    
                    // 显示截图结果
                    const imgContainer = document.createElement('div');
                    imgContainer.style.maxWidth = '100%';
                    imgContainer.style.overflow = 'auto';
                    imgContainer.style.border = '1px solid #ddd';
                    imgContainer.style.padding = '10px';
                    imgContainer.style.marginTop = '10px';
                    imgContainer.appendChild(canvas);
                    
                    const downloadLinks = document.getElementById('export-download-links');
                    if (downloadLinks) {
                        downloadLinks.appendChild(document.createTextNode(`${tabName}内容截图（右键点击并选择"图片另存为"保存）：`));
                        downloadLinks.appendChild(imgContainer);
                    }
                }
            } catch (err) {
                console.error(`${tabName}截图失败:`, err);
                
                // 恢复原始图片路径
                const images = targetElement.querySelectorAll('img');
                for (let i = 0; i < images.length; i++) {
                    if (images[i].hasAttribute('data-original-src')) {
                        images[i].src = images[i].getAttribute('data-original-src');
                        images[i].removeAttribute('data-original-src');
                    }
                }
            }
            
            // 处理下一个标签页
            await processNextTab(tabs, index + 1, originalActiveItems, originalActiveContents, html2canvas);
        }
        
        // 添加CSS动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html> 